---
title: "INTERNATIONAL ARMS TRADE NETWORKS: VISUALISATION"
author: "QN Nguyen"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    highlight-style: tango
    toc: true
    toc-depth: 2
    toc-float: true
editor: 
  markdown: 
    wrap: 72
---

# SETTINGS

```{r}
knitr::opts_chunk$set(
  fig.width = 12,
  fig.height = 10,
  fig.path = "Figs/",
  fig.align = "center",
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  eval = TRUE,
  include = TRUE
)

options(
  xtable.comment = FALSE,
  scipen = 9999,
  tinytex.verbose = TRUE
)
```


# PACKAGES

Staples
```{r}
# knitr::opts_chunk$set(fig.path = "charts/")

### BASIC TOOLS
pacman::p_load(devtools, dplyr, tidyr, sjmisc, texreg, effectsize, reshape, purrr, stringr, forcats, countrycode, tidytext, scales, magrittr) # foreign, graphics, utils, qgraph, ggcorrplot, psych, stats, haven, vtable, summarytools, rvest, Hmisc, 

### SNA TOOLS
pacman::p_load(network, igraph, statnet, intergraph, sna, tsna, ergm, btergm, networkDynamic) # qgraph, tidygraph, htmlwidgets, speedglm, latticeExtra, statnet.common, tergm, ndtv, ndtv,poweRlaw, PRROC


### VISUALIZATION
pacman::p_load(ggplot2, ggthemes, RColorBrewer, gt, stargazer, kableExtra, ggflags, ggraph, cowplot, sysfonts,showtextdb,showtext) # visNetwork, ggthemr, ggflags, ggimage, bbplot, urbnthemes, ggtech,wesanderson


# devtools::install_github('Mikata-Project/ggthemr')
# devtools::install_github('bbc/bbplot')
# remotes::install_github("UrbanInstitute/urbnthemes", build_vignettes = TRUE)
# install.packages("ggflags", repos = c(
#   "https://jimjam-slam.r-universe.dev",
#   "https://cloud.r-project.org"))

### SEP
# library(igraph)
# detach("package:igraph", unload = FALSE)
# library(sna)
# library(statnet)
# detach("package:statnet", unload = FALSE)

### WD
# setwd('G:/My Drive/1. Uni/Hausarbeiten 2023/SNA_weapons/SNA_weapons_analysis')

### CLEAN UP ENVIRONMENT
# rm(list= ls())

### CLEAN SELECTIVELY
# all <- ls()
# keep <- c("cov_clean", "alliance_snet", "conflict_snet", "iat_snet", "m1", "m0", "m2", "m3", "m4", "stergm_0", "stergm_0_t123", "tergm_stats", "tergm_stats2")
# rm(list = setdiff(all, keep))

### CHECK PCK VERSIONS
# sessionInfo()

### UPDATE BTERGM PACK
# packageVersion("btergm") # 1.10.11
# install.packages("btergm")
```

For plots
```{r}
library(ggplot2)
library(ggthemes)
library(ggraph)
library(ggimage)
library(ggthemr)
library(ggflags)
library(ggtech)

# library(bbplot)
# library(urbnthemes)
library(forcats)
library(countrycode)
library(tidytext) # for reorder_within
library(showtext)
library(cowplot)
library(stringi)
library(stargazer)
library(gridExtra)
library(reshape2)
library(scales)
```




# 0) DATA PREP & PLOT SETTINGS

## 0.1 Import

### Main
```{r}
### CLEAN COV DF
  # load("cov_agg.RData") # all node attributes
  # load("cov_list.RData") # same but as list, divided by t
  # load("cov_complete_list.RData") # in network order, same as cov_list
  # load("un_members.RData")
  load("5_objects/cov_complete.RData") # cov_agg inc. descriptive network stats
  load("5_objects/cov_complete_list.RData") # cov_list inc. descriptive network stats (157 countries x 6 time spells = 942 observations X 67 variables)

### COLLAPSED NETWORK 1993-2023
# load("5_objects/cent9323.RData")
load("5_objects/iat9323.RData")
load("5_objects/iat_adj.9323.RData")
  
### IGRAPH NETWORKS
load("4_objects/iat_inet.RData")
# load("conflict_inet.RData")
# load("alliance_inet.RData")

### STATNET NETWORKS
# load("4_objects/iat_snet.RData")
# load("conflict_snet.RData")
# load("alliance_snet.RData")

### DYNAMIC NETWORKS
load("4_objects/iat_dyn.RData")
# load("conflict_dyn.RData")
# load("alliance_dyn.RData")

### IAT WITHOUT ISOLATES
load("4_objects/iat_inet_noiso.RData")
# load("3_objects/iat_snet_noiso.RData")
# load("3_objects/iat_dyn_noiso.RData")

### ADJ MATRICES
load("iat_adj2.RData")
# load("conflict_adj2.RData")
# load("alliance_adj2.RData")
# load("capdist_adj2.RData")
# load("capdist_log2_adj.RData")
load("iat_adj2.bin.RData")
load("iat.pcw.RData")

## IAT DYAD DF
load("iat_year_agg.RData")  # dyad-year level
load("iat_t_agg.RData")     # aggregated to dyad-time.spell level

### TIME SPELLS
tspells <- c("1993-97","1998-02","2003-07","2008-12","2013-17","2018-23")
# save(tspells, file = "tspells.RData")
# load("tspells.RData")

### DESCRIPTIVE STATS
load("5_objects/glob_df.RData") # all global network stats for t1-t6 (=6 obs i.e. time spells x 35 statistics)

## etc descriptive
# load("5_objects/loc_clo_list.RData") # only closeness centr, as list of vectors
# load("5_objects/clo_df_combined.RData") # closeness centr as df, only those with closeness centr >0
# load("5_objects/loc_clo_df.RData") # closeness centr as df, all 157 nodes x 6 time spells = 942
# load("5_objects/loc_cent_list.RData") # all local centrality measures, as a list
# load("5_objects/loc_cent_df.RData") # all loc centr, as df 942 obs = 157x6

### MODELS
load("6_objects/allm.RData") # all model coefs & stats
load("6_objects/logm.RData") # only logit
load("6_objects/orm.RData") # only or

# load("6_objects/m0.RData")
# load("6_objects/m1.RData")
# load("6_objects/m2.RData")
# load("6_objects/m3.RData")
# load("6_objects/m4.RData")
# load("6_objects/m5.RData")
# 
# load("6_objects/m5a.RData")
# load("6_objects/m5b.RData")
# load("6_objects/m5c.RData")
# load("6_objects/m5d.RData")
# load("6_objects/m5e.RData")
# load("6_objects/m5f.RData")
# load("6_objects/m5g.RData")


### GOF
load("6_objects/gof_stats.RData") # gof_stats = list with all gof stats, which themselves contain said stats for m0-m5g
load("6_objects/gofm.RData") # gofm = list with gof stats summarised for each model

## by model
# load("6_objects/gof_m0.RData")
# load("6_objects/gof_m1.RData")
# load("6_objects/gof_m2.RData")
# load("6_objects/gof_m3.RData")
# load("6_objects/gof_m4.RData")
# load("6_objects/gof_m5.RData")
# 
# load("6_objects/gof_m5a.RData")
# load("6_objects/gof_m5b.RData")
# load("6_objects/gof_m5c.RData")
# load("6_objects/gof_m5d.RData")
# load("6_objects/gof_m5e.RData")
# load("6_objects/gof_m5f.RData")
# load("6_objects/gof_m5g.RData")

## by stat
# load("6_objects/gof_geodesic.RData")
# load("6_objects/gof_outdegree.RData")
# load("6_objects/gof_indegree.RData")
# load("6_objects/gof_esp.RData")
# load("6_objects/gof_dsp.RData")
# load("6_objects/gof_triad.RData")
# load("6_objects/gof_istar.RData")
# load("6_objects/gof_ostar.RData")
# load("6_objects/gof_fastgreedy.RData")
# load("6_objects/gof_walktrap.RData")
# load("6_objects/gof_rocpr.RData")

```


### Zusatz für data prep
```{r}
# load("iat_inet_nocov.bin.RData")
# load("iat_snet_nocov.bin.RData")

load("iat_inet_year.RData")
load("iat_snet_year.RData")


load("un_members.RData")
load("un_mlist.RData")

## OUTPUTS
load("7_objects/cent9323.RData")
load("7_objects/iat_adj_weight22.RData")
load("7_objects/iat_adj_binary22.RData")


load("7_objects/iat_list2.RData")
load("7_objects/vis_df.RData")
load("7_objects/hist_df2.RData")


```


### Last session
```{r}
# load("we_25_m4_14.RData")
load("we_25_m4_17.RData")
```


## 0.2 Fonts

```{r}
# Load libraries for fonts
library(extrafont)
# font_import() # already imported, uncomment if not done yet
# fonts()
# font_import(prompt = FALSE)
# loadfonts(device = "win")
fonts <- windowsFonts()
# names(fonts[fonts=="TT Times New Roman"])

library(showtext)
library(showtextdb)
showtext_auto()  # automatically use showtext for rendering text


## GOOGLE REPO
# check google repo: https://fonts.google.com/ --> needs inet
# library(jsonlite)
# library(curl)
# library(sysfonts)
# font_add_google(name = mf, family = mf) # load fonts from Google Fonts repository. However, Arial is a proprietary system font and isn’t available through Google Fonts. Available in GFR e.g. "Roboto", "Lato", or "Open Sans"



## WIN SYSTEM
# Instead of using font_add_google() for "Arial" (which isn't available via Google Fonts), register Arial with showtext using font_add() function, by specifying the path to the Arial TrueType font
font_add("Arial", regular = "C:/Windows/Fonts/arial.ttf")  # Windows path for Arial already installed. 
mf <- "Arial"  # chosen font family
# mf <- "serif" ## TNR; "Roboto Condensed", alternative


```


## 0.3 Theme
```{r}
## my theme
# text = element_text(family = mf, size = 12)
# plot.title = element_text(family = mf, size = 13.5, face = "bold")
# plot.subtitle = element_text(family = mf, size = 12, face = "italic")
# axis.title = element_text(family = mf, size = 11)
# axis.text = element_text(family = mf, size = 9)
# strip.text = element_text(family = mf, size = 11)

mt <- theme(
  plot.title = element_text(family = mf, size = 13.5, face = "bold"),
  plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic"
  text = element_text(family = mf, size=15),
  axis.title = element_text(family = mf, size = 11),
  # axis.title.x = element_text(size = 9),
  # axis.title.y = element_text(size = 9),
  axis.text = element_text(family = mf, size = 9),
  # axis.text.x = element_text(size = 9),
  # axis.text.x = element_text(size = 9),
  strip.text = element_text(family = mf, size = 11)
  # legend.position="none",
  # text = element_text(size=rel(3.5)) # resize all together
  )
```




## 0.4 Data for stats plots

Prepare the dfs to a format that's useable for visualisations. Previously, time spell variable was factorized & iso2c code created


### a) average of t1-t6

VIS DF IS AN AVERAGE FOR ONE TIME SPELL; NOT ACROSS ALL TIME SPELLS!
```{r}
# # load("5_objects/cov_complete.RData")
# # add mean values by time spell for each centrality measure
# vis_df <- cov_complete %>%
#   group_by(time) %>% 
#   # by t
#   mutate(deg_mean_t= mean(degree),
#          ideg_mean_t= mean(indegree),
#          odeg_mean_t= mean(outdegree),
#          bet_mean_t= mean(betweenness),
#          eig_mean_t= mean(eigenvector),
#          clo_mean_t= mean(closeness)) %>% 
#   ungroup()
#   
# vis_df <- vis_df %>% 
#   # by country
#   group_by(state1h) %>% 
#   mutate(deg_mean_ctr = mean(degree),
#          ideg_mean_ctr = mean(indegree),
#          odeg_mean_ctr = mean(outdegree),
#          bet_mean_ctr = mean(betweenness),
#          eig_mean_ctr = mean(eigenvector),
#          clo_mean_ctr = mean(closeness)) %>% 
#   ungroup()
# 
# vis_df <- vis_df %>%
#   # all
#     mutate(deg_mean_all = mean(degree),
#          ideg_mean_all = mean(indegree),
#          odeg_mean_all = mean(outdegree),
#          bet_mean_all = mean(betweenness),
#          eig_mean_all = mean(eigenvector),
#          clo_mean_all = mean(closeness))
# 
# vis_df <- vis_df %>% 
#   group_by(state1h,iso2c,iso3c) %>% 
#   mutate(odeg = mean(odeg_mean_ctr),
#         ideg = mean(ideg_mean_ctr),
#         bet = mean(bet_mean_ctr),
#         eig = mean(eig_mean_ctr),
#         clo = mean(clo_mean_ctr),
#         odeg_m = mean(odeg_mean_all),
#         ideg_m = mean(ideg_mean_all),
#         bet_m = mean(bet_mean_all),
#         eig_m = mean(eig_mean_all),
#         clo_m = mean(clo_mean_all)) %>% 
#   ungroup()
# 
# vis_df <- vis_df %>% 
#   select(state1h:time,degree:clo_mean_all)

# save(vis_df, file = "7_objects/vis_df.RData")
load("7_objects/vis_df.RData")
```

```{r}
library(sjmisc)
# Explore
vis_df %>% 
  group_by(time) %>% 
  select(indegree) %>% 
  frq() # ymax = 32?, x range = 0-30 over all t-spells
```

```{r}
# Explore
vis_df %>% 
  group_by(time) %>%
  select(outdegree) %>% 
  frq() # ymax = 104?, x range = 0-102 over all t-spells
```




### b) averaged across 1993-2023
```{r}
# ## descriptive
# cent9323 %>% arrange(desc(odeg)) # USA first = 124
# cent9323 %>% arrange(desc(ideg)) # UKR first = 31
# hist(cent9323$odeg,130)
# hist(cent9323$ideg,160)
# cent9323 %>% frq(odeg)
# 
# 
# ## compute variables
# library(sjmisc)
# cent9323 <- cent9323 %>% 
#   mutate(odeg_cat = case_when(odeg == 0 ~ "0",
#                               odeg == 1 ~ "1",
#                               odeg == 2 ~ "2",
#                               odeg == 3 ~ "3",
#                               odeg == 4 ~ "4",
#                               odeg == 5 ~ "5",
#                               odeg == 6 ~ "6",
#                               odeg >= 7 ~ ">= 7"))
# 
# cent9323 <- cent9323 %>%
#   mutate(odeg_mean = mean(odeg),
#          ideg_mean = mean(ideg),
#          bet_mean = mean(bet),
#          eig_mean = mean(eig),
#          clo_mean = mean(clo)) %>% 
#   arrange(state1h)
```

```{r}
# save(cent9323, file = "7_objects/cent9323.RData")# 2. version different from cent9323 in 5.objects
# load("7_objects/cent9323.RData")
```



### etc
```{r}
# # collapse all networks' ties
# iat_adj.9323 <- iat_adj2.bin[[1]] + iat_adj2.bin[[2]] + iat_adj2.bin[[3]] + iat_adj2.bin[[4]] + iat_adj2.bin[[5]] + iat_adj2.bin[[6]] 
# 
# # binarize
# iat_adj.9323[iat_adj.9323>0] <- 1
# 
# # turn into graph
# # library(network)
# iat9323 <- network(iat_adj.9323)
# sna::degree(iat_adj.9323, gmode='graph') 

# library(tsna)
# odeg_9323 <- tSnaStats(net9323, snafun = "degree", cmode="outdegree") # FUN = degree,
# iat9323_dyn <- networkDynamic(network.list = iat9323, vertex.pid = "vertex.names") 
```

```{r}
# df <- vis_df %>%
#   group_by(state1h,iso2c,iso3c) %>%
#   summarise(odeg = mean(odeg_mean_ctr),
#             ideg = mean(ideg_mean_ctr),
#             bet = mean(bet_mean_ctr),
#             eig = mean(eig_mean_ctr),
#             clo = mean(clo_mean_ctr),
#             odeg_m = mean(odeg_mean_all),
#             ideg_m = mean(ideg_mean_all),
#             bet_m = mean(bet_mean_all),
#             eig_m = mean(eig_mean_all),
#             clo_m = mean(clo_mean_all)) %>%
#    ungroup()

```







## 0.5 Data for network plots

```{r}
# library(igraph)
# detach(package:igraph)
# library(statnet)
```

### a) assign centrality stats as node attributes

```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")
```

#### Centrality measures, separately

Degree
for some reason the sna code calculates indegree instead of degree
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

## DEGREE
# loc_deg[1,] # Germany degree = 53

# in cov df
cov_complete_list[[1]]$outdegree # Germany in t1 = 50
cov_complete_list[[6]]$outdegree # Germany in t6 = 54

# in network
sna::degree(iat_snet[[1]], gmode='graph') # germany id = 55, degree = 3??
sna::degree(iat_snet[[6]], gmode='graph') # germany id = 55, degree = 11??

# sna calculation of degree and indegree are the same...
a <- sna::degree(iat_snet[[1]],gmode = "digraph", cmode="indegree") 
b <- sna::degree(iat_snet[[1]], gmode='graph') 
a2 <- sna::degree(iat_snet[[6]],gmode = "digraph", cmode="indegree") 
b2 <- sna::degree(iat_snet[[6]], gmode='graph') 

identical(a,b)
identical(a2,b2)
rm(a)
rm(b)
rm(a2)
rm(b2)
```


Outdegree
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

## OUTDEGREE
# loc_odeg[1,] # Germany in t1 = 50
# loc_odeg[6,] # in t6 = 54

# in cov df
cov_complete_list[[1]]$outdegree # Germany in t1 = 50
cov_complete_list[[6]]$outdegree # Germany in t6 = 54

# in network
sna::degree(iat_snet[[1]],gmode = "digraph", cmode="outdegree") # ger id = 55, in t1 = 50
sna::degree(iat_snet[[6]],gmode = "digraph", cmode="outdegree") # ger id = 55, in t6 54
```


indegree
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

## indegree
# loc_odeg[1,] # Germany in t1 = 50
# loc_odeg[6,] # in t6 = 54

# in cov df
cov_complete_list[[1]]$indegree # Germany in t1 = 3
cov_complete_list[[6]]$indegree # Germany in t6 = 11

# in network
sna::degree(iat_snet[[1]],gmode = "digraph", cmode="indegree") # ger id = 55, in t1 = 3
sna::degree(iat_snet[[6]],gmode = "digraph", cmode="indegree") # ger id = 55, in t6 = 11
```


betweenness
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

# in cov df
cov_complete_list[[1]]$betweenness # Germany in t1 = ca. 179
cov_complete_list[[6]]$betweenness # Germany in t6 = ca. 221

# in network
sna::degree(iat_snet[[1]], gmode = "betweenness") # ger id = 55, in t1 = 53
sna::degree(iat_snet[[6]], gmode = "betweenness") # ger id = 55, in t6 = 65
```


eigenvector
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

# in cov df
cov_complete_list[[1]]$eigenvector # Germany in t1 = ca. 3.6^-1
cov_complete_list[[6]]$eigenvector # Germany in t6 = ca. 3.9^-1

# in network
sna::degree(iat_snet[[1]], gmode = "evcent") # ger id = 55, in t1 = 53
sna::degree(iat_snet[[6]], gmode = "evcent") # ger id = 55, in t6 = 65
```

closeness
```{r}
## EXAMPLE = Germany = ID 55
# network::get.vertex.attribute(iat_snet[[1]], attrname="vertex.names")

# in cov df
cov_complete_list[[1]]$closeness # Germany in t1 = ca. 0.0053
cov_complete_list[[6]]$closeness # Germany in t1 = ca. 0.0041

# in network
sna::closeness(iat_snet[[1]])# ger id = 55, in t1 = 0
sna::closeness(iat_snet[[6]]) # ger id = 55, in t6 = 0
```




#### ALL (looped)


For some reasons, the numbers calculated by sna are faulty and not as accurate as those calculated by tsna. So we'll roll with that.

```{r}
## add to all networks t1-t6 in iat_snet
for (i in 1:6) {
  ## NO LONGER IN USE BECAUSE SNA PACKAGE CALCULATES WRONG STATS
  # deg <- sna::degree(iat_snet[[i]], gmode='graph') 
  # odeg <- sna::degree(iat_snet[[i]], gmode = "digraph", cmode="outdegree")
  # ideg <- sna::degree(iat_snet[[i]], gmode = "digraph", cmode="indegree")
  # bet <- sna::degree(iat_snet[[i]], gmode = "betweenness")
  # eigen <- sna::degree(iat_snet[[i]], gmode = "evcent")
  
  ## IN USE: STATS FROM TSNA PACKAGE
  # from cov_complete_list
  deg <- cov_complete_list[[i]]$degree
  odeg <- cov_complete_list[[i]]$outdegree
  ideg <- cov_complete_list[[i]]$indegree
  bet <- cov_complete_list[[i]]$betweenness
  eigen <- cov_complete_list[[i]]$eigenvector
  close <- cov_complete_list[[i]]$closeness 
  
  # assign centrality measures as attributes
  iat_snet[[i]] %v% "degree" <- deg
  iat_snet[[i]] %v% "outdegree" <- odeg 
  iat_snet[[i]] %v% "indegree" <- ideg
  iat_snet[[i]] %v% "betweenness" <- bet
  iat_snet[[i]] %v% "eigenvector" <- eigen
  iat_snet[[i]] %v% "closeness" <- close
}


```


### b) save new iat_snet inc. network stats
```{r}
# save(iat_snet, file = "7_objects/iat_snet.RData")
load("7_objects/iat_snet.RData")
```




### c) check order

Degree and closeness centrality numbers from sna:: and from tsna:: don't match for some reason. Investigate later. 

```{r}
# order matches? outdegree
a <- cov_complete_list$t1$degree
# a <- cov_complete %>% filter(t == "t1") %>% pull(degree)
b <- iat_snet$t1 %v% "degree"
identical(a,b) # looks good

# order matches? outdegree
a <- cov_complete_list$t1$outdegree
# a <- cov_complete %>% filter(t == "t1") %>% pull(outdegree)
b <- iat_snet$t1 %v% "outdegree"
identical(a,b) # looks good

# order matches? indegree
a <- cov_complete_list$t1$indegree
# a <- cov_complete %>% filter(t == "t1") %>% pull(indegree)
b <- iat_snet$t1 %v% "indegree"
identical(a,b) # looks good

# order matches? betweenness
a <- cov_complete_list$t1$betweenness
# a <- cov_complete %>% filter(t == "t1") %>% pull(betweenness)
b <- iat_snet$t1 %v% "betweenness"
identical(a,b) # looks good

# order matches? eigenvector
a <- cov_complete_list$t1$eigenvector
# a <- cov_complete %>% filter(t == "t1") %>% pull(eigenvector)
b <- iat_snet$t1 %v% "eigenvector"
identical(a,b) # looks good

# order matches? closeness
a <- cov_complete_list$t1$closeness
# a <- cov_complete %>% filter(t == "t1") %>% pull(closeness)
b <- iat_snet$t1 %v% "closeness"
identical(a,b) # looks good

rm(a)
rm(b)
```







# I) HISTOGRAMS: in- & outdegree distributions


## 1.1. Collapsed 1993-2023

### Data

```{r}
library(dplyr)
cent9323 %>% filter(odeg == 0)
hist_df <- cent9323 %>% 
  dplyr::rename(Indegree = ideg,
         Outdegree = odeg,
         Betweenness = bet,
         Eigenvector = eig,
         Closeness = clo)
```

```{r}
# frq(hist_df$Indegree)
# hist(hist_df$Indegree)
```


```{r}
# save(hist_df, file = "7_objects/hist_df.RData")
load("7_objects/hist_df.RData")
```


```{r}
# Add new columns ()
hist_df2 <- hist_df %>%
  mutate(
    # each observation’s contribution to the overall fraction
    rel_Indegree = Indegree/sum(Indegree), # total n = 157
    rel_Outdegree = Indegree/sum(Outdegree),
    rel_Betweenness = Betweenness/sum(Betweenness),
    rel_Closeness = Closeness/sum(Closeness),
    rel_Eigenvector = Eigenvector/sum(Eigenvector)) #%>% 
  # select(-c(Indegree, Outdegree)) %>% 
  # rename(Indegree = rel_Indegree,
  #        Outdegree = rel_Outdegree)


# sum(hist_df2$rel_Outdegree)
# library(openxlsx)
# write.xlsx(hist_df2, file = "hist_df2.xlsx")
```


```{r}
# save(hist_df2, file = "7_objects/hist_df2.RData")
load("7_objects/hist_df2.RData")
```




### a) small
```{r}
#  
deg_hist9323 <- ggplot() +
  # filter(time != "xxx", state == "xxx") %>% 
  # ggplot(aes(x = odeg)) + # color = time, fill = time
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  # geom_vline(cent9323, aes(xintercept=odeg_mean), linewidth = 0.1) +
  # geom_vline(aes(xintercept = odeg_mean), linewidth = 0.1) +
  # geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_histogram(aes(x = hist_df$Outdegree, fill = "Outdegree distribution"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_histogram(aes(x = hist_df$Indegree, fill = "Indegree distribution"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  # geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.1) +
  theme_minimal() + 
  # scale_fill_brewer(palette="Paired") +  # "Set1" ,guide="legend"
  # scale_fill_fivethirtyeight() + # ggthemes
  scale_fill_manual(values = c("Outdegree distribution" = "navy", "Indegree distribution" = "salmon")) + #('pink','blue',"#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")
  scale_x_continuous(limits = c(0,130),
                     breaks = seq(0,130,10),
                     labels = as.character(seq(0,130,10))) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,62),
                     breaks = seq(0,62,10),
                     labels = as.character(seq(0,62,10))) +
  cowplot::background_grid(major = 'y', minor = "none") +
  labs(title = "In- and Outdegree distributions: International Arms Transfer Network (1993-2023)",
       subtitle = "Note. Vertical black line depicts average across the 157 UN members in the network",
       caption = "Data Source: SIPRI Arms Transfers Database 2023",
       x = "Degree",
       y = "Number of countries", #) +
       ,fill = "Centrality measure") +
  theme(text=element_text(size=15,  family="serif")) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 16, color = "black", face="bold",hjust = 0)) + 
  theme(plot.subtitle = element_text(family = mf, size = 12, color = "grey10",hjust = 0)) + 
  theme(plot.caption = element_text(family = mf, size = 12, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally, default hjust=1
  theme(axis.text = element_text(family = mf, size = 10)) +
  theme(legend.key.size = unit(0.2, 'cm'), #change legend key size
        legend.key.height = unit(0.2, 'cm'), #change legend key height
        legend.key.width = unit(0.2, 'cm'), #change legend key width
        legend.title = element_text(size=12, face="bold"), #change legend title font size
        legend.text = element_text(size=11),
        legend.position = "bottom") #+
deg_hist9323

```



### b) big


#### [droped: one chunk]
```{r}
#  
deg_hist9323_b <- ggplot() +
  # filter(time != "xxx", state == "xxx") %>% 
  # ggplot(aes(x = odeg)) + # color = time, fill = time
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  # geom_vline(cent9323, aes(xintercept=odeg_mean), linewidth = 0.1) +
  # geom_vline(aes(xintercept = odeg_mean), linewidth = 0.1) +
  # geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_histogram(aes(x = hist_df$Outdegree, fill = "Outdegree distribution"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_histogram(aes(x = hist_df$Indegree, fill = "Indegree distribution"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  # geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.1) +
  theme_minimal() + 
  # scale_fill_brewer(palette="Paired") +  # "Set1" ,guide="legend"
  # scale_fill_fivethirtyeight() + # ggthemes
  scale_fill_manual(values = c("Outdegree distribution" = "navy", "Indegree distribution" = "salmon")) + #('pink','blue',"#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")
  scale_x_continuous(limits = c(0,130),
                     breaks = seq(0,130,10),
                     labels = as.character(seq(0,130,10))) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,62),
                     breaks = seq(0,62,10),
                     labels = as.character(seq(0,62,10))) +
  cowplot::background_grid(major = 'y', minor = "none") +
  labs(title = "In- and Outdegree distributions: International Arms Transfer Network (1993-2023)",
       subtitle = "Note. Vertical black line depicts average across the 157 UN members in the network",
       caption = "Data Source: SIPRI Arms Transfers Database 2023",
       x = "Degree",
       y = "Number of countries", #) +
       ,fill = "Centrality measure") +
  theme(text=element_text(size=15,  family="serif")) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 35, color = "black", face="bold",hjust = 0)) + 
  theme(plot.subtitle = element_text(family = mf, size = 25, color = "grey10",hjust = 0)) + 
  theme(plot.caption = element_text(family = mf, size = 20, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally, default hjust=1
  theme(axis.text = element_text(family = mf, size = 18)) +
  theme(legend.key.size = unit(0.2, 'cm'), #change legend key size
        legend.key.height = unit(0.2, 'cm'), #change legend key height
        legend.key.width = unit(0.2, 'cm'), #change legend key width
        legend.title = element_text(size=20, face="bold"), #change legend title font size
        legend.text = element_text(size=20),
        legend.position = "bottom") #+

# dev.size("in")
deg_hist9323_b
ggsave("charts/deg_hist9323_b.png", width=6.7, height=4.14, dpi=300)

# dev.new(width = 7, height = 4.5) #noRStudioGD = T
```


#### used: patchwork
```{r}
library(ggplot2)
library(cowplot)

deg_hist9323_b2_base <- ggplot() +
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.6) +
  geom_histogram(aes(x = hist_df$Outdegree, fill = "Outdegree"), binwidth = 1, boundary = 0, closed = "left", position = "identity", alpha = 0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_histogram(aes(x = hist_df$Indegree, fill = "Indegree"), binwidth = 1, boundary = 0, closed = "left", position = "identity", alpha = 0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  theme_minimal() + 
  scale_fill_manual(values = c("Outdegree" = "navy", "Indegree" = "#e26449")) +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 130),
                     breaks = seq(0, 130, 10),
                     labels = as.character(seq(0, 130, 10))) + 
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 62),
                     breaks = seq(0, 62, 10),
                     labels = as.character(seq(0, 62, 10))) +
  cowplot::background_grid(major = 'y', minor = "none") +
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) +
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80"))

deg_hist9323_b2 <- deg_hist9323_b2_base +
  labs(title = "International Arms Transfer Network (1993-2023)",
       subtitle = "  In- and Outdegree distributions",
       caption = "a. Vertical black line depicts average across the 157 UN members in the network.\nb. Data Source: SIPRI Arms Transfers Database 2023",
       x = "Degree number",
       y = "Country count",
       fill = "") +
  theme(plot.title = element_text(family = mf, size = 11, color = "black", face = "bold", hjust = 0, vjust = 1),
        plot.subtitle = element_text(family = mf, size = 9, color = "grey10",hjust = 0,face="bold"),
        plot.caption = element_text(family = mf, size = 7, face = "italic", hjust = 0, vjust = -3),
        axis.title.x = element_text(family = mf, size = 7, face="bold"),  # Reduced size for x-axis label
        axis.title.y = element_text(family = mf, size = 7, face = "bold"),  # Reduced size for y-axis label
        axis.text.x = element_text(family = mf, size = 5),
        axis.text.y = element_text(family = mf, size = 5),
        axis.text = element_text(family = mf, size = 4),
        legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.key.height = unit(0.2, 'cm'),
        legend.key.width = unit(0.2, 'cm'),
        legend.title = element_text(size = 7, face = "bold"),
        legend.text = element_text(size = 6))

deg_hist9323_b2
# save(deg_hist9323_b2, file = "charts/deg_hist9323_b2.RData")
# load("deg_hist9323_b2.RData")
```


```{r}
# dev.size()
deg_hist9323_b2
ggsave(filename = "charts/deg_hist9323_b2.png", width = 6.26, height = 3.86)
```



```{r}
  #   # BETWEENNESS
  # geom_histogram(aes(x = hist_df$Indegree, fill = "Betweenness"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  #   # EIGENVECTOR
  # geom_histogram(aes(x = hist_df$Indegree, fill = "Eigenvector"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  #   # CLOSENESS
  # geom_histogram(aes(x = hist_df$Indegree, fill = "Closeness"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
```


```{r}
  # geom_label(label = "mean outdegree \n = 12.7",
  #            x = 25,
  #            y = 30,
  #            label.padding = unit(1, "lines"), # Rectangle size around label
  #            label.size = 3,
  #            # size.unit = "mm",
  #            color = "black")
  #            # fill="#69b3a2"
# p2 <- p +
#   geom_label(label = "mean outdegree \n = 12.7",
#            x = 25,
#            y = 30,
#            label.padding = unit(1, "lines"), # Rectangle size around label
#            label.size = 0.35, # Border size
#            size = 5, # Text size
#            color = "black")

  # ggthemes::theme_hc() +
  # axis.text.x = element_text(size = 20),
  # axis.title = element_text(size = 12, face = "bold"),
  # legend.position="none",
  # ,strip.text = element_text(size = 12)) +
  # theme(plot.title.position = "plot"
        # plot.title.position = "plot",
        # plot.caption.position =  "plot")
  # xlim(0,105) +
  # ylim(0,130) +
  # ggtitle("") +
  # xlab("") + ylab("") +
  # cowplot::panel_border() + # and a border around each panel
  # theme_economist_white(base_size = 11,base_family = "sans",gray_bg = TRUE,horizontal = TRUE
  # theme_economist(base_size = 10,base_family = "sans",horizontal = TRUE,dkpanel = FALSE)
  # theme_solarized()
  # guides(colour = "none") #+

  # geom_text(aes(size = 0.5),label = "") +
  # geom_bar(stat="identity", position=position_dodge(0.9)) +
  # geom_text(position=pd, aes(label=ifelse(Var2=="Searches", value, ""), y=0.5*value))
  # geom_text(check_overlap = TRUE) +
  #            ) +
```



### c) relative freq


#### klein
```{r}
# library(ggplot2)
# library(cowplot)
# library(scales)  # for percent_format()

deg_hist9323_kl_rel <- ggplot() +
  # Vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  
  # Outdegree histogram with y-axis normalized by the computed total count
  geom_histogram(
    data = hist_df,
    aes(x = Outdegree, y = ..count../sum(..count..), fill = "Outdegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # Indegree histogram, normalized
  geom_histogram(
    data = hist_df,
    aes(x = Indegree, y = ..count../sum(..count..), fill = "Indegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # fill colors manually for the two distributions
  scale_fill_manual(
    values = c("Outdegree distribution" = "#261FB3", "Indegree distribution" = "salmon")
  ) +
  
  # x-axis scale: cut off at 40 with breaks every 5 units
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 37),
    breaks = seq(0, 37, 5),
    labels = as.character(seq(0, 37, 5))
  ) +
  
  # y-axis scale: from 0 to 0.5 with breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, 0.1),
    labels = percent_format(accuracy = 1)
  ) +
  cowplot::background_grid(major = 'y', minor = "none") +
  
  # margins & grid
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"),
        plot.background = element_rect(fill = "seashell", color = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  
  # labels & legends
  labs(title = paste("International Arms Transfer Network (1993-2023): Degree distributions",
                     "                                                                     ",
                     sep = "\n"),
       # subtitle = paste("    Degree distributions",
       #                  "                                   ",
       #                  sep = "\n"),
       caption = paste("Notes:",
                       "  a. Vertical black line depicts average degree across the 157 UN members in the network.",
                       "  b. Indegree: range = 0-31, median = 13.",
                       "  c. Outdegree: range = 0-124, median = 1.",
                       "  d. Degree value on x-axis cut off at 35.",
                       "  e. Data Source: SIPRI Arms Transfers Database 2023.", 
                       sep = "\n"),
       x = paste("                                   ",
                 "Degree number",
                 sep = "\n"),
       y = paste("Network members (n = 157)",
                 "                                   ",
                 sep = "\n"),
       fill = "") +
  
  # font & theme
  theme(plot.title = element_text(family = mf, size = 16, color = "black", face = "bold", hjust = 0, vjust = 1),
        # plot.subtitle = element_text(family = mf, size = 11, color = "black", hjust = 0, face = "bold"),
        plot.caption = element_text(family = mf, size = 11, color = "black", face = "italic", hjust = 0, vjust = -3), # notes
        
        axis.title.x = element_text(family = mf, size = 13, color = "black", face = "bold"),# degree
        axis.title.y = element_text(family = mf, size = 13, color = "black", face = "bold"), # network members (n=157)
        # axis.text.x = element_text(family = mf, color = "black", size = 8),
        # axis.text.y = element_text(family = mf, color = "black", size = 8),
        axis.text = element_text(family = mf, color = "grey25", size = 11), # scales i.e. ticks
        
      
        legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.key.height = unit(0.2, 'cm'),
        legend.key.width = unit(0.25, 'cm'),
        # legend.title = element_text(size = 10, face = "italic"),# not used
        legend.text = element_text(size = 10)) # outdegree navy, indegree salmon

# check
deg_hist9323_kl_rel
# save(deg_hist9323_kl_rel, file = "charts/deg_hist9323_kl_rel.RData")
# load("deg_hist9323_kl_rel.RData")

```

#### klein 2

```{r}
deg_hist9323_kl2_rel <- ggplot() +
  # vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  
  # Outdegree histogram – normalized to total count
  geom_histogram(
    data = hist_df,
    aes(x = Outdegree, y = ..count../sum(..count..), fill = "Outdegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # Indegree histogram – normalized
  geom_histogram(
    data = hist_df,
    aes(x = Indegree, y = ..count../sum(..count..), fill = "Indegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # add red density line for Outdegree;
  # note: since the histogram is normalized (using ..count../sum(..count..)) and binwidth is 1,
  # mapping the density (which integrates to 1) should overlay reasonably well.
  geom_density(
    data = hist_df,
    aes(x = Outdegree, y = ..density..),
    color = "red", linewidth = 0.2, adjust = 2 # size = 1, 
  ) +
  
  
  
  # manually set fill colors for the two distributions
  scale_fill_manual(
    values = c("Outdegree distribution" = "#261FB3", "Indegree distribution" = "salmon")
  ) +
  
  # x-axis: cut-off at 37, breaks every 5 units
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 37),
    breaks = seq(0, 37, 5),
    labels = as.character(seq(0, 37, 5))
  ) +
  
  # y-axis: from 0 to 0.5, breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, 0.1),
    labels = percent_format(accuracy = 1)
  ) +
  
  # add background grid
  cowplot::background_grid(major = 'y', minor = "none") +
  
  # adjust panel margins, grid style and now force a less horizontal (more square) coordinate panel
  theme(
    plot.margin = unit(c(1, 1, 1, 1), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80")
  ) +
  
  # labels and captions
  labs(
    title = paste("International Arms Transfer Network (1993-2023): Degree distributions",
                  "                                                                     ",
                  sep = "\n"),
    caption = paste("Notes:",
                    "  a. Vertical black line depicts average degree across the 157 UN members in the network.",
                    "  b. Red density line",
                    "  c. Indegree: range = 0-31, median = 13.",
                    "  d. Outdegree: range = 0-124, median = 1.",
                    "  e. Degree value on x-axis cut off at 35.",
                    "  f. Data Source: SIPRI Arms Transfers Database 2023.", 
                    sep = "\n"),
    x = paste("                                   ",
              "Degree number",
              sep = "\n"),
    y = paste("Network members (n = 157)",
              "                                   ",
              sep = "\n"),
    fill = ""
  ) +
  
  # font definitions, legend and other theme details
  theme(
    plot.title = element_text(family = mf, size = 16, color = "black", face = "bold", hjust = 0, vjust = 1),
    plot.caption = element_text(family = mf, size = 11, color = "black", face = "italic", hjust = 0, vjust = -3),
    axis.title.x = element_text(family = mf, size = 13, color = "black", face = "bold"),
    axis.title.y = element_text(family = mf, size = 13, color = "black", face = "bold"),
    axis.text = element_text(family = mf, color = "grey25", size = 11),
    legend.position = "bottom",
    legend.key.size = unit(0.2, 'cm'),
    legend.key.height = unit(0.2, 'cm'),
    legend.key.width = unit(0.25, 'cm'),
    legend.text = element_text(size = 10)
  )


deg_hist9323_kl2_rel
deg_hist9323_kl3_rel <- deg_hist9323_kl2_rel + theme(aspect.ratio = 0.5)  # forces panel shape dimensions
deg_hist9323_kl3_rel

```




#### klein 3

```{r}
deg_hist9323_kl2_rel <- ggplot() +
  # vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  
  # Outdegree histogram – normalized to total count
  geom_histogram(
    data = hist_df,
    aes(x = Outdegree, y = ..count../sum(..count..), fill = "Outdegree distribution"),
    binwidth = 1, boundary = 0.5, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # Indegree histogram – normalized
  geom_histogram(
    data = hist_df,
    aes(x = Indegree, y = ..count../sum(..count..), fill = "Indegree distribution"),
    binwidth = 1, boundary = 0.5, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # add red density line for Outdegree;
  # note: since the histogram is normalized (using ..count../sum(..count..)) and binwidth is 1,
  # mapping the density (which integrates to 1) should overlay reasonably well.
  # geom_density(
  #   data = hist_df,
  #   aes(x = Outdegree, y = ..density..),
  #   color = "red", linewidth = 0.55, adjust = 2 # size = 1, 
  # ) +
  
  # manually set fill colors for the two distributions
  scale_fill_manual(
    values = c("Outdegree distribution" = "#261FB3", "Indegree distribution" = "salmon")
  ) +
  
  # x-axis: cut-off at 37, breaks every 5 units
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 37),
    breaks = seq(0, 37, 5),
    labels = as.character(seq(0, 37, 5))
  ) +
  
  # y-axis: from 0 to 0.5, breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, 0.1),
    labels = percent_format(accuracy = 1)
  ) +
  
  # add background grid
  cowplot::background_grid(major = 'y', minor = "none") +
  
  # adjust panel margins, grid style and now force a less horizontal (more square) coordinate panel
  theme(
    plot.margin = unit(c(0.7, 0.7, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    # panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    # panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    # panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80")
    # panel.grid.minor.x = element_line(size = 0.4, color = "grey80")
  ) +
  
  # labels and captions
  labs(
    title = paste("",
                  "International Arms Transfer Network (1993-2023): Degree distributions",
                  "",
                  sep = "\n"),
    caption = paste("",
                    "Notes:",
                    "  a. Vertical black line depicts the average degree among the 157 UN members.",
                    # "  b. Red curve depicts density line.",
                    "  b. Indegree: range = 0-31, median = 13.",
                    "  c. Outdegree: range = 0-124, median = 1.",
                    "  d. Degree value on x-axis cut off at 35.",
                    "  e.  Data Source: SIPRI Arms Transfers Database 2023.", 
                    sep = "\n"),
    x = paste("",
              "Degree number",
              sep = "\n"),
    y = paste("Vertices  (N = 157)",
              "",
              sep = "\n"),
    fill = ""
  ) +
  
  # font definitions, legend and other theme details
  theme(
    plot.title = element_text(family = mf, size = 14.5, color = "black", face = "bold", hjust = 1, vjust = 3),
    plot.caption = element_text(family = mf, size = 10, color = "black", face = "italic", hjust = 0, vjust = -1),
    axis.title.x = element_text(family = mf, size = 11, color = "black", face = "bold"), # hjust = 0, vjust = 0
    axis.title.y = element_text(family = mf, size = 11, color = "black", face = "bold"), # hjust  = 0, vjust = 0
    axis.text = element_text(family = mf, color = "grey25", size = 10), # ticks
    
    legend.position = "bottom",
    legend.key.size = unit(0.2, 'cm'),
    legend.key.height = unit(0.2, 'cm'),
    legend.key.width = unit(0.25, 'cm'),
    legend.text = element_text(size = 10)
  )


deg_hist9323_kl2_rel

```

```{r}

deg_hist9323_kl3_rel <- deg_hist9323_kl2_rel + coord_fixed(ratio = 25) # theme(aspect.ratio = 0.5)  # forces panel dimensions
deg_hist9323_kl3_rel


```



#### klein 4

```{r}
# library(ggplot2)
# library(scales)

deg_hist9323_kl2_rel <- ggplot() +
  # vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  
  # Outdegree histogram – normalized to total count
  geom_histogram(
    data = hist_df,
    aes(x = Outdegree, y = ..count../sum(..count..), fill = "Outdegree"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # Indegree histogram – normalized
  geom_histogram(
    data = hist_df,
    aes(x = Indegree, y = ..count../sum(..count..), fill = "Indegree"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # add red density line for Outdegree;
  # note: since the histogram is normalized (using ..count../sum(..count..)) and binwidth is 1,
  # mapping the density (which integrates to 1) should overlay reasonably well.
  # geom_density(
  #   data = hist_df,
  #   aes(x = Outdegree, y = ..density..),
  #   color = "red", linewidth = 0.55, adjust = 2 # size = 1, 
  # ) +
  
  # manually set fill colors for the two distributions
  scale_fill_manual(
    values = c("Outdegree" = "#261FB3", "Indegree" = "salmon")
  ) +
  
  # x-axis: cut-off at 37, breaks every 5 units, shifted by 0.5 to center the bins
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 36),
    breaks = seq(0.5, 36, 5),
    labels = as.character(seq(0, 36, 5))
  ) +
  
  # y-axis: from 0 to 0.5, breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, 0.1),
    labels = percent_format(accuracy = 1)
  ) +
  
  # add background grid
  cowplot::background_grid(major = 'y', minor = "none") +
  
  # adjust panel margins, grid style and now force a less horizontal (more square) coordinate panel
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    # panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    # panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    # panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80")
    # panel.grid.minor.x = element_line(size = 0.4, color = "grey80")
  ) +
  
  # labels and captions
  labs(
    title = paste("",
                  # "International Arms Transfer Network (1993-2023)",
                  sep = "\n"),
    subtitle = paste(
                     # "    In- and Outdegree Distributions",
                     "",
                     sep = "\n"),
    caption = paste("",
                    "Notes:",
                    "  a. Vertical black line depicts the average degree among the 157 UN members.",
                    # "  b. Red curve depicts density line.",
                    "  b. Indegree: range = 0-31, median = 13.",
                    "  c. Outdegree: range = 0-124, median = 1.",
                    "  d. Degree value on x-axis cut off at 35.",
                    "  e. Data Source: SIPRI Arms Transfers Database 2023.", 
                    sep = "\n"),
    x = paste("",
              # "Degree number",
              sep = "\n"),
    y = paste("Vertices  (N = 157)",
              "",
              sep = "\n"),
    fill = ""
  ) +
  
  # font definitions, legend and other theme details
  theme(
    plot.title = element_text(family = mf, size = 16, color = "black", face = "bold", hjust = 0, vjust = 3),
    plot.subtitle = element_text(family = mf, size = 12, color = "black", hjust = 0, face = "bold"),
    plot.caption = element_text(family = mf, size = 10, color = "black", face = "italic", hjust = 0, vjust = -1),
    axis.title.x = element_text(family = mf, size = 11, color = "black", face = "bold"), # hjust = 0, vjust = 0
    axis.title.y = element_text(family = mf, size = 11, color = "black", face = "bold"), # hjust  = 0, vjust = 0
    axis.text = element_text(family = mf, color = "grey25", size = 10), # ticks
    
    legend.position = "bottom",
    legend.key.size = unit(0.2, 'cm'),
    legend.key.height = unit(0.2, 'cm'),
    legend.key.width = unit(0.25, 'cm'),
    legend.text = element_text(size = 10)
  )

deg_hist9323_kl2_rel


```


```{r}
deg_hist9323_kl3_rel <- deg_hist9323_kl2_rel + coord_fixed(ratio = 32) # 25; theme(aspect.ratio = 0.5)  # forces panel dimensions
deg_hist9323_kl3_rel

```


#### groß
```{r}
# library(ggplot2)
# library(cowplot)
# library(scales)  # for percent_format()

deg_hist9323_b_rel <- ggplot() +
  # Vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$odeg_mean), linewidth = 0.2) +
  
  # Outdegree histogram with y-axis normalized by the computed total count
  geom_histogram(
    data = hist_df,
    aes(x = Outdegree, y = ..count../sum(..count..), fill = "Outdegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
    
  ) +
  
  # Indegree histogram, normalized
  geom_histogram(
    data = hist_df,
    aes(x = Indegree, y = ..count../sum(..count..), fill = "Indegree distribution"),
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  # fill colors manually for the two distributions
  scale_fill_manual(
    values = c("Outdegree distribution" = "#261FB3", "Indegree distribution" = "salmon")
  ) +
  
  # x-axis scale: cut off at 40 with breaks every 5 units
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 37),
    breaks = seq(0, 37, 5),
    labels = as.character(seq(0, 37, 5))
  ) +
  
  # y-axis scale: from 0 to 0.5 with breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, 0.1),
    labels = percent_format(accuracy = 1)
  ) +
  cowplot::background_grid(major = 'y', minor = "none") +
  
  # margins & grid
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"),
        plot.background = element_rect(fill = "seashell", color = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  
  # labels & legends
  labs(title = paste("International Arms Transfer Network (1993-2023): Degree distributions",
                     "                                                                     ",
                     sep = "\n"),
       # subtitle = paste("    Degree distributions",
       #                  "                                   ",
       #                  sep = "\n"),
       caption = paste("Notes:",
                       "  a. Vertical black line depicts average degree across the 157 UN members in the network.",
                       "  b. Indegree: range = 0-31, median = 13.",
                       "  c. Outdegree: range = 0-124, median = 1.",
                       "  d. Degree value on x-axis cut off at 35.",
                       "  e. Data Source: SIPRI Arms Transfers Database 2023.", 
                       sep = "\n"),
       x = paste("                                   ",
                 "Degree number",
                 sep = "\n"),
       y = paste("Network members (n = 157)",
                 "                                   ",
                 sep = "\n"),
       fill = "") +
  

  # font
  theme(plot.title = element_text(family = mf, size = 30, color = "black", face = "bold", hjust = 0, vjust = 1),
        # plot.subtitle = element_text(family = mf, size = 30, color = "black", hjust = 0, face = "bold"),
        plot.caption = element_text(family = mf, size = 14, color = "black", face = "italic", hjust = 0, vjust = -4), # notes
        
        axis.title.x = element_text(family = mf, size = 18, color = "black", face = "bold"), # degree
        axis.title.y = element_text(family = mf, size = 18, color = "black", face = "bold"), # network members (n=157)
        # axis.text.x = element_text(family = mf, color = "black", size = 8),
        # axis.text.y = element_text(family = mf, color = "black", size = 8),
        axis.text = element_text(family = mf, color = "black", size = 14), # scales i.e. ticks
        
        legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.key.height = unit(0.2, 'cm'),
        legend.key.width = unit(0.25, 'cm'),
        legend.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 18))  # outdegree navy, indegree salmon

# check
deg_hist9323_b_rel
# save(deg_hist9323_b_rel, file = "charts/deg_hist9323_b_rel.RData")
# load("deg_hist9323_b_rel.RData")

```




```{r}
# dev.size()
deg_hist9323_b_rel
ggsave(filename = "charts/deg_hist9323_b_rel.png", width = 7.3, height = 4.5)
```






OLD
```{r}
# ## INDEGREE
# hist_df3 <- hist_df
# 
# min_val <- floor(min(hist_df3$Indegree, na.rm = TRUE)) # bins at 1.0 interval
# max_val <- ceiling(max(hist_df3$Indegree, na.rm = TRUE))
# 
# breaks <- seq(min_val - 0.5, max_val + 0.5, by = 1) # bin width 1.0
# hist(hist_df3$Indegree, 
#      breaks = breaks,
#      probability = TRUE,             # Plot density (relative frequency)
#      col = "lightblue",             
#      main = "Indegree, Relative Distribution, IAT network 1993-2023",
#      ylab = "Fraction of network members (relative frequency)",
#      xlab = "Indegree",
#      xaxt = "n",                     # Suppress default x-axis
#      xlim = c(min_val - 0.5, max_val + 0.5),
#      ylim = c(0, 0.1))
# 
# abline(h = seq(0, 0.1, by = 0.01), col = "gray", lty = "dashed") # horizontal grid lines
# 
# ticks <- seq(min_val, max_val, by = 1) #custom tick positions
# axis(1, at = ticks)
# 
# # custom ticks for the y-axis at 0.01 intervals, labels only at 0.02 intervals
# yticks <- seq(0, 0.1, by = 0.01)  # Tick positions every 0.01
# ylabel_positions <- seq(0, 0.1, by = 0.02)  # Label positions every 0.02
# axis(2, at = yticks, labels = ifelse(yticks %in% ylabel_positions, sprintf("%.2f", yticks), ""))
# 
# lines(density(hist_df3$Indegree), col = "red", lwd = 2) # density curve 

```

```{r}
## OUTDEGREE
# hist_df3$Outdegree_grouped <- ifelse(hist_df3$Outdegree >= 20, 20, hist_df3$Outdegree) # Recode Outdegree, 20 or more equal to 20
# breaks <- seq(-0.5, 20.5, by = 1) # Define breaks so integers are centered in bins
# hist(hist_df3$Outdegree_grouped, 
#      breaks = breaks,
#      probability = TRUE,             # Density (relative frequency)
#      col = "lightblue",             
#      main = "Outdegree, Relative Distribution, IAT network 1993-2023",
#      ylab = "Fraction of network members (relative frequency)",
#      xlab = "Outdegree",
#      xaxt = "n",                     # Suppress default x-axis
#      xlim = c(-0.5, 20.5),           # Force x-axis to include the full range
#      ylim = c(0, 0.5))               # y-axis from 0 to 0.5
# abline(h = seq(0, 0.5, by = 0.05), col = "gray", lty = "dashed") # horizontal grid lines
# ticks <- 0:20
# tick_labels <- as.character(ticks)
# tick_labels[length(tick_labels)] <- ">20"
# axis(1, at = ticks, labels = tick_labels) # custom x-axis
# lines(density(hist_df3$Outdegree_grouped), col = "red", lwd = 2) # density curve
```


```{r}
## OUTDEGREE
# define breaks & ticks
# breaks <- seq(-0.5, max(hist_df3$Outdegree, 25) + 0.5, by = 1)
# ticks <- seq(0, 25, by = 5)  
# hist(hist_df3$Outdegree, 
#      breaks = breaks,
#      probability = TRUE,             # Density (relative frequency)
#      col = "lightblue",             
#      main = "Outdegree, Relative Distribution, IAT network 1993-2023",
#      ylab = "Fraction of network members (relative frequency)",
#      xlab = "Outdegree",
#      xaxt = "n",                     # Suppress default x-axis
#      xlim = c(-0.5, 25.5),           # Force x-axis to include the full range
#      ylim = c(0, 0.5))               # y-axis from 0 to 0.5
# abline(h = seq(0, 0.5, by = 0.05), col = "gray", lty = "dashed") # horizontal grid lines
# axis(1, at = ticks) # custom x-axis
# lines(density(hist_df3$Outdegree), col = "red", lwd = 2) # density cur
```







### d) rel freq betweenness

#### kl4

```{r}
descr(hist_df$Betweenness)
hist(hist_df$Betweenness, 50)

```


```{r}
# library(ggplot2)
# library(scales)

bet_hist9323_kl2_rel <- ggplot() +
  # vertical line for the average outdegree
  geom_vline(aes(xintercept = hist_df$bet_mean), linewidth = 0.2) +

  # Outdegree histogram – normalized to total count
  geom_histogram(
    data = hist_df,
    aes(x = Betweenness, y = after_stat(count)/sum(after_stat(count))), 
    binwidth = 10, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    fill = "salmon",  # Set fill directly here
    colour = "#333333", lwd = 0.1, linetype = 1
    # ,show.legend = FALSE  # Suppress legend
  ) +
# 
#   scale_fill_manual(
#     values = "salmon"
#   ) +

  # x-axis: cut-off at 37, breaks every 5 units, shifted by 0.5 to center the bins
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(0, 2000),
    breaks = seq(0, 2000, 250),
    labels = as.character(seq(0, 2000, 250))
  ) +

  # y-axis: from 0 to 0.5, breaks every 0.1, displayed as percentages
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.05),
    breaks = seq(0, 0.05, 0.01),
    labels = percent_format(accuracy = 1)
  ) +

  # add background grid
  cowplot::background_grid(major = 'y', minor = "none") +

  # adjust panel margins, grid style and now force a less horizontal (more square) coordinate panel
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80")
  ) +

  # labels and captions
  labs(
    title = "",
    subtitle = "",
    caption = paste("Notes:",
                    "  a. Vertical black line depicts the average betweenness centrality among the 157 UN members.",
                    "  b. Betweenness range = 0-3107, median = 5.7.",
                    "  c. Betweenness value on x-axis cut off at 2000.",
                    "  d. Data Source: SIPRI Arms Transfers Database 2023.", 
                    sep = "\n"),
    x = "",
    y = "Vertices (N = 157)",
    fill = ""
  ) +

  # font definitions, legend and other theme details
  theme(
    plot.title = element_text(family = mf, size = 16, color = "black", face = "bold", hjust = 0, vjust = 3),
    plot.subtitle = element_text(family = mf, size = 12, color = "black", hjust = 0, face = "bold"),
    plot.caption = element_text(family = mf, size = 10, color = "black", face = "italic", hjust = 0, vjust = -1),
    axis.title.x = element_text(family = mf, size = 11, color = "black", face = "bold"),
    axis.title.y = element_text(family = mf, size = 11, color = "black", face = "bold"),
    axis.text = element_text(family = mf, color = "grey25", size = 10)#,

    # legend.position = "bottom",
    # legend.key.size = unit(0.2, 'cm'),
    # legend.key.height = unit(0.2, 'cm'),
    # legend.key.width = unit(0.25, 'cm'),
    # legend.text = element_text(size = 10)
  )

bet_hist9323_kl2_rel

```

```{r}
deg_hist9323_kl3_rel <- deg_hist9323_kl2_rel + coord_fixed(ratio = 32) # 25; theme(aspect.ratio = 0.5)  # forces panel dimensions
deg_hist9323_kl3_rel

```




## 1.2. [DROP] all histograms separately

```{r}
range(cent9323$bet) # 0-3106.533 i.e. 31.1 * 10^2
range(cent9323$eig) # 0-0.31
range(cent9323$clo) # 0-1
range(cent9323$ideg) # 0-31
range(cent9323$odeg) # 0-124
```



### bet



```{r}

deg_bet9323 <- ggplot() +
  geom_vline(aes(xintercept = hist_df$bet_mean), linewidth = 0.2) +
  geom_histogram(aes(x = hist_df$Betweenness, fill = "salmon"), binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) + # fill = "Betweenness distribution"
  theme_minimal() + 
  # scale_fill_brewer(palette="Paired") + # customize
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,20),
                     breaks = seq(0,20,5),
                     labels = as.character(seq(0,20,5))) +
  scale_x_continuous(limits = c(-150, 2500),
                     expand = c(0, 0),
                     breaks = seq(0, 2500, 1000),
                     position = "bottom",
                     labels = scientific_format()
                     ) +
  cowplot::background_grid(major = 'y', minor = "none") +
  labs(title = "Betweenness centrality distribution: International Arms Transfer Network (1993-2023)",
       subtitle = "Note. Vertical black line depicts average across the 157 UN members in the network",
       caption = "Data Source: SIPRI Arms Transfers Database 2023",
       x = "Betweenness",
       y = "Number of countries") +
       # ,fill = "Centrality measure") +
  theme(text=element_text(size=15,  family="serif")) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 16, color = "black", face="bold",hjust = 0)) + 
  theme(plot.subtitle = element_text(family = mf, size = 12, color = "grey10",hjust = 0)) + 
  theme(plot.caption = element_text(family = mf, size = 12, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally, default hjust=1
  theme(axis.text = element_text(family = mf, size = 10)) +
  theme(legend.key.size = unit(0.2, 'cm'), #change legend key size
        legend.key.height = unit(0.2, 'cm'), #change legend key height
        legend.key.width = unit(0.2, 'cm'), #change legend key width
        legend.title = element_text(size=12, face="bold"), #change legend title font size
        legend.text = element_text(size=11),
        legend.position = "bottom") #+
deg_bet9323
```




## 1.2. By time spell
```{r}
# odeg_top10 <- vis_df %>% 
vis_df %>% 
  group_by(t) %>%
  slice_max(.,order_by = outdegree, n = 10, with_ties = T) %>% 
  # arrange(t,desc(outdegree)) %>% 
  mutate(iso2c = tolower(iso2c)) %>% 
  # mutate(state_fct = fct_reorder(state1h, outdegree)) %>% 
  # mutate(state_fct = reorder(state1h, outdegree)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(outdegree)])) %>% 
  # mutate(state1h = fct_reorder(state1h, outdegree)) %>% # forcats pck. for reverse: desc(indegree)
  # mutate(state_fct = fct_reorder2(state1h, -t_num, outdegree)) %>% 
  mutate(state_fct = reorder_within(state1h, outdegree, t)) %>% 
  ungroup()

  ggplot(aes(y = state_fct, x = outdegree, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=odeg_mean)) +
```

```{r}
 # pdf("charts/outdegree_t2.pdf", width = 4, height = 2) #, width = 8, height = 6
# vis_df %>%
# p_odeg_hist_t <- vis_df %>%
vis_df %>%
  # filter(time != "xxx", state == "xxx") %>% 
  ggplot(aes(x = outdegree, fill = time)) + # color = time, 
  geom_histogram(binwidth = 0.5, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_vline(data=vis_df, aes(xintercept=odeg_mean_t), linewidth = 0.1) +
  scale_fill_brewer(palette="Set1", guide="legend") + # guide = "colorbar"
  # scale_fill_fivethirtyeight() + # ggthemes
  # scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")) +
  # xlim(0,105) +
  # ylim(0,130) +
  scale_x_continuous(limits = c(0, 30),
                     breaks = seq(0, 30, by = 5),
                     labels = c("0","5","10", "15", "20", "25", "30")) + #c("0","5","10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60")) 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 110),
                     breaks = seq(0, 110, by = 10),
                     labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110")) +
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() + # and a border around each panel
  # scale_y_continuous(expand = c(0,0),
  #                    limits = c(0, 130),
  #                    breaks = seq(0, 130, by = 10),
  #                    labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130")) +
  labs(title = "Outdegree distribution by time spell: International Arms Transfer (MCW) 1993-2023",
       subtitle = "(Vertical black line depicts outdegree average at t)",
       x = "Number of countries",
       y = "Outdegree") +
  # annotate("label", x = -1, y = 1.25, label = "Vertical black line depicts average") +
  theme(plot.title = element_text(family = mf, size = 13.5, face = "bold"),
        plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic"
        text = element_text(size=15,  family = mf),
        axis.title = element_text(family = mf, size = 11),
        # axis.title.x = element_text(size = 9),
        # axis.title.y = element_text(size = 9),
        axis.text = element_text(family = mf, size = 9),
        # axis.text.x = element_text(size = 9),
        # axis.text.x = element_text(size = 9),
        strip.text = element_text(family = mf, size = 11)
        # legend.position="none",
        # text = element_text(size=rel(3.5)) # resize all together
        ) + # Define the subtitle element
  facet_wrap(vars(time), ncol=3) +
  guides(colour = "none", fill = "none") +
  # theme_solarized()
  ggthemes::theme_hc()
# dev.off()

p_odeg_hist_t # add footnote: x cut at 30, but range is longer
# save(p_odeg_hist_t, file = "7_objects/p_odeg_hist_t.RData")
# load("7_objects/p_odeg_hist_t.RData")
```


```{r}
vis_df_cent %>% filter(t == "t1") #%>% pull(outdegree) %>% frq()
```



```{r}
# ggsave(p_odeg_hist_t, 
#        filename = "charts/outdegree_t.png", device = "png",
#        width = 4, height = 3, units = "in", dpi = 300) # width = 5, height = 3
```


## 1.3. t1-t6

### out old
```{r}
# pdf("charts/outdegree_t2.pdf", width = 4, height = 2) #, width = 8, height = 6
# vis_df %>%
p_odeg_hist_t <- vis_df %>%
  # filter(time != "xxx", state == "xxx") %>% 
  ggplot(aes(x = outdegree, fill = time)) + # color = time, 
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_vline(data=vis_df, aes(xintercept=odeg_mean_t), linewidth = 0.1) +
  scale_fill_brewer(palette="Set1", guide="legend") + # guide = "colorbar"
  # scale_fill_fivethirtyeight() + # ggthemes
  # scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")) +
  # xlim(0,105) +
  # ylim(0,130) +
  
  
  scale_x_continuous(limits = c(0, 30),
                     breaks = seq(0, 30, by = 5),
                     labels = c("0","5","10", "15", "20", "25", "30")) + #c("0","5","10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60")) 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 110),
                     breaks = seq(0, 110, by = 10),
                     labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110")) +
  
  
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() + # and a border around each panel
  # scale_y_continuous(expand = c(0,0),
  #                    limits = c(0, 130),
  #                    breaks = seq(0, 130, by = 10),
  #                    labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130")) +
  
  labs(title = "Outdegree distribution by time spell: International Arms Transfer (MCW) 1993-2023",
       subtitle = "(Vertical black line depicts outdegree average at t)",
       x = "Outdegree",
       y = "Number of countries") +
  # annotate("label", x = -1, y = 1.25, label = "Vertical black line depicts average") +
  
  theme(plot.title = element_text(family = mf, size = 13.5, face = "bold"),
        plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic"
        text = element_text(size=15,  family = mf),
        axis.title = element_text(family = mf, size = 11),
        # axis.title.x = element_text(size = 9),
        # axis.title.y = element_text(size = 9),
        axis.text = element_text(family = mf, size = 9),
        # axis.text.x = element_text(size = 9),
        # axis.text.x = element_text(size = 9),
        strip.text = element_text(family = mf, size = 11)
        # legend.position="none",
        # text = element_text(size=rel(3.5)) # resize all together
  ) + # Define the subtitle element
  
  facet_wrap(vars(time), ncol=3) +
  guides(colour = "none", fill = "none") +
  # theme_solarized()
  ggthemes::theme_hc()
# dev.off()

p_ideg_hist_t # add footnote: x cut at 30, but range is longer

# save(p_ideg_hist_t, file = "7_objects/p_ideg_hist_t.RData")
# load("7_objects/p_ideg_hist_t.RData")
```

### in old
```{r}
# library(ggplot2)
# pdf("charts/indegree_t2.pdf", width = 4, height = 2) #, width = 8, height = 6
# vis_df %>%
indegree_dis_facet <- vis_df %>%
  # filter(time != "xxx", state == "xxx") %>% 
  ggplot(aes(x = indegree, fill = time)) + # color = time, 
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", position="identity", alpha=0.5, colour = "#333333", lwd = 0.1, linetype = 1) +
  geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_vline(data=vis_df, aes(xintercept=ideg_mean), linewidth = 0.1) +
  
  scale_fill_brewer(palette="Set1", guide="legend") + # guide = "colorbar"
  # scale_fill_fivethirtyeight() + # ggthemes
  # scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")) +
  # xlim(0,105) +
  # ylim(0,130) +
  scale_x_continuous(limits = c(0, 30),
                     breaks = seq(0, 30, by = 5),
                     labels = c("0","5","10", "15", "20", "25", "30")) + #c("0","5","10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60")) 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 40),
                     breaks = seq(0, 40, by = 10),
                     labels = c("0","10","20", "30", "40")) + #, "50", "60", "70", "80", "90", "100", "110"
  
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() +# and a border around each panel
  # scale_y_continuous(expand = c(0,0),
  #                    limits = c(0, 130),
  #                    breaks = seq(0, 130, by = 10),
  #                    labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130")) +
  labs(title = "Indegree distribution by time spell: International Arms Transfer (MCW) 1993-2023",
       subtitle = "(Vertical black line depicts indegree average)",
       x = "indegree",
       y = "Number of countries") +
  # annotate("label", x = -1, y = 1.25, label = "Vertical black line depicts average") +
  # theme(text = element_text(size=rel(3.5))) +
  
  theme(plot.title = element_text(family = mf, size = 13.5, face = "bold"),
        plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic"
        axis.title = element_text(family = mf, size = 11),
        # axis.title.y = element_text(size = 9),
        # axis.title.x = element_text(size = 9),
        axis.text = element_text(family = mf, size = 9),
        # axis.text.x = element_text(size = 20),
        # legend.position="none",
        strip.text = element_text(family = mf, size = 11)) + # Define the subtitle element
  facet_wrap(vars(time), ncol=3) +
  guides(colour = "none", fill = "none") +
  # theme_solarized()
  ggthemes::theme_hc()
# dev.off()

indegree_dis_facet


```

```{r}
# save(indegree_dis_facet, file = "7_objects/indegree_dis_facet.RData")
# load("7_objects/indegree_dis_facet.RData")
```


```{r}
# ggsave(indegree_dis_facet, 
#        filename = "charts/indegree_t.png", device = "png",
#        width = 4, height = 3, units = "in", dpi = 300) # width = 5, height = 3

# png(filename="charts/indegree_dis_facet2.png")
# plot(indegree_dis_facet)
# dev.off()
```


### new

```{r}
names(vis_df)
```

#### outdegree
```{r}
# pdf("charts/outdegree_t2.pdf", width = 4, height = 2) #, width = 8, height = 6
# vis_df %>%
p_odeg_hist_t <- ggplot() +
  # filter(time != "xxx", state == "xxx") %>% 

  geom_histogram(
    data = vis_df,
    aes(x = outdegree, fill = time), # absolute
    # aes(x = outdegree, y = ..count../sum(..count..), fill = time), # relative
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_vline(data=vis_df, aes(xintercept=odeg_mean_t), linewidth = 0.1) + # vertical line for the average outdegree
  
  scale_fill_brewer(palette="Set1", guide="legend") + # guide = "colorbar"
  # scale_fill_fivethirtyeight() + # ggthemes
  # scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")) +
  # xlim(0,105) +
  # ylim(0,130) +
  

  # x-axis: cut-off at 37, breaks every 5 units, shifted by 0.5 to center the bins
  scale_x_continuous(limits = c(0, 30),
                     breaks = seq(0.5, 36, by = 5),
                     labels = as.character(seq(0, 36, 5))) +
                     # labels = c("0","5","10", "15", "20", "25", "30") #c("0","5","10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60")) 
  
  # # y-axis RELATIVE FREQ: from 0 to 0.5, breaks every 0.1, displayed as percentages
  # scale_y_continuous(
  #   expand = c(0, 0),
  #   limits = c(0, 0.5),
  #   breaks = seq(0, 0.5, 0.1),
  #   labels = percent_format(accuracy = 1)
  # ) +
  # 
  # y-axis ABSOLUTE FREQ
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 120),
                     breaks = seq(0, 120, by = 20),
                     labels = as.character(seq(0, 120, 20))) +
                     # labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110")

  
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() + # and a border around each panel
  # scale_y_continuous(expand = c(0,0),
  #                    limits = c(0, 130),
  #                    breaks = seq(0, 130, by = 10),
  #                    labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130")) +
  
  labs(
    title = "Outdegree distribution by time spell: International Arms Transfer (MCW) 1993-2023",
    subtitle = paste(
                     # "    In- and Outdegree Distributions",
                     "",
                     sep = "\n"),
    x = paste("",
              "Outdegree",
              sep = "\n"),
    y = paste("Number of countries  (N = 157)",
              "",
              sep = "\n"),
    caption = paste("",
                "Notes:",
                "  a. Vertical black line depicts the average among the 157 UN members.",
                # "  b. Red curve depicts density line.",
                # "  b. Indegree: range = 0-31, median = 13.",
                # "  c. Outdegree: range = 0-124, median = 1.",
                "  b. Degree value on x-axis cut off at 30.",
                "  c. Data Source: SIPRI Arms Transfers Database 2023.", 
                sep = "\n"),
    fill = ""
  ) +
  
  
  theme(
    plot.title = element_text(family = mf, size = 14, color = "black", face = "bold", hjust = 0, vjust = 3),
    plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic", color = "black", hjust = 0, 
    plot.caption = element_text(family = mf, size = 9, color = "black", face = "italic", hjust = 0, vjust = -1),
    text = element_text(size=15,  family = mf),
    strip.text = element_text(family = mf, size = 11),
    # legend.position="none",
    # text = element_text(size=rel(3.5)) # resize all together

    # axis.title = element_text(family = mf, size = 11),
    axis.title.x = element_text(family = mf, size = 12, color = "black", face = "bold"), # hjust = 0, vjust = 0
    axis.title.y = element_text(family = mf, size = 12, color = "black", face = "bold"),
    axis.text = element_text(family = mf, color = "grey25", size = 9), # ticks
    # axis.text.x = element_text(size = 9),
    # axis.text.x = element_text(size = 9),

    
    ## panel
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    # panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    # panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    # panel.grid.minor.y = element_blank(),
    # panel.grid.minor.x = element_blank(),
    # panel.grid.minor.y = element_line(size = 0.4, color = "grey80")#,
    # panel.grid.minor.x = element_line(size = 0.4, color = "grey80")
    
    ## legend
    # legend.position = "bottom",
    # legend.key.size = unit(0.2, 'cm'),
    # legend.key.height = unit(0.2, 'cm'),
    # legend.key.width = unit(0.25, 'cm'),
    # legend.text = element_text(size = 10)
    
  ) +

  
  facet_wrap(vars(time), ncol=3) +
  guides(colour = "none", fill = "none") #+
  # theme_solarized()
  # ggthemes::theme_hc()
# dev.off()

p_odeg_hist_t # add footnote: x cut at 30, but range is longer

# save(p_odeg_hist_t, file = "7_objects/p_odeg_hist_t.RData")
# load("7_objects/p_odeg_hist_t.RData")
```


#### indegree

```{r}
# pdf("charts/indegree_t2.pdf", width = 4, height = 2) #, width = 8, height = 6
# vis_df %>%
p_ideg_hist_t <- ggplot() +
  # filter(time != "xxx", state == "xxx") %>% 
  
  geom_histogram(
    data = vis_df,
    aes(x = indegree, fill = time), # absolute
    # aes(x = indegree, y = ..count../sum(..count..), fill = time), # relative
    binwidth = 1, boundary = 0, closed = "left",
    position = "identity", alpha = 0.5,
    colour = "#333333", lwd = 0.1, linetype = 1
  ) +
  
  geom_hline(yintercept = 0, linewidth = 0.1, colour="#333333") +
  geom_vline(data=vis_df, aes(xintercept=ideg_mean_t), linewidth = 0.1) + # vertical line for the average indegree
  
  scale_fill_brewer(palette="Set1", guide="legend") + # guide = "colorbar"
  # scale_fill_fivethirtyeight() + # ggthemes
  # scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "red", "turquoise", "violet")) +
  # xlim(0,105) +
  # ylim(0,130) +
  
  
  # x-axis: cut-off at 37, breaks every 5 units, shifted by 0.5 to center the bins
  scale_x_continuous(limits = c(0, 30),
                     breaks = seq(0.5, 36, by = 5),
                     labels = as.character(seq(0, 36, 5))) +
                     # labels = c("0","5","10", "15", "20", "25", "30") #c("0","5","10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60")) 

  
  # # y-axis RELATIVE FREQ: from 0 to 0.5, breaks every 0.1, displayed as percentages
  # scale_y_continuous(
  #   expand = c(0, 0),
  #   limits = c(0, 0.5),
  #   breaks = seq(0, 0.5, 0.1),
  #   labels = percent_format(accuracy = 1)
  # ) +
  # 
  # y-axis ABSOLUTE FREQ
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 40),
                     breaks = seq(0, 40, by = 10),
                     labels = as.character(seq(0, 40, 10))) +
                     # labels = c("0","10","20", "30", "40")) + #, "50", "60", "70", "80", "90", "100", "110"
                     

  
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() + # and a border around each panel
  # scale_y_continuous(expand = c(0,0),
  #                    limits = c(0, 130),
  #                    breaks = seq(0, 130, by = 10),
  #                    labels = c("0","10","20", "30", "40", "50", "60", "70", "80", "90", "100", "110", "120", "130")) +
  
  labs(
    title = "Indegree distribution by time spell: International Arms Transfer (MCW) 1993-2023",
    subtitle = paste(
      # "    In- and indegree Distributions",
      "",
      sep = "\n"),
    x = paste("",
              "Indegree",
              sep = "\n"),
    y = paste("Number of countries  (N = 157)",
              "",
              sep = "\n"),
    caption = paste("",
                    "Notes:",
                    "  a. Vertical black line depicts the average among the 157 UN members.",
                    # "  b. Red curve depicts density line.",
                    # "  b. Indegree: range = 0-31, median = 13.",
                    # "  c. indegree: range = 0-124, median = 1.",
                    "  b. Degree value on x-axis cut off at 30.",
                    "  c. Data Source: SIPRI Arms Transfers Database 2023.", 
                    sep = "\n"
                    ),
    fill = ""
  ) +
  
  theme(
    plot.title = element_text(family = mf, size = 14, color = "black", face = "bold", hjust = 0, vjust = 3),
    plot.subtitle = element_text(family = mf, size = 12, face = "italic"), #"bold.italic", color = "black", hjust = 0, 
    plot.caption = element_text(family = mf, size = 9, color = "black", face = "italic", hjust = 0, vjust = -1),
    text = element_text(size=15,  family = mf),
    strip.text = element_text(family = mf, size = 11),
    # legend.position="none",
    # text = element_text(size=rel(3.5)) # resize all together

    # axis.title = element_text(family = mf, size = 11),
    axis.title.x = element_text(family = mf, size = 12, color = "black", face = "bold"), # hjust = 0, vjust = 0
    axis.title.y = element_text(family = mf, size = 12, color = "black", face = "bold"),
    axis.text = element_text(family = mf, color = "grey25", size = 9), # ticks
    # axis.text.x = element_text(size = 9),
    # axis.text.x = element_text(size = 9),

    
    ## panel
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    # panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    # panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    # panel.grid.minor.y = element_blank(),
    # panel.grid.minor.x = element_blank(),
    # panel.grid.minor.y = element_line(size = 0.4, color = "grey80")#,
    # panel.grid.minor.x = element_line(size = 0.4, color = "grey80")
    
    ## legend
    # legend.position = "bottom",
    # legend.key.size = unit(0.2, 'cm'),
    # legend.key.height = unit(0.2, 'cm'),
    # legend.key.width = unit(0.25, 'cm'),
    # legend.text = element_text(size = 10)
    
  ) +

  
  
  facet_wrap(vars(time), ncol=3) +
  guides(colour = "none", fill = "none") #+
# theme_solarized()
# ggthemes::theme_hc()
# dev.off()

p_ideg_hist_t # add footnote: x cut at 30, but range is longer

# save(p_ideg_hist_t, file = "7_objects/p_ideg_hist_t.RData")
# load("7_objects/p_ideg_hist_t.RData")
```






<br>

# II) BARCHARTS: Top 10 centralities

```{r}
rm(vis_df_sub)

```


## 2.1. Subset & packages
```{r}
# subset centrality stats
vis_df_cent <- vis_df %>% 
  select(state1h, iso2c, iso3c, t, t_num, time, degree:clo_mean)
vis_df_cent
# save(vis_df_cent, file = "vis_df_cent.RData")
# load("vis_df_cent.RData")

library(forcats)
library(countrycode)
library(tidytext) # for reorder_within
library(ggimage)
library(showtext)
library(ggplot2)
library(sysfonts)
library(curl)

font_add_google(name = mf, family = mf) # load font
showtext_auto() # use showtext to render text
```

code adapted from: https://juliasilge.com/blog/reorder-within/ and https://lynleyaldridge.netlify.app/2021/03/01/visualizing-data-using-ggplot2-and-ggflags/



```{r}
iat_adj.9323_weighted <- iat_adj2[[1]] + iat_adj2[[2]] + iat_adj2[[3]] + iat_adj2[[4]] + iat_adj2[[5]] + iat_adj2[[6]] 
iat_adj.9323_weighted %>% View()

iat_adj2[[1]] %>% View()

iat9323_el <- which(adj_matrix != 0, arr.ind = TRUE)
edge_list <- as.data.frame(edge_list)
colnames(edge_list) <- c("from", "to")
```



## 2.2. TIV DF


### data import/export

### exporter
```{r}
## do this for all 6 matrices of iat_adj2
adj_matrix <- iat_adj2[[6]]

edge_list <- which(!is.na(adj_matrix), arr.ind = TRUE)
edge_list <- as.data.frame(edge_list)
edge_list$exporter <- rownames(adj_matrix)[edge_list$row]
edge_list$importer <- colnames(adj_matrix)[edge_list$col]
edge_list$tiv <- adj_matrix[cbind(edge_list$row, edge_list$col)]

# Select and rename columns
el_t6 <- edge_list[, c("exporter", "importer", "tiv")]
rownames(el_t6) <- NULL
```


```{r}
time <- cov_complete %>% pull(time) %>% unique()
iso2c <- cov_complete %>% pull(iso2c) %>% unique()
iso3c <- cov_complete %>% pull(iso3c) %>% unique()
t <- cov_complete %>% pull(t) %>% unique()
t_num <- cov_complete %>% pull(t_num) %>% unique()
```

```{r}
el_t1_exp <- el_t1 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t1: 1993-1997",
         t = "t1",
         t_num = 1)
el_t1_exp$iso2c <- iso2c
el_t1_exp$iso3c <- iso3c
```

```{r}
# time
el_t2_exp <- el_t2 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t2: 1998-2002",
         t = "t2",
         t_num = 2)
el_t2_exp$iso2c <- iso2c
el_t2_exp$iso3c <- iso3c
```

```{r}
# time
el_t3_exp <- el_t3 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t3: 2003-2007",
         t = "t3",
         t_num = 3)
el_t3_exp$iso2c <- iso2c
el_t3_exp$iso3c <- iso3c
```

```{r}
el_t4_exp <- el_t4 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t4: 2008-2012",
         t = "t4",
         t_num = 4)
el_t4_exp$iso2c <- iso2c
el_t4_exp$iso3c <- iso3c
```

```{r}
# time
el_t5_exp <- el_t5 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t5: 2013-2017",
         t = "t5",
         t_num = 5)
el_t5_exp$iso2c <- iso2c
el_t5_exp$iso3c <- iso3c
```

```{r}
# time
el_t6_exp <- el_t6 %>% 
  group_by(exporter) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t6: 2018-2023",
         t = "t6",
         t_num = 6)
el_t6_exp$iso2c <- iso2c
el_t6_exp$iso3c <- iso3c
```


```{r}
el_exp <- rbind(el_t1_exp,el_t2_exp,el_t3_exp,el_t4_exp,el_t5_exp,el_t6_exp)
el_exp <- el_exp %>% 
  dplyr::rename(state1h = exporter)
```



```{r}
## small
export_top10 <- el_exp %>% 
  group_by(t) %>%
  # top_n(10, indegree) %>% 
  slice_max(.,order_by = tiv, n = 10, with_ties = T) %>% 
  mutate(iso2c = tolower(iso2c)) %>% # geom_flag() needs iso2c code in lowercase
  # mutate(state_fct = fct_reorder(state1h, indegree)) %>%  # forcats: factorizes country & reorders by descending indegree; for reverse order use desc(indegree) or .desc=T
  # mutate(state_fct = fct_reorder2(state1h, t_num, indegree)) %>%
  # mutate(state_fct = reorder(state1h, indegree)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(indegree)])) %>%  
  mutate(state_fct = reorder_within(state1h, tiv, t)) %>% # sets country as a factor and reorders countries by time spell and descending order of in/outdegree
  arrange(t,desc(tiv)) %>%
  ungroup()

# save(export_top10, file = "7_objects/export_top10.RData")
# load("7_objects/export_top10.RData")
```


### importer

```{r}
el_t1_imp <- el_t1 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t1: 1993-1997",
         t = "t1",
         t_num = 1)
el_t1_imp$iso2c <- iso2c
el_t1_imp$iso3c <- iso3c
```

```{r}
# time
el_t2_imp <- el_t2 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t2: 1998-2002",
         t = "t2",
         t_num = 2)
el_t2_imp$iso2c <- iso2c
el_t2_imp$iso3c <- iso3c
```

```{r}
# time
el_t3_imp <- el_t3 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t3: 2003-2007",
         t = "t3",
         t_num = 3)
el_t3_imp$iso2c <- iso2c
el_t3_imp$iso3c <- iso3c
```

```{r}
el_t4_imp <- el_t4 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t4: 2008-2012",
         t = "t4",
         t_num = 4)
el_t4_imp$iso2c <- iso2c
el_t4_imp$iso3c <- iso3c
```

```{r}
# time
el_t5_imp <- el_t5 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t5: 2013-2017",
         t = "t5",
         t_num = 5)
el_t5_imp$iso2c <- iso2c
el_t5_imp$iso3c <- iso3c
```

```{r}
# time
el_t6_imp <- el_t6 %>% 
  group_by(importer) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  mutate(time = "t6: 2018-2023",
         t = "t6",
         t_num = 6)
el_t6_imp$iso2c <- iso2c
el_t6_imp$iso3c <- iso3c
```


```{r}
el_imp <- rbind(el_t1_imp,el_t2_imp,el_t3_imp,el_t4_imp,el_t5_imp,el_t6_imp)
el_imp <- el_imp %>% 
  dplyr::rename(state1h = importer)
```



```{r}
## small
import_top10 <- el_imp %>% 
  group_by(t) %>%
  # top_n(10, indegree) %>% 
  slice_max(.,order_by = tiv, n = 10, with_ties = T) %>% 
  mutate(iso2c = tolower(iso2c)) %>% # geom_flag() needs iso2c code in lowercase
  # mutate(state_fct = fct_reorder(state1h, indegree)) %>%  # forcats: factorizes country & reorders by descending indegree; for reverse order use desc(indegree) or .desc=T
  # mutate(state_fct = fct_reorder2(state1h, t_num, indegree)) %>%
  # mutate(state_fct = reorder(state1h, indegree)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(indegree)])) %>%  
  mutate(state_fct = reorder_within(state1h, tiv, t)) %>% # sets country as a factor and reorders countries by time spell and descending order of in/outdegree
  arrange(t,desc(tiv)) %>%
  ungroup()

# save(import_top10, file = "7_objects/import_top10.RData")
# load("7_objects/import_top10.RData")
```


## 2.3. Export

```{r}
## refine plot
p_title_exp <- "Top 10 most active weapons exporters by time period"
p_subtitlex <- "  In million(s) of SIPRI trend indicator value"
p_captionx <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023"

# p_subtitle2 <- "Note. Vertical black line depicts average across the 157 UN members in the network \nCountries tied for last spot are all included in the ranking."
```

```{r}
mean_exp <- el_exp %>% pull(tiv) %>% mean()
el_exp %>% pull(tiv) %>% range()
```

```{r}
## NEU
# library(ggimage)
# base plot
p_top10_exp_base <- export_top10 %>%
  ggplot(aes(y = state_fct, x = tiv, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  # geom_vline(data=vis_df, aes(xintercept=ideg_mean_t)) +
  # geom_vline(aes(xintercept=mean_exp)) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
  # coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Paired") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -1000, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-1900, 12000),
                     expand = c(0, 0),
                     breaks = seq(0, 12000, 4000),
                     position = "bottom",
                     labels = scientific_format()) + # position = "top"
  # ,labels = c("0","5", "10","15", "20")) 
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.5, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.3, color = "grey80"))

```

```{r}
p_top10_exp <- p_top10_exp_base +
  labs(title = p_title_exp, subtitle = p_subtitlex, caption = p_captionx) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  theme(plot.subtitle = element_text(family = mf, size = 8, color = "grey10",hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 6),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_exp
# save(p_top10_exp, file = "charts/p_top10_exp.RData")
# load("charts/ideg_top10_bar.RData")
```

```{r}
library(ggimage)
# dev.size("in")
p_top10_exp
ggsave("charts/p_top10_exp_b.png", width=6.26, height=3.86, dpi=300)
```



## 2.3. Import

```{r}
## refine plot
p_title_imp <- "Top 10 most active weapons importers by time period"
p_subtitlex <- "  In million(s) of SIPRI trend indicator value"
p_captionx <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023"

# p_subtitle2 <- "Note. Vertical black line depicts average across the 157 UN members in the network \nCountries tied for last spot are all included in the ranking."
```

```{r}
mean_imp <- el_imp %>% pull(tiv) %>% mean()
el_imp %>% pull(tiv) %>% range()
```

```{r}
## NEU
# library(ggimage)
# base plot
p_top10_imp_base <- import_top10 %>%
  ggplot(aes(y = state_fct, x = tiv, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  # geom_vline(data=vis_df, aes(xintercept=ideg_mean_t)) +
  # geom_vline(aes(xintercept=mean_imp)) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
  # coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Paired") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -240, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-490, 3500),
                     expand = c(0, 0),
                     breaks = seq(0, 3500,1000),
                     position = "bottom") + #,
                     # labels = scientific_format()) + # position = "top"
  # ,labels = c("0","5", "10","15", "20")) 
  # scale_y_continuous(limits = c(-1, 20),
  #                    impand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.5, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.3, color = "grey80"))
```


```{r}
p_top10_imp <- p_top10_imp_base +
  labs(title = p_title_imp, subtitle = p_subtitlex, caption = p_captionx) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  theme(plot.subtitle = element_text(family = mf, size = 8, color = "grey10",hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 6),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_imp
# save(p_top10_imp, file = "charts/p_top10_imp.RData")
# load("charts/ideg_top10_bar.RData")
```


```{r}
# library(ggimage)
# dev.size("in")
p_top10_imp
ggsave("charts/p_top10_imp_b.png", width=6.26, height=3.86, dpi=300)
```




## 2.2. Indegree 

```{r}
## small
ideg_top10 <- vis_df %>% 
  group_by(t) %>%
  # top_n(10, indegree) %>% 
  slice_max(.,order_by = indegree, n = 10, with_ties = T) %>% 
  mutate(iso2c = tolower(iso2c)) %>% # geom_flag() needs iso2c code in lowercase
  # mutate(state_fct = fct_reorder(state1h, indegree)) %>%  # forcats: factorizes country & reorders by descending indegree; for reverse order use desc(indegree) or .desc=T
  # mutate(state_fct = fct_reorder2(state1h, t_num, indegree)) %>%
  # mutate(state_fct = reorder(state1h, indegree)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(indegree)])) %>%  
  mutate(state_fct = reorder_within(state1h, indegree, t)) %>% # sets country as a factor and reorders countries by time spell and descending order of in/outdegree
  arrange(t,desc(indegree)) %>%
  ungroup()

# save(ideg_top10, file = "7_objects/ideg_top10.RData")
# load("7_objects/ideg_top10.RData")
```


```{r}
p_title2<- "Top 10 most active weapons importers by time period"
p_subtitle2 <- "  In indegree"
p_caption2 <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023 \nc. Vertical black line depicts average across the 157 UN members in the network"
```

```{r}
p_top10_ideg_base <- ideg_top10 %>%
  ggplot(aes(y = state_fct, x = indegree, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=ideg_mean_t), linewidth = 0.1) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
  # coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Paired") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -1.8, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-2.4, 30),
                     expand = c(0, 0),
                     breaks = seq(0, 30, 5),
                     position = "bottom") + # position = "top"
  # ,labels = c("0","5", "10","15", "20")) 
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80"))
```

```{r}
p_top10_ideg <- p_top10_ideg_base +
  labs(title = p_title2, subtitle = p_subtitle2, caption = p_caption2) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  theme(plot.subtitle = element_text(family = mf, size = 9, color = "grey10",face="bold", hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 4.5),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_ideg
# save(p_top10_ideg, file = "charts/p_top10_ideg.RData")
# load("charts/ideg_top10_bar.RData")
```

```{r}
# dev.size("in")
p_top10_ideg
ggsave("charts/NEU_p_top10_ideg_b.png", width=6.26, height=3.86, dpi=300)
```




## 2.3. Outdegree

```{r}
odeg_top10 <- vis_df %>% 
  group_by(t) %>%
  slice_max(.,order_by = outdegree, n = 10, with_ties = T) %>% 
  # arrange(t,desc(outdegree)) %>% 
  mutate(iso2c = tolower(iso2c)) %>% 
  # mutate(state_fct = fct_reorder(state1h, outdegree)) %>% 
  # mutate(state_fct = reorder(state1h, outdegree)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(outdegree)])) %>% 
  # mutate(state1h = fct_reorder(state1h, outdegree)) %>% # forcats pck. for reverse: desc(indegree)
  # mutate(state_fct = fct_reorder2(state1h, -t_num, outdegree)) %>% 
  mutate(state_fct = reorder_within(state1h, outdegree, t)) %>% 
  arrange(t,desc(outdegree)) %>%
  ungroup()

# save(odeg_top10, file = "7_objects/odeg_top10.RData")
# load("7_objects/odeg_top10.RData")
```
--> data ready for plotting.

```{r}
p_title3 <- "Top 10 most active weapons exporters by time period"
p_subtitle3 <- "  In outdegree"
p_caption3 <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023 \nc. Vertical black line depicts average across the 157 UN members in the network"
```

```{r}
# base plot
p_top10_odeg_base <- odeg_top10 %>%
  ggplot(aes(y = state_fct, x = outdegree, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=odeg_mean_t), linewidth = 0.1) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
  # coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Paired") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -6, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-8, 110),
                     expand = c(0, 0),
                     breaks = seq(0, 110, 25),
                     position = "bottom") +
                     # ,labels = c("0","5", "10","15", "20")) 
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80"))

```

```{r}
p_top10_odeg <- p_top10_odeg_base +
  labs(title = p_title3, subtitle = p_subtitle3, caption = p_caption3) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  theme(plot.subtitle = element_text(family = mf, size = 9, color = "grey10",face="bold", hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 5),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_odeg
# save(p_top10_odeg, file = "charts/p_top10_odeg.RData")
# load("charts/p_top10_odeg.RData")
```

```{r}
# dev.size("in")
p_top10_odeg
ggsave("charts/NEU_p_top10_odeg_b.png", width=6.26, height=3.86, dpi=300)
```


--> The average outdegree centralization over all times were XXX (n = 157).

The following centrality measures will not be divided into countries receiving and sending ties. The measures are canculated using undirected data.




## 2.4. Betweenness

Betweenness centrality measures the number of times a node lies on the shortest path between other nodes. What it tells us: This measure shows which nodes are 'bridges' between nodes in a network.
```{r}
bet_top10 <- vis_df %>% 
  group_by(t) %>%
  slice_max(.,order_by = betweenness, n = 10, with_ties = T) %>% 
  # arrange(t,desc(betweenness)) %>% 
  mutate(iso2c = tolower(iso2c)) %>% 
  # mutate(state_fct = fct_reorder(state1h, betweenness)) %>% 
  # mutate(state_fct = reorder(state1h, betweenness)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(betweenness)])) %>% 
  # mutate(state1h = fct_reorder(state1h, betweenness)) %>% # forcats pck. for reverse: desc(indegree)
  # mutate(state_fct = fct_reorder2(state1h, -t_num, betweenness)) %>% 
  mutate(state_fct = reorder_within(state1h, betweenness, t)) %>% 
  ungroup() %>% 
  mutate(betweenness_100 = betweenness/100)

# save(bet_top10, file = "7_objects/bet_top10.RData")
# load("7_objects/bet_top10.RData")
```

```{r}
p_title4 <- "Top 10 betweenness centrality by time period" # (in 10^2)
p_caption4 <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023 \nc. Vertical black line depicts average across the 157 UN members in the network"
```


```{r}
p_top10_bet_base <- bet_top10 %>%
  ggplot(aes(y = state_fct, x = betweenness, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=bet_mean_t), linewidth = 0.1) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
# coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Paired") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -250, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-490, 2500),
                     expand = c(0, 0),
                     breaks = seq(0, 2500, 1000),
                     position = "bottom",
                     labels = scientific_format()
                     ) + 
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + 
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80"))
```

```{r}
p_top10_bet <- p_top10_bet_base +
  labs(title = p_title4, caption = p_caption4) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  # theme(plot.subtitle = element_text(family = mf, size = 9, color = "grey10",face="bold", hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 5),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_bet
# save(p_top10_bet, file = "charts/p_top10_bet.RData")
# load("charts/p_top10_bet.RData")
```

```{r}
# dev.size("in")
p_top10_bet
ggsave("charts/NEU_p_top10_bet_b.png", width=6.26, height=3.86, dpi=300)
```


## 2.5. Eigenvector


```{r}
eig_top10 <- vis_df %>% 
  group_by(t) %>%
  slice_max(.,order_by = eigenvector, n = 10, with_ties = T) %>% 
  # arrange(t,desc(eigenvector)) %>% 
  mutate(iso2c = tolower(iso2c)) %>% 
  # mutate(state_fct = fct_reorder(state1h, eigenvector)) %>% 
  # mutate(state_fct = reorder(state1h, eigenvector)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(eigenvector)])) %>% 
  # mutate(state1h = fct_reorder(state1h, eigenvector)) %>% # forcats pck. for reverse: desc(indegree)
  # mutate(state_fct = fct_reorder2(state1h, -t_num, eigenvector)) %>% 
  mutate(state_fct = reorder_within(state1h, eigenvector, t)) %>% 
  ungroup()

# save(eig_top10, file = "7_objects/eig_top10.RData")
# load("7_objects/eig_top10.RData")
```


```{r}
eig_top10 %>% arrange(desc(eigenvector)) # 0.12-0.48
```



```{r}
p_title5 <- "Top 10 eigenvector centrality by time period"
p_caption5 <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023 \nc. Vertical black line depicts average across the 157 UN members in the network"
```


```{r}
# library(ggimage)
# library(showtext)

p_top10_eig_base <- eig_top10 %>%
  ggplot(aes(y = state_fct, x = eigenvector, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=eig_mean_t), linewidth = 0.1) +
  facet_wrap(~time, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
# coord_flip()
  theme_minimal() + 
  scale_fill_brewer(palette="Set1") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -0.024, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-0.048, 0.5),
                     expand = c(0, 0),
                     breaks = seq(0, 0.5, 0.1),
                     position = "bottom") + # position = "top"
  #                  labels = scientific_format()
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) + 
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) 

```


```{r}
p_top10_eig <- p_top10_eig_base +
  labs(title = p_title5, caption = p_caption5) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  # theme(plot.subtitle = element_text(family = mf, size = 9, color = "grey10",face="bold", hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 5),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_eig
# save(p_top10_bet, file = "charts/p_top10_bet.RData")
# load("charts/p_top10_bet.RData")
```

```{r}
# dev.size("in")
p_top10_eig
ggsave("charts/NEU_p_top10_eig_b.png", width=6.26, height=3.86, dpi=300)
```










## 2.6. Closeness


```{r}
clo_top10 <- vis_df %>% 
  group_by(t) %>%
  slice_max(.,order_by = closeness, n = 15, with_ties = T) %>% 
  # arrange(t,desc(closeness)) %>% 
  mutate(iso2c = tolower(iso2c)) %>% 
  # mutate(state_fct = fct_reorder(state1h, closeness)) %>% 
  # mutate(state_fct = reorder(state1h, closeness)) %>% 
  # mutate(state_fct = factor(state1h, levels = state1h[order(closeness)])) %>% 
  # mutate(state1h = fct_reorder(state1h, closeness)) %>% # forcats pck. for reverse: desc(indegree)
  # mutate(state_fct = fct_reorder2(state1h, -t_num, closeness)) %>% 
  mutate(state_fct = reorder_within(state1h, closeness, t)) %>% 
  ungroup()

# save(clo_top10, file = "clo_top10.RData")
# load("clo_top10.RData")
```



```{r}
p_title6 <- "Top 15 closeness centrality by time period"
p_caption6 <- "a. Countries tied for last spot are all included in the ranking.\nb. Data Source: SIPRI Arms Transfers Database 2023 \nc. Vertical black line depicts average across the 157 UN members in the network"
```


```{r}
p_top10_clo_base <- clo_top10 %>%
  ggplot(aes(y = state_fct, x = closeness, fill = time)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  geom_vline(data=vis_df, aes(xintercept=clo_mean_t), linewidth = 0.1) +
  facet_wrap(~time, scales = "free_y", ncol = 2) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none") +
  theme_minimal() + 
  scale_fill_brewer(palette="Set1") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -0.049, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-0.09, 1.05),
                     expand = c(0, 0),
                     breaks = seq(0, 1.05, 0.2),
                     position = "bottom") + # position = "top"
  scale_y_reordered() +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) 
  # coord_flip()

```

```{r}
p_top10_clo <- p_top10_clo_base +
  labs(title = p_title6, caption = p_caption6) +
  theme(plot.title = element_text(family = mf, size = 10.5, color = "black", face="bold",hjust = 0, vjust = 1)) + 
  # theme(plot.subtitle = element_text(family = mf, size = 9, color = "grey10",face="bold", hjust = 0, vjust = 1)) + 
  theme(plot.caption = element_text(family = mf, size = 6, color = "grey10", face = "italic", hjust = 0, vjust = -3)) + # change hjust to move caption horizontally, default hjust=1
  # theme(plot.title.position = "plot"
  # plot.title.position = "plot",
  # plot.caption.position =  "plot")
  theme(
    # axis.text = element_text(family = mf, size = 9),
    axis.text.x = element_text(family = mf, size = 5),
    axis.text.y = element_text(family = mf, size = 5),
    # axis.title = element_text(size = 12, face = "bold"),
    # legend.position="none",
    strip.text = element_text(family = mf, size = 7, face ="bold"))

p_top10_clo
# save(p_top10_clo, file = "charts/p_top10_clo.RData")
# load("charts/p_top10_clo.RData")
```

```{r}
# dev.size("in")
p_top10_clo
ggsave("charts/NEU_p_top15_clo_b.png", width=6, height=6.5, dpi=300) #width=6.26, height=3.86
```





## 2.7. All centralities DF (by time period & by country)

- range, mean etc

```{r} 
library(knitr)
library(kableExtra)
names(vis_df)
## Data
cent_ctr_time_stats <- vis_df %>%
  dplyr::select(1:3,6:12) %>%
  dplyr::rename(`Time spell` = time,
         Country = state1h,
         Betweenness = betweenness,
         Closeness = closeness,
         Eigenvector = eigenvector,
         Indegree = indegree,
         Outdegree = outdegree,
         Degree = degree,
         Iso2c = iso2c,
         Iso3c = iso3c) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3)))

```

### by country
```{r}
library(dplyr)
cent_country_stats <- cent_ctr_time_stats %>% 
  group_by(Country,Iso2c,Iso3c) %>% 
  dplyr::summarise(Closeness = mean(Closeness),
                   Betweenness = mean(Betweenness),
                   Eigenvector = mean(Eigenvector),
                   Indegree = mean(Indegree),
                   Outdegree = mean(Outdegree),
                   Degree = mean(Degree)) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3))) %>% 
  select(Country,Iso2c,Iso3c,Degree,Indegree,Outdegree,Betweenness,Eigenvector,Closeness) %>%
  ungroup()

# cent_country_stats <- as.data.frame(lapply(cent_country_stats, unclass))

```

### by period
```{r}
library(dplyr)
cent_period_stats <- cent_ctr_time_stats %>% 
  group_by(`Time spell`) %>% #group_by(`Time spell`,Iso2c,Iso3c)
  dplyr::summarise(Closeness = mean(Closeness),
                   Betweenness = mean(Betweenness),
                   Eigenvector = mean(Eigenvector),
                   Indegree = mean(Indegree),
                   Outdegree = mean(Outdegree),
                   Degree = mean(Degree)) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3))) %>% 
  select(`Time spell`,Degree,Indegree,Outdegree,Betweenness,Eigenvector,Closeness) %>%
  ungroup()
```

### summary 

```{r}
library(sjmisc)
## by country
df_country_descr <- data.frame(descr(cent_country_stats))
df_country_descr <- df_country_descr %>% 
  select(1,6:13) %>%
  dplyr::rename(`Centrality measure` = var,
         Mean = mean,
         SD = sd,
         SE = se,
         Median = md,
         Trimmed = trimmed,
         Range = range,
         IQR = iqr,
         Skew = skew
         )

```

```{r}
# descr(cent_ctr_time_stats)
```

```{r}
## by period
# descr(cent_period_stats)
```

```{r}
# save(df_country_descr, file = "7_objects/df_country_descr.RData")
# load("7_objects/df_country_descr.RData")

# save(cent_country_stats, file = "7_objects/cent_country_stats.RData")
# load("7_objects/cent_country_stats.RData")

# save(cent_period_stats, file = "7_objects/cent_period_stats.RData")
# load("7_objects/cent_period_stats.RData")

# save(cent_ctr_time_stats, file = "7_objects/cent_ctr_time_stats.RData")
# load("7_objects/cent_ctr_time_stats.RData")
```


# III) NETWORK PLOTS


### 3.0. Plot by t: explore network
```{r}
# # explore
iat_snet$t6 # as network objects
# iat_snet$t6 %e% "weight" 
# iat_snet$t6 %v% "names" 

iat_adj2[[6]] %>% View() # as adj matrix

## EDGES ADJ
iat_adj2[[6]]["Germany",] # Germany's exports (a lot)
iat_adj2[[6]][,"Germany"] # Germany's imports (mostly 0)
# iat_adj2[[6]]["Germany","Israel"] # Germany's export to Israel
```

INET
```{r}
# summary(iat_snet$t1)

## VERTICES INET

# igraph::vertex_attr(iat_inet$t1)
# igraph::vertex_attr(iat_inet$t1)$ln_milex
# igraph::vertex_attr(iat_inet$t1, index = c("Germany","Israel","United States"))
# igraph::V(iat_inet$t1)[c("Germany","Israel","United States")]$ln_milex
```

```{r}
## EDGE INET

# 1) edge ID bw Germany - Israel

# igraph::get.edge.ids(iat_inet$t6, c("Germany","Israel"), directed = TRUE) # 291
# igraph::get.edge.ids(iat_inet$t6, c("Israel","Germany"), directed = TRUE) # 358
# igraph::E(iat_inet$t6)[291]$weight # arms transfer value (tiv) from Ger to Isr = ca. 155.7

# 2) specific edges: Canada->Columbia & Canada->France

# # weight = weapons transfer, measured by sipri's trend indicator value (tiv)
# igraph::E(iat_inet$t1)[c(39,41)]
# # edge_attr(iat_inet_t1, index = c(39,41)) # all e.attr of edges 39 and 41
# igraph::E(iat_inet$t1)[c(39,41)]$weight # Canada->Columbia = 2.45; Canada->France = 11.00
```


SNET
```{r}

### VERTICES SNET
# iat_snet$t1 %v% "vertex.names"
# which(iat_snet$t1 %v% "vertex.names" == "Germany") # vID = 55
# iat_snet$t1 %v% "ln_milex"
# iat_snet$t1 %v% "degree"
# iat_snet$t1 %v% "new variable" # <- vector with 157 values in the order of nodes list
```

```{r}
## EDGES SNET
# iat_snet$t6 %e% "weight" # edges
# network::get.edgeIDs(iat_snet$t6, v=55, alter=71, "out") # node ID 55 = Ger, 71 = Israel --> outgoing edge ID = 291 = export from Ger to Isr
# network::get.edges(iat_snet$t6, v=55, alter=71, "out") # get weight for this edge
# iat_snet$t6$mel[[291]] # = ca. 155 (in million tiv) # same, but gotten from edge ID
```


### 3.1. Plot by t: simple snet (red, using ajd mx)

#### t1-t2
```{r}
# t1-t2
# pdf("iat_plot_12.pdf", width = 9, height = 3)
# par(mfrow = c(1, 2),     # 1 row x 3 cols
#     oma = c(1,1,1,1),    # all sides 1 outer margin
#     mar = c(1,0,2,0))    # inner margins 

for (i in 1:2) {   # (length(nw) - 1):length(nw)
  tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")
  plot(iat_snet[[i]],
         main = paste("t =",i,":", tspells[[i]]))
}
# dev.off()
```


#### t1-t3
```{r}
# t1-t3
# pdf("iat_plot_123.pdf", width = 9, height = 3)
# par(mfrow = c(1, 3),     # 1 row x 3 cols
#     oma = c(1,1,1,1),    # all sides 1 outer margin
#     mar = c(1,0,2,0))    # inner margins 

for (i in 1:3) {   # (length(nw) - 1):length(nw)
  tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")
  plot(iat_snet[[i]],
         main = paste("t =",i,":", tspells[[i]]))
}
# dev.off()
```


#### t1-t6
```{r}
# t1-t6
# pdf("iat_plot_a.pdf", width = 9, height = 5)
par(mfrow = c(2, 3),     # 2 rows x 3 cols
    oma = c(1,1,1,1),    # all sides 1 outer margin
    mar = c(1,0,2,0))    # inner margins 

for (i in 1:length(iat_snet)) {   # (length(nw) - 1):length(nw)
  tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")
  plot(iat_snet[[i]],
         main = paste("t =",i,":", tspells[[i]]))
}
# dev.off()
```

```{r}
# t1-t6 bigger
# pdf("iat_plot_b.pdf", width = 9, height = 5)
# par(mfrow = c(1, 3),     # 1 row x 3 cols
#     oma = c(1,1,1,1),    # all sides 1 outer margin
#     mar = c(1,0,2,0))    # inner margins 

for (i in 1:length(iat_snet)) {   # (length(nw) - 1):length(nw)
  tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")
  plot(iat_snet[[i]],
         main = paste("t =",i,":", tspells[[i]]))
}
# dev.off()
```

```{r}
# t1-t6 collapsed into one big graph
# plot(iat_dyn,main='collapsed over all t',displaylabels=F)

# t1-t6 separately
# pdf("iat_dyn_plot.pdf", width = 9, height = 3)
# par(mfrow=c(1,3), # par(mfrow=c(1,2)) # only 2 per page = less cramped
#     oma=c(1,1,1,1), 
#     mar=c(1,0,2,0)) 

plot(network.extract(iat_dyn,onset=0,terminus=1),main='t1 (1993-1996)',displaylabels=F)
plot(network.extract(iat_dyn,onset=1,terminus=2),main='t2 (1997-2001)',displaylabels=F)
plot(network.extract(iat_dyn,onset=2,terminus=3),main='t3 (2002-2006)',displaylabels=F)
plot(network.extract(iat_dyn,onset=3,terminus=4),main='t4 (2007-2011)',displaylabels=F)
plot(network.extract(iat_dyn,onset=4,terminus=5),main='t5 (2012-2016)',displaylabels=F)
plot(network.extract(iat_dyn,onset=5,terminus=6),main='t6 (2017-2023)',displaylabels=F)
# dev.off()
```








### 3.2. Plot by t: scaled by outdegree

Plot similar to cf. lebacher 2021: 206, cf. Pamp 2021:7

For all plots, we need the network object AND the variable data we want to use to scale the nodes (e.g. outdegree). This can be retrieved from the adjacency matrix (e.g. degree) or from the covariate dataframe (e.g. gdp) or from the network directly as vertex or edge attribute (e.g. milex or tiv weight).

Directed binary network of arms trade by time spell. Nodes are scaled proportional to the logarithm of squared arms export measured in million TIV.

```{r}
## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[1]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY

# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[6]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY
```


```{r}
# check outdegree
rowSums(adj[rownames(adj) == "USA", , drop = FALSE])
rowSums(adj[rownames(adj) == "DEU", , drop = FALSE])
```

```{r}
# lay1 <- gplot.layout.fruchtermanreingold(adj,list(niter=1000,area=network.size(net)^2,repulse.rad=(network.size(net))^2*log(network.size(net))))
# 
# lay2 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^3,repulse.rad=(network.size(net))^3*log(network.size(net))))

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

# save(lay3, file = "charts/lay3.RData")
load("charts/lay3.RData")
```



#### t1
```{r}
pdf("charts/plot_t1.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[1]][1:157,1:157] # WEIGHTED
# adj <- iat_adj2$t1 # list elements not named, so this code not possible
# adj <- iat_adj_weight22[[1]] # WEIGHTED  1993
adj <- as.matrix(adj)
adj[adj>0]<-1 # BINARY


# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


```{r}
# dev.size("in")
# plot.network(net,
#              displayisolates=F,
#              displaylabels=T,
#              # label=network.vertex.names(net),
#              label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
#              label.cex=0.65,
#              label.pos = 5,
#              label.lwd = 0.3,
#              edge.lwd=0.5,
#              vertex.cex=cex_nodes, # retrieved from adj
#              vertex.col="gray",
#              edge.col="lightgray",
#              arrowhead.cex = 0.75,
#              # main = paste("t =",t,"(",tspells[[t]],")"),
#              # mode = "fruchtermanreingold"
#              coord = lay3
#              # niter=1000, # default = 500 = number of iterations
#              # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
#              # area=network.size(net)^2.5,
#              # # repulse.rad = 10 # Increase the repulsion radius
#              # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
# )

# ggsave("charts/NEU_p_nett1.png", width=7, height=7, dpi=300) #width=6.26, height=3.86
```


#### t2

```{r}
pdf("charts/plot_t2.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t2
# net <- iat_snet$t2 # at t2

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[2]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t2 %v% "iso",# net %v% "iso",iat_snet$t2 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```



#### t3
```{r}
pdf("charts/plot_t3.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t3
# net <- iat_snet$t3 # at t3

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[3]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY


# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t3 %v% "iso",# net %v% "iso",iat_snet$t3 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


#### t4
```{r}
pdf("charts/plot_t4.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t4
# net <- iat_snet$t4 # at t4

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[4]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY


# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t4 %v% "iso",# net %v% "iso",iat_snet$t4 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


#### t5
```{r}
pdf("charts/plot_t5.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t5
# net <- iat_snet$t5 # at t5

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[5]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY


# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t5 %v% "iso",# net %v% "iso",iat_snet$t5 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


#### t6
```{r}
pdf("charts/plot_t6.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t6
# net <- iat_snet$t6 # at t6

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[6]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY


# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             label= iat_snet$t6 %v% "iso",# net %v% "iso",iat_snet$t6 %v% "ln_milex"
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


```{r}
## FOR SPECIFIC TIME SPELL
# pdf("charts/plot_t6.pdf",width=20,height = 10) # w=15,h=15 / 30,20
# plot(net,
#      displayisolates=F,
#      displaylabels=T,
#      # label=network.vertex.names(net),
#      label= iat_snet$t6 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
#      label.cex=0.6, 
#      label.pos = 5,
#      edge.lwd=1,
#      vertex.cex=cex_nodes, # retrieved from adj
#      vertex.col="gray",
#      edge.col="lightgray",
#      # main = paste("t =",t,"(",tspells[[t]],")"),
#      mode = "fruchtermanreingold"
#      )
# dev.off()
```






#### time spells separately, in one wrapper
```{r}
## ALL TIME SPELLS
# pdf("charts/plot_all.pdf", width = 30, height = 20)
# par(mfrow = c(1, 2),     # rows x cols
#     oma = c(1,1,1,1),    # all sides 1 outer margin
#     mar = c(1,0,1,0))    # inner margins
# plot_all <- plot(net,
#       displayisolates=F,
#       displaylabels=T,
#       # label=network.vertex.names(net),
#       label= net %v% "iso",
#       label.cex=0.5, # 0.6
#       label.pos = 5,
#       edge.lwd=1,
#       vertex.cex=cex_nodes,
#       vertex.col="gray",
#       edge.col="lightgray",
#       main = paste("t =",t,"(",tspells[[t]],")"),
#       mode = "fruchtermanreingold"
#      )
# dev.off()
```



#### time spells collapsed
```{r}
# t1-t2
adj12 <- iat_adj2[[1]] + iat_adj2[[2]]
identical(adjpr,adj12)
adj34 <- iat_adj2[[3]] + iat_adj2[[4]]
adj56 <- iat_adj2[[5]] + iat_adj2[[6]]

# binary adj
adj12[adj12>0]<-1 
adj34[adj34>0]<-1 
adj56[adj56>0]<-1 

# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c 

colnames(adj12)<-iso
rownames(adj12)<-iso
colnames(adj34)<-iso
rownames(adj34)<-iso
colnames(adj56)<-iso
rownames(adj56)<-iso

# scaling: outdegree
cex_nodes1 <- 0.8+log(1+sqrt(rowSums(adj12)))
cex_nodes2 <- 0.8+log(1+sqrt(rowSums(adj34)))
cex_nodes3 <- 0.8+log(1+sqrt(rowSums(adj56)))

# adj to graph
net12 <- network(adj12) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")
net34 <- network(adj34) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")
net56 <- network(adj56) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

## other ways to get the graphs
# inet <- igraph::graph_from_adjacency_matrix(adj, mode = "directed", weighted = TRUE, diag = FALSE) # no loops, weighted T/F
# # Transform from igraph object to statnet's "network" class
# snet <- intergraph::asNetwork(inet)
```

```{r}
## FOR COLLAPSED TIME SPELL
# pdf("charts/plot_t12.pdf",width=20,height = 10) # w=15,h=15 / 30,20
plot_t12 <- plot(net12,
                 displayisolates=F,
                 displaylabels=T,
                 # label=network.vertex.names(net),
                 label= net %v% "iso",
                 label.cex=0.5, # 0.6
                 label.pos = 5,
                 edge.lwd=1,
                 vertex.cex=cex_nodes1,
                 vertex.col="gray",
                 edge.col="lightgray",
                 # main = paste("t =",t,"(",tspells[[t]],")"),
                 main = paste("iat 1993-2001"),
                 mode = "fruchtermanreingold"
)
# dev.off()
```

##### ggraph
```{r}
# pak::pak('thomasp85/ggraph')
# library(ggraph)
# library(tidygraph)

# # Create graph of highschool friendships
# graph <- as_tbl_graph(highschool) %>% 
#     mutate(Popularity = centrality_degree(mode = 'in'))
# 
# # plot using ggraph
# ggraph(graph, layout = 'kk') + 
#     geom_edge_fan(aes(alpha = after_stat(index)), show.legend = FALSE) + 
#     geom_node_point(aes(size = Popularity)) + 
#     facet_edges(~year) + 
#     theme_graph(foreground = 'steelblue', fg_text_colour = 'white')
```




### 3.3. Plot by t: Scaled by covariates

```{r}
## e.g. gdp category (lower 25%, middle 50%, upper 25%)
palette(gray.colors(2,0,1))
plot(iat_snet[[1]], vertex.col = 'cat_gdp',vertex.cex = iat_deg1/6)
```

Scaled by 
```{r}
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT T6
net <- iat_snet$t6 # at t6

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

## USE ADJ DIRECTLY
# adj<-iat_adj2[[t-1993]][1:157,1:157] # YEARLY NETWORKS
adj <- iat_adj2[[6]][1:157,1:157] # WEIGHTED
adj[adj>0]<-1 # BINARY

# # turn adj to network
# net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# retrieve country codes from cov df
iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
colnames(adj)<-iso
rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# scale nodes by outdegree
cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# # cex_nodes <- 0.8+log(1+sqrt(rowSums(net))) # outdegree
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree

```

```{r}
## FOR SPECIFIC TIME SPELL
# pdf("charts/plot_t6.pdf",width=20,height = 10) # w=15,h=15 / 30,20
plot_t6 <- plot(net,
                displayisolates=F,
                displaylabels=T,
                # label=network.vertex.names(net),
                label= net %v% "iso",
                label.cex=0.5, # 0.6
                label.pos = 5,
                edge.lwd=1,
                vertex.cex=cex_nodes, # retrieved from adj
                vertex.col="gray",
                edge.col="lightgray",
                main = paste("t =",t,"(",tspells[[t]],")"),
                mode = "fruchtermanreingold"
)
# dev.off()
```



## 3.4. Plot by year: scaled by outdegree



### a) prep data

#### dyad-year level
```{r}
library(dplyr)
names(iat.pcw)

# aggregated to dyad-t (from dyad-year level)
# iat_t_agg <- iat_year_agg %>%
# iat_t_agg2 <- iat.pcw %>%
#   group_by(iso1, iso2, un1, un2, cown1, cown2, state1h, state2h, dyad_name, year) %>%
#   dplyr::summarise(
#     tiv = mean(tiv, na.rm = T), # av. yearly tiv during t
#     # category = paste(unique(category), collapse = ", ")
#     ) %>% 
#   dplyr::select(state1h,state2h,tiv,t,everything()) %>% 
#   dplyr::arrange(t,state1h,state2h) %>% 
#   ungroup()
```
@nga: 4769 dyads

```{r}
# label(iat_t_agg$tiv) <- "av. yearly total tiv (in million) during t"
```


Examine
```{r}
# OLD CODE: By dyad-year
iat_year_agg %>%
  dplyr::filter(dyad_name == "Germany-Israel") %>%
  dplyr::select(dyad_name,year,tiv,everything())
# We see now that the delivery values for 2000 were summed up together, i.e. tiv = 271
# # We see that in 2000, Germany made 3 weapons delivieries to Israel (deal_ids = 25546, 37437, 28948), with an estimated trend indicator value (tiv) of 271
```

```{r}
library(magrittr)
library(dplyr)
library(tidyr)
# By dyad-t
iat_t_agg %>% 
  dplyr::filter(dyad_name == "Germany_Israel") %>% 
  dplyr::select(dyad_name,t,tiv,everything())
# We see that after the end of the cold war, Germany delivered weapons with the highest value during the t5 time period, with a tiv of ca. 172 million tiv
tspells[[5]] # which is 2013-2017
```



#### el
```{r}
## edge list
iat_el2 <- iat.pcw %>%
  # ungroup() %>%
  dplyr::select(iso1,iso2,tiv,year) %>% # state1h,state2h,
  dplyr::rename(weight = tiv) # yearly trend indicator value of arms transfer delivery
```

```{r}

# Create a list containing iat data frames split by year
iat_list2 <- split(iat_el2, iat_el2$year) 
iat_list2 <- lapply(iat_list2, function(i) {
  dplyr::select(i, -year)
})

```

```{r}
# save(iat_list2, file = "7_objects/iat_list2.RData")
load("7_objects/iat_list2.RData")
```



#### adj
```{r}
# library(igraph)

# Initialize empty lists to store the adjacency matrices
iat_adj_weight22 <- list()
iat_adj_binary22 <- list()

# Loop over each edge list in iat_list
for(i in 1:length(iat_list2)) {
  # Convert the edge list to a graph
  g <- igraph::graph_from_data_frame(iat_list2[[i]], directed = T)
  
  # Convert the graph to a weighted adjacency matrix
  adj_weight <- igraph::as_adjacency_matrix(g, attr = "weight")
  adj_weight <- round(adj_weight, 4) # round to 2 decimals
  
  # Create a binary matrix version
  adj_binary <- adj_weight
  adj_binary[adj_binary != 0] <- 1
  
  # Save the adjacency matrices to lists
  iat_adj_weight22[[names(iat_list2)[i]]] <- adj_weight
  iat_adj_binary22[[names(iat_list2)[i]]] <- adj_binary
}

```

check iat adj
```{r}
View(as.matrix(iat_adj_weight22$`1993`)) # or iat_adj_weight22[[1]]
View(as.matrix(iat_adj_binary22$`1993`))

View(as.matrix(iat_adj_weight22$`2023`)) # or iat_adj_weight22[[31]]
View(as.matrix(iat_adj_binary22$`2023`))
```

```{r}
dim(iat_adj_weight22[[1]]) # 1993
rownames(iat_adj_weight22[[1]]) # 1993

dim(iat_adj_weight22[[31]]) # 2023
rownames(iat_adj_weight22[[31]]) # 2023
```


```{r}
# save(iat_adj_weight22, file = "7_objects/iat_adj_weight22.RData")
load("7_objects/iat_adj_weight22.RData")

# save(iat_adj_binary22, file = "7_objects/iat_adj_binary22.RData")
load("7_objects/iat_adj_binary22.RData")

```



#### [dropped: add isolates]

```{r}
load("un_members.RData")
# un_mlist <- un_members  %>% distinct(state, iso, .keep_all = TRUE)
# save(un_mlist, file = "un_mlist.RData")
load("un_mlist.RData")
```



```{r}
## DOES NOT WORK. CANNOT ADD ISOLATES TO MATRICES

# # Create empty list to store the imputed adjacency matrices
# iat_adj_imp22 <- list()
# iat_adj_imp22_df <- list()
# 
# # Loop over the arms transfer adj matrices and add isolates
# for (i in 1:31) {
#   
#   # identify missing nodes
#   missing_nodes <- dplyr::setdiff(as.character(un_mlist), rownames(iat_adj_weight22[[i]]))
#   
#   # create matrix
#   iat_adj_imp22[[i]] <- rbind(
#     cbind(iat_adj_weight22[[i]], 
#           matrix(0, 
#                  nrow = nrow(iat_adj_weight22[[i]]), 
#                  ncol = length(missing_nodes))), 
#     cbind(matrix(0, 
#                  nrow = length(missing_nodes), 
#                  ncol = ncol(iat_adj_weight22[[i]])), 
#           matrix(0, 
#                  nrow = length(missing_nodes), 
#                  ncol = length(missing_nodes))))
#   
#   rownames(iat_adj_imp22[[i]]) <- colnames(iat_adj_imp22[[i]]) <- c(rownames(iat_adj_weight22[[i]]), missing_nodes)
#   
#   # Convert sparse matrix to regular matrix
#   iat_adj_imp22[[i]] <- as.matrix(iat_adj_imp22[[i]])
#   
#   # Convert to a data frame
#   iat_adj_imp22_df[[i]] <- as.data.frame(iat_adj_imp22[[i]])
# }

```



#### weighted graph (inet & snet)

```{r}
# library(igraph)
# library(statnet)
# library(intergraph)

# initialize 2 empty list objects, one for inet and one for snet
iat_inet_year <- list() 
iat_snet_year <- list() 

# Loop over network list elements
for(i in 1:length(iat_adj_weight22)) {
  library(igraph)
  
  ## Get adj matrix
  adj <- iat_adj_weight22[[i]]
  
  ## Turn to graph object from data frame edge list
  inet <- igraph::graph_from_adjacency_matrix(adj, mode = "directed", weighted = TRUE, diag = FALSE) # weighted, no loops
  
  ## Transform from igraph object to statnet's "network" class
  snet <- intergraph::asNetwork(inet)
  
  ## save inet
  iat_inet_year[[paste0("y_", 1992+i)]] <- inet
  ## save snet
  iat_snet_year[[paste0("y_", 1992+i)]] <- snet
  
}

```

```{r}
# igraph
View(get.adjacency(iat_inet_year$y_1993, attr = "weight", sparse = FALSE))

# statnet
View(as.matrix.network(iat_snet_year$y_1993, matrix.type = "adjacency", sparse = FALSE)) # binary
View(as.matrix.network(iat_snet_year$y_1993, matrix.type = "adjacency", attrname = "weight", sparse = FALSE)) # with weights

```


```{r}
# save(iat_inet_year, file = "iat_inet_year.RData")
load("iat_inet_year.RData")

# save(iat_snet_year, file = "iat_snet_year.RData")
load("iat_snet_year.RData")

```



#### add covs to networks
```{r}
# View(cov_net$t1)
## same in both cov_net and iat_inet
# igraph::V(iat_inet_year$y_1993)$iso <- cov_net2$y_1993$iso
# cov_net2$y_1993$iso
# iat_inet_year$y_1993
```






#### [dropped: binary adj]

NOT IN USE:
  ```{r}
# initialize 2 empty list objects, one for inet and one for snet
iat_inet_nocov.bin <- list() # iat binary igraph networks without node attributes
iat_snet_nocov.bin <- list() # iat binary statnet networks without node attributes

# Loop over network list elements
for(i in 1:length(iat_adj2.bin)) {
  library(igraph)
  
  ## Get adj matrix
  adj <- iat_adj2.bin[[i]]
  
  ## Turn to graph object from data frame edge list
  inet <- igraph::graph_from_adjacency_matrix(adj, mode = "directed", weighted = FALSE, diag = FALSE) # binary, no loops
  
  ## Transform from igraph object to statnet's "network" class
  snet <- intergraph::asNetwork(inet)
  
  ## save inet
  iat_inet_nocov.bin[[paste0("t", i)]] <- inet
  ## save snet
  iat_snet_nocov.bin[[paste0("t", i)]] <- snet
  
}
```

```{r}
View(get.adjacency(iat_inet_nocov.bin$t6, sparse = FALSE)) # binary
View(get.adjacency(iat_inet_nocov$t6, sparse = FALSE)) # binary view in weighted network
View(get.adjacency(iat_inet_nocov$t6, attr = "weight", sparse = FALSE)) # weighted
```

```{r}
# save(iat_inet_nocov.bin, file = "iat_inet_nocov.bin.RData")
# load("iat_inet_nocov.bin.RData")

# save(iat_snet_nocov.bin, file = "iat_snet_nocov.bin.RData")
# load("iat_snet_nocov.bin.RData")
```




### b) plot yearly graphs

https://www.kateto.net/wp-content/uploads/2015/06/Polnet%202015%20Network%20Viz%20Tutorial%20-%20Ognyanova.pdf
```{r}
## FOR SPECIFIC TIME SPELL
# pdf("charts/plot_1993.pdf",width=20,height = 10) # w=15,h=15 / 30,20
# plot(net,
#      displayisolates=F,
#      displaylabels=T,
#      # label=network.vertex.names(net),
#      label= iat_snet$t6 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
#      label.cex=0.6, 
#      label.pos = 5,
#      edge.lwd=1,
#      vertex.cex=cex_nodes, # retrieved from adj
#      vertex.col="gray",
#      edge.col="lightgray",
#      # main = paste("t =",t,"(",tspells[[t]],")"),
#      mode = "fruchtermanreingold"
#      )
# dev.off()
```


```{r}
library(extrafont)
library(RColorBrewer)
display.brewer.all()
display.brewer.pal(8, "Set3")
display.brewer.pal(8, "Blues")
# in plots
pal3 <- brewer.pal(10, "Set3")
plot(x=10:1, y=10:1, pch=19, cex=4, col=pal3)

```


(Code adapted from cf. lebacher 2021: 206, cf. Pamp 2021:7)

For all plots, we need the network object AND the variable data we want to use to scale the nodes (e.g. outdegree). This can be retrieved from the adjacency matrix (e.g. degree) or from the covariate dataframe (e.g. gdp) or from the network directly as vertex or edge attribute (e.g. milex or tiv weight).

Directed binary network of arms trade by time spell. Nodes are scaled proportional to the logarithm of squared arms export measured in million TIV.

```{r}
# adj is retrived from iat_adj2 (or yearly version of it)
adj <- iat_adj_binary22$`1993` # yearly version
View(as.matrix(iat_adj_binary22$`1993`))
adj <- as.matrix(adj) # transform into regular base matrix


# check outdegree
rowSums(adj[which(rownames(adj) == "USA"), , drop = FALSE])
rowSums(adj[which(rownames(adj) == "DEU"), , drop = FALSE])

```

```{r}
# lay1 <- gplot.layout.fruchtermanreingold(adj,list(niter=1000,area=network.size(net)^2,repulse.rad=(network.size(net))^2*log(network.size(net))))
# 
# lay2 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^3,repulse.rad=(network.size(net))^3*log(network.size(net))))

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))
```



#### 1993

TEMPLATE PLOT 
```{r}
# pdf("charts/plot_1993bbb.pdf",width=25,height = 15) # width=20,height = 10; 20/15
# ## DEFINE TIME SPELLS
# # tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")
# 
# ## EXTRACT NETWORK, e.g. AT t1
# # net <- iat_snet$t1 # at t1
# 
# ## EXTRACT ADJ FROM NETWORK
# # adj <- as.matrix(net) # BINARY
# # adj <- as.matrix(net, attrname = "weight") # WEIGHTED
# 
# # load("iat_adj2.RData")
# ## USE ADJ DIRECTLY
# # adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED
# 
# # load("iat_snet_year.RData")
# # iat_snet_year$y_1993 # graph object
# 
# adj <- iat_adj_binary22$`1993` # WEIGHTED  1993
# # adj <- iat_adj_weight22[[1]] # WEIGHTED  1993
# adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
# adj[adj>0]<-1 # BINARY
# 
# # retrieve country codes from cov df
# # iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# # colnames(adj)<-iso
# # rownames(adj)<-iso
# # colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# # rownames(adj)<-cov_complete_list[[t]][1:157,3]
# 
# # Define the Adjacency Matrix as Network
# net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")
# 
# # scale nodes by outdegree
# # cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# # cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# # cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# # cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# 
# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))
# 
# 
# plot.network(net,
#              displayisolates=F,
#              displaylabels=T,
#              # label=network.vertex.names(net),
#              # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
#              label = iat_snet_year$y_1993 %v% "vertex.names",
#              label.cex=0.65,
#              label.pos = 5,
#              label.lwd = 0.3,
#              vertex.label.family="Arial Black",
#              vertex.cex=cex_nodes, # retrieved from adj
#              vertex.col="gray",
#              vertex.size=30,
#              edge.lwd=1,
#              edge.col="lightgray",
#              arrowhead.cex = 0.75,
#              # main = paste("t =",t,"(",tspells[[t]],")"),
#              # mode = "fruchtermanreingold"
#              coord = lay3
#              # niter=1000, # default = 500 = number of iterations
#              # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
#              # area=network.size(net)^2.5,
#              # # repulse.rad = 10 # Increase the repulsion radius
#              # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
# )
# 
# 
# # l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# # plot(g,layout=l)
# # tkplot(G, layout=L)
# # L = tkplot.getcoords(1)
# dev.off()

```

##### benutzt

```{r}
## coordinates for 1993.2003,2013,2023
# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))
```


```{r}
pdf("charts/plot_1993bb.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

# load("iat_snet_year.RData")
# iat_snet_year$y_1993 # graph object

adj <- iat_adj_binary22$`1993` # WEIGHTED  1993
# adj <- iat_adj_weight22[[1]] # WEIGHTED  1993
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

### scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree bb3
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree bb2
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree MAINMAINMAINMAIN bb
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj))) # outdegree bb4
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree bb5
# cex_label<-cex_nodes

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_1993 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5, # 1
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


```{r}
# dev.size("in")
# plot.network(net,
#              displayisolates=F,
#              displaylabels=T,
#              # label=network.vertex.names(net),
#              label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
#              label.cex=0.65,
#              label.pos = 5,
#              label.lwd = 0.3,
#              edge.lwd=0.5,
#              vertex.cex=cex_nodes, # retrieved from adj
#              vertex.col="gray",
#              edge.col="lightgray",
#              arrowhead.cex = 0.75,
#              # main = paste("t =",t,"(",tspells[[t]],")"),
#              # mode = "fruchtermanreingold"
#              coord = lay3
#              # niter=1000, # default = 500 = number of iterations
#              # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
#              # area=network.size(net)^2.5,
#              # # repulse.rad = 10 # Increase the repulsion radius
#              # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
# )

# ggsave("charts/NEU_p_nett1.png", width=7, height=7, dpi=300) #width=6.26, height=3.86
```


#### 2003

```{r}
summary(net)
```


##### benutzt
```{r}
pdf("charts/plot_2003bb.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("2003-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

# load("iat_snet_year.RData")
# iat_snet_year$y_2003 # graph object

adj <- iat_adj_binary22$`2003` # WEIGHTED  2003
# adj <- iat_adj_weight22[[1]] # WEIGHTED  2003
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
cex_label<-cex_nodes

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2003 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5, # 1
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```



```{r}
pdf("charts/plot_2003b.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

adj <- iat_adj_binary22$`2003` # WEIGHTED  1993
# adj <- iat_adj_weight22[[1]] # WEIGHTED  1993
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2003 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```



#### 2013

```{r}
iat_snet_year$y_2013 # 122
iat_adj_weight22$`2013`
```


```{r}
library(Matrix)
pdf("charts/plot_2013.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

adj <- iat_adj_weight22[[11]] # WEIGHTED  2003
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2013 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```



```{r}
pdf("charts/plot_2013b.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

adj <- iat_adj_binary22$`2013` # WEIGHTED  1993
# adj <- iat_adj_weight22[[1]] # WEIGHTED  1993
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2013 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


```{r}

lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

pdf("charts/plot_2013b.pdf",width=25,height = 15) # width=20,height = 10; 20/15
adj <- iat_adj_binary22$`2013`
adj <- as.matrix(adj) 
adj[adj>0]<-1 # BINARY
# Define the Adjacency Matrix as Network
net <- network(adj)
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2013 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
)


dev.off()

```

##### benutzt
```{r}
pdf("charts/plot_2013bb.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("2013-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

# load("iat_snet_year.RData")
# iat_snet_year$y_2013 # graph object

adj <- iat_adj_binary22$`2013` # WEIGHTED  2013
# adj <- iat_adj_weight22[[1]] # WEIGHTED  2013
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2013 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5, # 1
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```




#### 2023

```{r}
pdf("charts/plot_2023.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("1993-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

adj <- iat_adj_weight22$`2023` # WEIGHTED  2023
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
cex_label<-cex_nodes

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2023 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5,
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```

##### benutzt
```{r}
pdf("charts/plot_2023bb.pdf",width=25,height = 15) # width=20,height = 10; 20/15
## DEFINE TIME SPELLS
# tspells <- c("2023-1996","1997-2001","2002-2006","2007-2011","2012-2016","2017-2023")

## EXTRACT NETWORK, e.g. AT t1
# net <- iat_snet$t1 # at t1

## EXTRACT ADJ FROM NETWORK
# adj <- as.matrix(net) # BINARY
# adj <- as.matrix(net, attrname = "weight") # WEIGHTED

# load("iat_adj2.RData")
## USE ADJ DIRECTLY
# adj2 <- iat_adj2[[1]][1:157,1:157] # WEIGHTED

# load("iat_snet_year.RData")
# iat_snet_year$y_2023 # graph object

adj <- iat_adj_binary22$`2023` # WEIGHTED  2023
# adj <- iat_adj_weight22[[1]] # WEIGHTED  2023
adj <- as.matrix(adj) # Set the row and column names from the Dimnames of adj rownames(numeric_matrix) <- rownames(adj) colnames(numeric_matrix) <- colnames(adj)
adj[adj>0]<-1 # BINARY

# retrieve country codes from cov df
# iso <- cov_complete$iso3c %>% unique() # cov_complete_list[[1]]$iso3c
# colnames(adj)<-iso
# rownames(adj)<-iso
# colnames(adj)<-cov_complete_list[[t]][1:157,3] # column 3 = iso3c
# rownames(adj)<-cov_complete_list[[t]][1:157,3]

# Define the Adjacency Matrix as Network
net <- network(adj) # for igraph = graph_from_adjacency_matrix(iat, mode = "directed")

# scale nodes by outdegree
# cex_nodes <- 0.4+log(0.15+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.3+log(0.1+sqrt(rowSums(adj))) # outdegree
cex_nodes <- 0.8+log(0.1+sqrt(rowSums(adj))) # outdegree
# cex_nodes <- 0.8+log(1+sqrt(rowSums(adj)))
# cex_nodes <- 1.5+rowSums(adj)*0.04 # outdegree
# cex_label<-cex_nodes

# lay3 <- gplot.layout.fruchtermanreingold(adj,list(niter=3000,area=network.size(net)^4,repulse.rad=(network.size(net))^4*log(network.size(net))))

plot.network(net,
             displayisolates=F,
             displaylabels=T,
             # label=network.vertex.names(net),
             # label= iat_snet$t1 %v% "iso",# net %v% "iso",iat_snet$t1 %v% "ln_milex"
             label = iat_snet_year$y_2023 %v% "vertex.names",
             label.cex=0.65,
             label.pos = 5,
             label.lwd = 0.3,
             edge.lwd=0.5, # 1
             vertex.cex=cex_nodes, # retrieved from adj
             vertex.col="gray",
             edge.col="lightgray",
             arrowhead.cex = 0.75,
             # main = paste("t =",t,"(",tspells[[t]],")"),
             # mode = "fruchtermanreingold"
             coord = lay3
             # niter=1000, # default = 500 = number of iterations
             # # area=log(network.size(net)), # Increase the area parameter 2000; net$gal$n^2.5
             # area=network.size(net)^2.5,
             # # repulse.rad = 10 # Increase the repulsion radius
             # repulse.rad=(network.size(net)^2.5*log(network.size(net)))
)

# l <- layout.fruchterman.reingold(g,niter=500,area=vcount(g)^2.3,repulserad=vcount(g)^2.8)
# plot(g,layout=l)
# tkplot(G, layout=L)
# L = tkplot.getcoords(1)
dev.off()

```


## 3.5. [dropped: spherical]


```{r}
# lay4 <- igraph::layout.circle(iat_inet$t1)
# plot(iat_inet$t1, layout=lay4)
```


# IV) OTHER NETWORK PLOTS

## a) ggraph

https://schochastics.github.io/netVizR/



## b) interactive



# V) TABLES

## 5.1. TABLE 1: Descriptive stats at graph level

-   power law/scale-free? Or just heavy tailed
-   Barabasi-Albert: growth & preferential attachment (for directed nw) (L9, p. 22). Looks scale-free?
-   Small world

### packages
```{r}
library(gt)
library(gtExtras)
library(scales)
library(kableExtra)
library(stargazer)
library(knitr)
library(webshot2)
```


### glob stats df
```{r} 
library(knitr)
library(kableExtra)
## Data
glob_stats <- glob_df %>%
  select(2:10,36,37) %>%
  rename(`Time spell` = time,
         Edges = edges,
         `Av. Path Length` = avpath,
         Diameter = diameter,
         Isolates = isolates,
         Density = density,
         `Components` = components,
         Reciprocity = reciprocity,
         Transitivity = transitivity,
         Triangles = triangle,
         `Cyclic triples` = ctriple) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  mutate(Diameter = round(Diameter,2),
         `Av. Path Length` = round(`Av. Path Length`,2)) %>% 
  select(`Time spell`,Edges,Isolates,Components,Density,Reciprocity,Transitivity,Diameter,`Av. Path Length`,everything())

```





#### stargazer (latex)
```{r}
stargazer(glob_stats) # latex table
```



#### kable

```{r}
library(webshot2)
library(knitr)
library(magick)
library(modelsummary)
library(dplyr)
library(fixest)
# webshot("charts/tbl_glob1.html", "charts/tbl_glob1.pdf")
```


```{r}
glob_stats_fn <- glob_stats
colnames(glob_stats_fn)[4] <- paste0("Components",
                                     footnote_marker_number(3))

## TBL 1
tbl_glob1 <- glob_stats_fn %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Global Network Statistics: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 11) %>%
  row_spec(0, color = "black", bold =T, font_size = 11, background = "lightgray") %>%
  # column_spec(1, color = "black", bold =T) %>%
  column_spec(1, color = "black", bold =T) %>% # , width = "2.7cm"
  # column_spec(2:6, width = "1.8cm") %>%
  # add_footnote(.,
  #          c("N = 157 across the 6 networks",
  #            "Data source: SIPRI Arms Transfers Database (2023)",
  #            "Components here refers to strong components"),notation = "number") %>% #
  footnote(number = c("N = 157 across the 6 networks", 
                        "Data source: SIPRI Arms Transfers Database (2023)",
                        "Reference to strong components")) %>% 
  gsub("font-size: initial !important;", 
       "font-size: 11pt !important; font-weight: bold !important;", 
         .)

tbl_glob1
tbl_glob1 %>% save_kable("charts/tbl_glob1.html")
webshot("charts/tbl_glob1.html", "charts/tbl_glob1.pdf")
# webshot("charts/tbl_glob1.html", "charts/tbl_glob1.png")

# save(tbl_glob1, file = "charts/tbl_glob1.RData")
# load("charts/tbl_glob1.RData")
```

```{r}
# tbl_glob2 <- kable(glob_stats, 
#                    caption = "Global network statistics: International arms transfers (1993-2023)",
#                    booktabs=TRUE, align = "c", color = "black") %>%
#   # kable_classic() %>%
#   # kable_styling(bootstrap_options = c("striped", "hover")) %>%
#   kable_styling(table.envir="ctable", bootstrap_options = "striped", font_size=12) %>% #table.envir = "capctable"
#   row_spec(0, color = "black") %>% #bold = T, background = "lightgray"
#   # row_spec(1, color = "red") %>%
#   # as_image(width = 8) %>% 
#   add_footnote(.,c("n = 157 across the 6 networks","Data source: SIPRI Arms Transfers Database (2023)"))
# 
# tbl_glob2
```


```{r}
## TBL 2
# kable(glob_stats, "latex", booktabs = T) %>%
# kable(glob_stats, "html") %>%
# kable(head(glob_stats),"html") %>% 

# tbl_glob2 <- kable(glob_stats, 
#                    caption = "Global network statistics: International arms transfers (1993-2023)",
#                    booktabs=TRUE, bold = T, align = "c", color = "black") %>%
#   # kable_classic() %>%
#   # kable_styling(bootstrap_options = c("striped", "hover")) %>%
#   kable_styling(table.envir="ctable", bootstrap_options = "striped", font_size=12) %>% #table.envir = "capctable"
#   row_spec(0, color = "black") %>% # ,background = "#e0e0e0"
#   column_spec(1:ncol(glob_stats), bold = TRUE, color = "black") %>% #, background = "lightgray"
#   # row_spec(1, color = "red") %>%
#   # as_image(width = 8) %>% 
#   add_footnote(.,c(
#     "n = 157 across the 6 networks",
#     "Data source: SIPRI Arms Transfers Database (2023)"))
# 
# tbl_glob2
# tbl_glob2 %>% save_kable("charts/tbl_glob2.html")

# save(tbl_glob2, file = "charts/tbl_glob2.RData")
# load("charts/tbl_glob2.RData")
```

```{r}
## FOOTNOTES
  # footnote(.,general_title = "Note.", 
  #          alphabet = c("a","b","c"),
  #          # threeparttable = T,
  #          c("n = 157 across the 6 networks","Data source: SIPRI Arms Transfers Database (2023)","Statistics calculated by the author"))


# dt <- mtcars[1:5, 1:5]
# colnames(dt)[1] <- paste0("mpg",
#                           footnote_marker_alphabet(2))
# rownames(dt)[2] <- paste0(rownames(dt)[2],
#                           footnote_marker_alphabet(1))
# dt[1,2] <- paste0(dt[1,2], footnote_marker_alphabet(3))
# 
# kbl(dt, escape = FALSE) %>% 
#   kable_classic() %>% 
#   footnote(alphabet = c("Note a", "Note b", "Note c"))

```


#### APA style
https://cran.r-project.org/web/packages/rempsyc/vignettes/table.html
https://apastyle.apa.org/style-grammar-guidelines/tables-figures/tables

```{r}
library(rempsyc)
library(flextable)
library(report)
# pkgs <- c("flextable", "report")
# install_if_not_installed(pkgs)
# library(xtable) # export to tex code

## TBL 3
## APA
tbl_glob3 <- nice_table(
    glob_stats,
    title = c("Table 1", "Global network statistics: international arms transfers (1993-2023)"),
    note = c("N = 157 across the 6 networks",
             "Data source: SIPRI Arms Transfers Database (2023)"))
tbl_glob3

# save(tbl_glob3, file = "charts/tbl_glob3.RData")
# load("charts/tbl_glob3.RData")
# print(tbl_glob2, preview = "docx")
# flextable::save_as_docx(my_table, path = "nice_tablehere.docx")
```


#### gt
```{r}
# Global network stats
tbl_glob4 <- glob_stats %>%
  # select(2:10) %>%
  mutate_if(is.numeric, round, 3) %>%
  gt() %>%
  # cols_label(time = "Time Spell", 
  #            edges = "Edges",
  #            avpath = "Av. Path Length",
  #            diameter = "Diameter",
  #            isolates = "Isolates",
  #            density = "Density",
  #            components = "Components",
  #            reciprocity = "Reciprocity",
  #            transitivity = "Transitivity") %>%
  tab_options(heading.title.font.size = px(10)) %>% # font size of the title
  tab_header(
    title = "Global network statistics: International arms transfers (1993-2023)"
    # ,cell_text(size = px(15))
    ) %>% 
    # ,subtitle = "International Weapons Transfer Network (1993-2023)"
  tab_style(style = cell_text(size = px(15), color ="black"), 
            locations = cells_title(groups = "title")) %>% # title font size
  # tab_style(style = cell_fill(color = "lightgrey"),
  #           locations = cells_column_labels(columns = everything()) ) %>% 
  tab_style(style = cell_fill(color = "lightgrey"), 
            locations = cells_column_labels(columns = everything()) ) %>%   
    tab_style(style = cell_text(size = px(12), color ="black"),  
            locations = cells_column_labels(columns = everything()) ) %>%  
  tab_source_note(md(c("N = 157 for all 6 networks. Data source: SIPRI Arms Transfers Database (2023)"))) %>%
  gt_theme_pff()

tbl_glob4
# save(tbl_glob4, file = "charts/tbl_glob4.RData")
# load("charts/tbl_glob4.RData")
# gtsave(tbl_glob4, "charts/tbl_glob4.pdf")
```


### global centralization

```{r}
glob_stats_cent <- glob_df %>%
  select(2,11:15) %>%
  rename(`Time spell` = time,
         Degree = degree,
         Indegree = indegree,
         Outdegree = outdegree,
         Eigenvector = eigenvector,
         Betweenness = betweenness) %>%
  mutate_if(is.numeric, round, 3)
```

```{r}
tbl_glob_cent2 <- glob_stats_cent %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Centralization Statistics: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 11) %>%
  # add_header_above(c("","Centralization Statistics" = 5)) %>%
  row_spec(0, color = "black", bold =T, font_size = 11, background = "lightgray") %>%
  column_spec(1, color = "black", bold =T, width = "2.7cm") %>%
  column_spec(2:6, width = "1.8cm") %>%
  # add_footnote(.,
  #          c("N = 157 across the 6 networks",
  #            "Data source: SIPRI Arms Transfers Database (2023)")) %>% #, notation = "number"
  footnote(number = c("N = 157 across the 6 networks", 
                      "Data source: SIPRI Arms Transfers Database (2023)")) %>% 
  gsub("font-size: initial !important;", 
         "font-size: 11pt !important; font-weight: bold !important;", 
         .)

tbl_glob_cent2
tbl_glob_cent2 %>% save_kable("charts/tbl_glob_cent2.html")
webshot("charts/tbl_glob_cent2.html", "charts/tbl_glob_cent2.pdf")
# webshot("charts/tbl_glob_cent2.html", "charts/tbl_glob_cent2.png")

# save(tbl_glob_cent2, file = "charts/tbl_glob_cent2.RData")
# load("charts/tbl_glob_cent2.RData")
```

```{r}
## USING GT
# tbl_glob_cent2 <- 
# glob_stats_cent %>% 
#   gt() %>%
#   # cols_label(time = "time spell") %>%
#   # tab_options(heading.title.font.size = px(10)) %>%
#   tab_header(
#     title = "Centralization measures, t1 - t6",
#     subtitle = "International Weapons Transfer Network (1993-2023)"
#     ) %>%
#   tab_source_note(md(c("N = 157 across the 6 networks; Data source: SIPRI Arms Transfers Database (2023)"))) %>%
#   gt_theme_pff()
```




### global dyad census
```{r}
# Census dyads
glob_stats_dyad <- glob_df %>%
  select(2,17:19) %>%
  rename(`Time spell` = time,
         `Mutual` = dyad_mut,
         `Asymmetric` = dyad_asym,
         `None` = dyad_null) #%>%
  # mutate_if(is.numeric, round, 3)#

```

```{r}
library(kableExtra)
library(webshot2)
tbl_glob_dyad <- glob_stats_dyad %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Dyad Census: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 11) %>%
  # add_header_above(c("","Centralization Statistics" = 5)) %>%
  row_spec(0, color = "black", bold =T, font_size = 11, background = "lightgray") %>%
  column_spec(1, color = "black", bold =T, width = "2.7cm") %>% #, width = "2.7cm"
  column_spec(2:4, width = "2cm") %>%
  # add_footnote(.,
  #              c("N = 157 across the 6 networks",
  #                "Data source: SIPRI Arms Transfers Database (2023)")) %>% #,notation = "number"
  footnote(number = c("N = 157 across the 6 networks", 
                      "Data source: SIPRI Arms Transfers Database (2023)")) %>% 
  gsub("font-size: initial !important;", 
       "font-size: 11pt !important; font-weight: bold !important;", 
       .)

tbl_glob_dyad
tbl_glob_dyad %>% save_kable("charts/tbl_glob_dyad.html")
webshot("charts/tbl_glob_dyad.html", "charts/tbl_glob_dyad.pdf")
# webshot("charts/tbl_glob_dyad.html", "charts/tbl_glob_dyad.png")

# save(tbl_glob_dyad, file = "charts/tbl_glob_dyad.RData")
# load("charts/objects/tbl_glob_dyad.RData")
```




```{r}
# Census dyads
# glob_df %>%
#   select(2,17:19) %>%
#   # mutate_if(is.numeric, round, 3) %>%
#   gt() %>%
#   cols_label(time = "time spell",
#              dyad_mut = "mutual tie",
#              dyad_asym = "asymmetric tie",
#              dyad_null = "no tie") %>%
#   # tab_options(heading.title.font.size = px(10)) %>%
#   tab_header(
#     title = "Dyads census, t1 - t6",
#     subtitle = "International Weapons Transfer Network (1993-2023)"
#     ) %>%
#   tab_source_note(md("N = 157 for all 6 networks; data: *SIPRI 2023*")) %>%
#   gt_theme_pff()
```




### global triad census


```{r}
names(glob_stats_triad)
glob_stats_triad <- glob_df %>%
  dplyr::select(2,20:35) %>%
  dplyr::rename(`Time spell` = time,
         `003` = triad_003,
         `012` = triad_012,
         `102` = triad_102,
         `021D` = triad_021D
         ,`021U` = triad_021U
         ,`021C` = triad_021C
         ,`111D` = triad_111D
         ,`111U` = triad_111U
         ,`030T` = triad_030T
         ,`030C` = triad_030C
         ,`201` = triad_201
         ,`120D` = triad_120D
         ,`120U` = triad_120U
         ,`120C` = triad_120C
         ,`210` = triad_210
         ,`300` = triad_300
         ) #%>%

  # mutate_if(is.numeric, round, 3)
```

```{r}
tbl_glob_triad <- glob_stats_triad %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Triad Census: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 9.5) %>%
  # add_header_above(c("","Centralization Statistics" = 5)) %>%
  row_spec(0, color = "black", bold =T, font_size = 10, background = "lightgray") %>%
  column_spec(1, color = "black", bold =T) %>% #, width = "2.7cm"
  column_spec(2:17, color = "black", bold =F) %>% #, width = "1.8cm"
  # add_footnote(.,
  #              c("N = 157 across the 6 networks",
  #                "Data source: SIPRI Arms Transfers Database (2023)")) %>% #,notation = "number"
  footnote(number = c("N = 157 across the 6 networks", 
                    "Data source: SIPRI Arms Transfers Database (2023)")) %>%
  gsub("font-size: initial !important;", 
       "font-size: 11pt !important; font-weight: bold !important;", 
       .)

tbl_glob_triad
tbl_glob_triad %>% save_kable("charts/tbl_glob_triad.html")
webshot("charts/tbl_glob_triad.html", "charts/tbl_glob_triad.pdf")
# webshot("charts/tbl_glob_triad.html", "charts/tbl_glob_triad.png")

# save(tbl_glob_triad, file = "charts/tbl_glob_triad.RData")
# load("charts/tbl_glob_triad.RData")
```

```{r}
# Census triads
glob_df %>%
  select(2,20:35) %>%
  # mutate_if(is.numeric, round, 3) %>%
  gt() %>%
  cols_label(time = "time spell",
              triad_003 = "003",
              triad_012 = "012",
              triad_102 = "102",
              triad_021D = "021D",
              triad_021U = "021U",
              triad_021C = "021C",
              triad_111D = "111D", 
              triad_111U = "111U",
              triad_030T = "030T",
              triad_030C = "030C",
              triad_201 = "201",
              triad_120D = "120D",
              triad_120U = "120U", 
              triad_120C = "120C", 
              triad_210 = "210", 
              triad_300 = "300") %>%
  # tab_options(heading.title.font.size = px(10)) %>%
  tab_header(
    title = "Triads census, t1 - t6",
    subtitle = "International Weapons Transfer Network (1993-2023)"
    ) %>%
  tab_source_note(md("N = 157 for all 6 networks; data: *SIPRI 2023*")) %>%
  gt_theme_pff()
```




## 5.2. TABLE 2: Descriptive stats at node level


```{r}
# load("7_objects/df_country_descr.RData")
# load("7_objects/cent_country_stats.RData")
# load("7_objects/cent_period_stats.RData")
# load("7_objects/cent_ctr_time_stats.RData")
# load("5_objects/cent9323.RData")
# load("7_objects/cent9323_stats.RData")
```

### all countries

```{r}
cent9323_stats <- cent9323 %>% 
  dplyr::select(1:8) %>% 
  dplyr::rename(Country = state1h,
                Iso2c = iso2c,
                Iso3c = iso3c,
                Closeness = clo,
                Betweenness = bet,
                Eigenvector = eig,
                Indegree = ideg,
                Outdegree = odeg) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3)))

```


```{r}
tbl_ctr_cent <- cent9323_stats %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Centrality Statistics by Country: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 11) %>%
  # add_header_above(c("","Centralization Statistics" = 5)) %>%
  row_spec(0, color = "black", bold =T, font_size = 11, background = "lightgray") %>%
  # column_spec(1, color = "black", bold =T, width = "2.7cm") %>%
  # column_spec(2:6, width = "1.8cm") %>%
  # add_footnote(.,
  #          c("N = 157 across the 6 networks",
  #            "Data source: SIPRI Arms Transfers Database (2023)")) %>% #,notation = "number"
  footnote(number = c("N = 157 across the 6 networks", 
                    "Data source: SIPRI Arms Transfers Database (2023)")) %>%
  gsub("font-size: initial !important;", 
         "font-size: 11pt !important; font-weight: bold !important;", 
         .)

tbl_ctr_cent
tbl_ctr_cent %>% save_kable("charts/tbl_ctr_cent.html")
webshot("charts/tbl_ctr_cent.html", "charts/tbl_ctr_cent.pdf")
# webshot("charts/tbl_ctr_cent.html", "charts/tbl_ctr_cent.png")

# save(tbl_ctr_cent, file = "charts/tbl_ctr_cent.RData")
# load("charts/tbl_ctr_cent.RData")
```


### summary 

```{r}
library(sjmisc)
library(tidyverse)
## by country
descr_cent_9323 <- data.frame(descr(cent9323_stats))
descr_cent_9323 <- descr_cent_9323 %>% 
  select(1,6:13) %>%
  dplyr::rename(`Measure` = var,
         Mean = mean,
         SD = sd,
         SE = se,
         Median = md,
         Trimmed = trimmed,
         Range = range,
         IQR = iqr,
         Skew = skew
         ) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3)))
rownames(descr_cent_9323) <- NULL
# save(descr_cent_9323, file = "7_objects/descr_cent_9323.RData")
# load("7_objects/descr_cent_9323.RData")
```


```{r}
# library(kableExtra)
# library(webshot2)
tbl_descr_cent_9323 <- descr_cent_9323 %>%
  kbl(format = "html",bookstab=T,escape=F,caption = "Summary of Centrality Measures: International Arms Transfers (1993-2023)", align = "l") %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling(bootstrap_options = c("striped","condensed","hover"), font_size = 11) %>%
  # add_header_above(c("","Centralization Statistics" = 5)) %>%
  row_spec(0, color = "black", bold =T, font_size = 11, background = "lightgray") %>%
  # column_spec(1, color = "black", bold =T, width = "2.7cm") %>%
  # column_spec(2:6, width = "1.8cm") %>%
  # add_footnote(.,
  #          c("N = 157 across the 6 networks",
  #            "Data source: SIPRI Arms Transfers Database (2023)")) %>% #,notation = "number"
  footnote(number = c("N = 157 across the 6 networks", 
                    "Data source: SIPRI Arms Transfers Database (2023)")) %>%
  gsub("font-size: initial !important;", 
         "font-size: 10.5pt !important; font-weight: bold !important;", 
         .)

tbl_descr_cent_9323
tbl_descr_cent_9323 %>% save_kable("charts/tbl_descr_cent_9323.html")
webshot("charts/tbl_descr_cent_9323.html", "charts/tbl_descr_cent_9323.pdf")
# webshot("charts/tbl_descr_cent_9323.html", "charts/tbl_descr_cent_9323.png")

# save(tbl_descr_cent_9323, file = "charts/objects/tbl_descr_cent_9323.RData")
# load("charts/objects/tbl_descr_cent_9323.RData")

```


Ignore: Explore

```{r}
library(sjmisc)
vis_df %>% 
  group_by(time) %>% 
  select(degree) %>% 
  frq() # ymax = 43, x range = 0-121
```

```{r}
vis_df %>% 
  group_by(time) %>% 
  select(outdegree) %>% 
  frq() # ymax = 126, x range = 0-105
```

```{r}
vis_df %>% 
  group_by(time) %>% 
  select(indegree) %>% 
  frq() # ymax = 126, x range = 0-105
```

```{r}
vis_df %>% 
  group_by(time) %>% 
  select(betweenness) %>% 
  frq() 
```

```{r}
vis_df %>% 
  group_by(time) %>% 
  select(eigenvector) %>% 
  frq() 
```

```{r}
vis_df %>% 
  group_by(time) %>% 
  select(closeness) %>% 
  frq() 
```



## 5.3. [DROP] TABLE 3: Development of tiv values 1993-2023

```{r}
load("iat.pcw.RData") # country-transfer per deal-level
# load("iat_year_agg.RData") # aggregated to country-transfer per year-level
load("iat_t_agg.RData") # aggregated to country-transfer per time spell-level
```

Tiv by year

```{r}
tiv_year <- iat.pcw %>% 
  group_by(year) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  arrange(year) %>% 
  ungroup()
```

Tiv by weapons category

```{r}
tiv_cat <- iat.pcw %>% 
  group_by(category) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  arrange(desc(tiv)) %>% 
  ungroup()
```

Tiv by year & weapons category

```{r}
tiv_year_cat <- iat.pcw %>% 
  group_by(year, category) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  arrange(year,desc(tiv)) %>% 
  mutate(tiv_rank = as.integer(rank(-tiv))) %>% 
  ungroup()
```



### XXX: Tiv by time spell-seller

-   title & captions etc ändern

```{r}
tiv_t_seller <- iat_year_agg %>% 
  group_by(t, state1h) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  arrange(t,desc(tiv)) %>% 
  mutate(tiv_rank = as.integer(rank(-tiv))) %>% 
  ungroup()

tiv_t_seller_top10 <- tiv_t_seller %>% 
  filter(tiv_rank <= 10) %>% 
  mutate(state_fct = reorder_within(state1h, tiv, t))
```

```{r}
# code adapted from: https://juliasilge.com/blog/reorder-within/ and https://lynleyaldridge.netlify.app/2021/03/01/visualizing-data-using-ggplot2-and-ggflags/
library(ggimage)
library(tidytext)
library(ggplot2)

# base plot
seller_top10_bardraft <- tiv_t_seller_top10 %>%
  ggplot(aes(y = state_fct, x = tiv, fill = t)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  # geom_vline(data=vis_df, aes(xintercept=odeg_mean)) +
  facet_wrap(~t, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none")
  # coord_flip()
seller_top10_bardraft
```

```{r}
library(showtext)
# refine plot
mf <- "Roboto Condensed"
font_add_google(name = mf, family = mf) # load font
showtext_auto() # use showtext to render text

p_title7 <- "Top 10 most active weapons exporters in the network by time period (in outdegrees)"
p_subtitle7 <- "Interpretation:  The USA is the most active weapons seller at all time periods. e.g. in t1, it exported to >70 other countries. \nVertical black line depicts average. Countries tied for the last spot are all included in the ranking.\n      "
p_caption7 <- "Data Source(s): SIPRI Arms Transfers Database 2023; author's own calculations"
```

```{r}
# complete plot
seller_top10_bar <- seller_top10_bardraft + 
  theme_minimal() + 
  scale_fill_brewer(palette="Set1") + #  palett = "Dark2", guide="legend"
  # geom_flag(x = -6, aes(image = iso2c)) +
  scale_x_continuous(limits = c(0, 70000),
                     expand = c(0, 0),
                     breaks = seq(0, 70000, 10000),
                     position = "bottom") +
                     # ,labels = c("0","5", "10","15", "20"))
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  labs(title = p_title7, subtitle = p_subtitle7, caption = p_caption7) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 16, color = "black")) + 
  theme(plot.subtitle = element_text(family = mf, size = 10, color = "grey10")) + 
  theme(plot.caption = element_text(family = mf, size = 10, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally
  theme(axis.text = element_text(family = mf, size = 10),
        # axis.text.x = element_text(size = 20),
        # axis.title = element_text(size = 12, face = "bold"),
        # legend.position="none",
        strip.text = element_text(size = 12))

seller_top10_bar

# save(seller_top10_bar, file = "seller_top10_bar.RData")
# load("seller_top10_bar.RData")
```

### XXX: Tiv by time spell-buyer

```{r}
tiv_t_buyer <- iat_year_agg %>% 
  group_by(t, state2h) %>% 
  dplyr::summarise(tiv = sum(tiv)) %>% 
  arrange(t,desc(tiv)) %>% 
  mutate(tiv_rank = as.integer(rank(-tiv))) %>% 
  ungroup()

tiv_t_buyer_top10 <- tiv_t_buyer %>% 
  filter(tiv_rank <= 10) %>% 
  mutate(state_fct = reorder_within(state2h, tiv, t))
```

```{r}
# code adapted from: https://juliasilge.com/blog/reorder-within/ and https://lynleyaldridge.netlify.app/2021/03/01/visualizing-data-using-ggplot2-and-ggflags/
library(ggimage)
library(tidytext)
library(ggplot2)

# base plot
buyer_top10_bardraft <- tiv_t_buyer_top10 %>%
  ggplot(aes(y = state_fct, x = tiv, fill = t)) +
  geom_col(width = 0.85) + # fill = my_col[2]; show.legend=T; state = "identity" default
  # geom_vline(data=vis_df, aes(xintercept=odeg_mean)) +
  facet_wrap(~t, scales = "free_y", ncol = 3) + # scales = "free_x", strip.position = "bottom"
  guides(colour = "none", fill = "none")
# coord_flip()

buyer_top10_bardraft
```

```{r}
library(showtext)
# refine plot
mf <- "Roboto Condensed"
font_add_google(name = mf, family = mf) # load font
showtext_auto() # use showtext to render text

p_title8 <- "Top 10 most active weapons exporters in the network by time period (in outdegrees)"
p_subtitle8 <- "Interpretation:  The USA is the most active weapons buyer at all time periods. e.g. in t1, it exported to >70 other countries. \nVertical black line depicts average. Countries tied for the last spot are all included in the ranking.\n      "
p_caption8 <- "Data Source(s): SIPRI Arms Transfers Database 2023; author's own calculations"
```

```{r}
range(tiv_t_buyer_top10$tiv)
```

```{r}
# complete plot
buyer_top10_bar <- buyer_top10_bardraft + 
  theme_minimal() + 
  scale_fill_brewer(palette="Set1") + #  palett = "Dark2", guide="legend"
  # geom_flag(x = -6, aes(image = iso2c)) +
  scale_x_continuous(limits = c(0, 20000),
                     expand = c(0, 0),
                     breaks = seq(0, 20000, 10000),
                     position = "bottom") +
  # ,labels = c("0","5", "10","15", "20"))
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  labs(title = p_title7, subtitle = p_subtitle7, caption = p_caption7) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 16, color = "black")) + 
  theme(plot.subtitle = element_text(family = mf, size = 10, color = "grey10")) + 
  theme(plot.caption = element_text(family = mf, size = 10, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally
  theme(axis.text = element_text(family = mf, size = 10),
        # axis.text.x = element_text(size = 20),
        # axis.title = element_text(size = 12, face = "bold"),
        # legend.position="none",
        strip.text = element_text(size = 12))

buyer_top10_bar

# save(buyer_top10_bar, file = "buyer_top10_bar.RData")
# load("buyer_top10_bar.RData")
```

## 5.4. [DROP] TABLE 4: Descriptives block level

-   clusters etc








# VI) MODELS





## VI.1) General

### import data
```{r}
# load("6_objects/allm.RData")
# load("6_objects/logm.RData")
# load("6_objects/get_orm.RData")
```


S. Doc 6. SNA_inferential_analysis

-   model summary
-   plot with 95% ci
-   Heiberger tables

### coef names

#### all names grouped
```{r}
network_effects <- c(
  "Density (edges)", 
  "Nested transitivity (GW-ESP)", 
  "Exporter effect (GW-outdegree)", 
  "Importer effect (GW-indegree)", 
  "Mutual trade")

time_dependencies <- c(
  "New arms trade tie, tendency over t", 
  "Arms trade tie, linear growth over t")

dyadic_effects <- c(
  "Relation: allied (1/0)", 
  "Relation: armed conflict (1/0)", 
  "Log2 geographic distance", 
  "Homophily: GDP lower 25%", 
  "Homophily: GDP middle 50%", 
  "Homophily: GDP upper 25%", 
  "Polity score absolute difference")

nodal_effects_mat <- c(
  "Export: Log2 GDP", 
  "Import: Log2 GDP", 
  "Export: Log2 military expenditure", 
  "Import: Log2 military expenditure", 
  "Import: Log2 population")

nodal_effects_sec <- c(
  "Import: Sovereignty level (1=high, 0=low)", 
  "Import: Coup incidence (1/0)",
  "Export: Interstate conflict (1/0)", 
  "Import: Interstate conflict (1/0)",
  "Export: Intrastate conflict (1/0)", 
  "Import: Intrastate conflict (1/0)",
  "Export: Armed conflict (1/0)",
  "Import: Armed conflict (1/0)",
  "Export: Conflict issue: territory (1/0)",
  "Import: Conflict issue: territory (1/0)",
  "Export: Conflict issue: government (1/0)",
  "Import: Conflict issue: government (1/0)",
  "Export: War, min. 1000 deaths (1/0)", 
  "Import: War, min. 1000 deaths (1/0)",
  "Export: Minor conflict, max. 999 deaths (1/0)", 
  "Import: Minor conflict, max. 999 deaths (1/0)")

```


#### m0-m5 all names

```{r}
coefnames_m0m5 <- c(
  "Density (edges)", 
  "Nested transitivity (GW-ESP)", 
  "Exporter effect (GW-outdegree)", 
  "Importer effect (GW-indegree)", 
  "Mutual trade",
  "New arms trade tie, tendency over t", 
  "Arms trade tie, linear growth over t",
  "Relation: allied (1/0)", 
  "Relation: armed conflict (1/0)", 
  "Log2 geographic distance", 
  "Homophily: GDP lower 25%", 
  "Homophily: GDP middle 50%", 
  "Homophily: GDP upper 25%", 
  "Polity score absolute difference",
  "Export: Log2 GDP", 
  "Import: Log2 GDP", 
  "Export: Log2 military expenditure", 
  "Import: Log2 military expenditure", 
  "Import: Log2 population",
  "Import: Sovereignty level (1=high, 0=low)", 
  "Import: Coup incidence (1/0)",
  "Export: Interstate conflict (1/0)", 
  "Import: Interstate conflict (1/0)",
  "Export: Intrastate conflict (1/0)", 
  "Import: Intrastate conflict (1/0)")

```




#### m5a-m5g all names
```{r}
coefnames_m5a5g <- c(
  "Density (edges)", 
  "Nested transitivity (GW-ESP)", 
  "Exporter effect (GW-outdegree)", 
  "Importer effect (GW-indegree)", 
  "Mutual trade",
  "New arms trade tie, tendency over t", 
  "Arms trade tie, linear growth over t",
  "Relation: allied (1/0)", 
  "Relation: armed conflict (1/0)", 
  "Log2 geographic distance", 
  "Homophily: GDP lower 25%", 
  "Homophily: GDP middle 50%", 
  "Homophily: GDP upper 25%", 
  "Polity score absolute difference",
  "Export: Log2 GDP", 
  "Import: Log2 GDP", 
  "Export: Log2 military expenditure", 
  "Import: Log2 military expenditure", 
  "Import: Log2 population",
  "Import: Sovereignty level (1=high, 0=low)", 
  "Import: Coup incidence (1/0)",
  # "Export: Interstate conflict (1/0)", 
  # "Import: Interstate conflict (1/0)",
  # "Export: Intrastate conflict (1/0)", 
  # "Import: Intrastate conflict (1/0)", 
  "Export: Armed conflict (1/0)", 
  "Import: Armed conflict (1/0)",
  "Export: Interstate conflict (1/0)", 
  "Import: Interstate conflict (1/0)",
  "Export: Intrastate conflict (1/0)", 
  "Import: Intrastate conflict (1/0)",
  "Export: Conflict issue: territory (1/0)", 
  "Import: Conflict issue: territory (1/0)",
  "Export: Conflict issue: government (1/0)", 
  "Import: Conflict issue: government (1/0)",
  "Export: War, min. 1000 deaths (1/0)", 
  "Import: War, min. 1000 deaths (1/0)",
  "Export: Minor conflict, max. 999 deaths (1/0)", 
  "Import: Minor conflict, max. 999 deaths (1/0)")
```

#### m5a-m5g short
```{r}
coefnames_m5a5g_short <- c(
  "Export: Armed conflict (1/0)", 
  "Import: Armed conflict (1/0)",
  "Export: Interstate conflict (1/0)", 
  "Import: Interstate conflict (1/0)",
  "Export: Intrastate conflict (1/0)", 
  "Import: Intrastate conflict (1/0)",
  "Export: Conflict issue: territory (1/0)", 
  "Import: Conflict issue: territory (1/0)",
  "Export: Conflict issue: government (1/0)", 
  "Import: Conflict issue: government (1/0)",
  "Export: War, min. 1000 deaths (1/0)", 
  "Import: War, min. 1000 deaths (1/0)",
  "Export: Minor conflict, max. 999 deaths (1/0)", 
  "Import: Minor conflict, max. 999 deaths (1/0)")
```

#### m5a-m5g omit other terms
```{r}
summary(logm$m5a)
names(logm$m5a@coef) # select coefficients that are omitted in the results table
coefnames_m5a5g_omit <- c("edges|gwesp.OTP.fixed.1.5|gwodeg.fixed.1|gwideg.fixed.1|mutual|edgecov.memory|edgecov.timecov1|edgecov.ally_snetb|edgecov.conf_snetb|edgecov.capdist_log2_adj|nodematch.cat_gdp.1|nodematch.cat_gdp.2|nodematch.cat_gdp.3|absdiff.democracy|nodeocov.log2_gdp|nodeicov.log2_gdp|nodeocov.log2_milex|nodeicov.log2_milex|nodeicov.log2_population|nodeifactor.d_sovscore.1|nodeifactor.d_coups.1") #|nodeofactor.d_conf.1|nodeifactor.d_conf.1
 
```

## VI.1) logit results


```{r, results='asis'}
# screenreg(list(m0, m1))
# htmlreg(list(m0, m1),
#         custom.model.names = c("M0","M1"),  #Labels für Modelle
#         custom.coef.names = c("Interzept","Arbeitslosigkeit"), #Labels für Koeffienten (fixed effects)
#         custom.gof.names = c("AIC",                    #Labels für fit Statistik & random effects
#                              "BIC",                
#                              "Log Likelihood",
#                              "Observationen",
#                              "Laender",
#                              "Between-group Var: Intercept",
#                              "Within-group Var: Residual"),
#         caption = "Abhängige Variable: Lebenszufriedenheit",
#         caption.above = T)
```

@nga: Transform HTML to PDF
```{r}
# library(psycModel)
# library(tinytex)
# html_to_pdf(file_path = "iat_models.html")
```

```{r}
## for texreg
# install.packages("dcolumn")
# install.packages("booktabs")
# install.packages("siunitx")
# install.packages("rotating")
# install.packages("longtable")
# install.packages("threeparttable")
```

```{r}
# options(scipen = 99999)
# library(magrittr)
# library(grDevices)
# library(tinytex) # to output tables as pdf
```


### tbl html reg: m0-m5

#### m0-m5
```{r, results='asis'}
## OR ALL MODELS
# load("6_objects/orm.RData")
# load("6_objects/logm.RData")
# library(texreg)
# library(webshot)
# library(webshot2)
# webshot::install_phantomjs()
# library(grDevices)

htmlreg(list(logm$m0,logm$m1,logm$m2,logm$m3,logm$m4,logm$m5),
        file = "charts/tbl_m0m5_logit.html",
        
        ## stats
        ci.force = TRUE,
        ci.force.level = 0.95,
        digits = 2,
        # ci.test = 1,
        # include.nobs = F, # N = 122460
        
        ## names/labels & fonts
        custom.model.names = c("(base)","(1)","(2)","(3)","(4)","(5)"),
        custom.coef.names = coefnames_m0m5,
        custom.gof.names = "N (trade ties)",
        # custom.header = "list of numeric vectors",
        # label = "Table 1",
        caption.above = T,
        caption = "TERGM Theta Estimates (as logit): International Arms Transfers 1993-2023",
        custom.note = "Star indicates null hypothesis value 0 outside of the 95% confidence interval",
        # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not able with longtable
        
        ## tex packages
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom or combination
        single.row = T,
        dcolumn = T,
        # table = F,
        sideways = T,
        # longtable = T,
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
        # threeparttable = T,

        
        ## structure
        # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
        groups = list("NETWORK DEPENDENCIES" = c(1:5),
                      "TEMPORAL DEPENDENCIES" = c(6:7),
                      "DYADIC EFFECTS" = c(8:14),
                      "NODAL EFFECTS: MATERIAL FACTORS" = c(15:19),
                      "NODAL EFFECTS: STABILITY FACTORS" = c(20:25))
)

webshot::webshot("charts/tbl_m0m5_logit.html", vwidth = 1200, vheight = 500, file = "charts/tbl_m0m5_logit.png", selector = "body")
```



```{r, results='asis'}
## LOGITS ALL MODELS

# pdf(file = "tbl_m0m5_logit.pdf")
# htmlreg(list(m0,m1,m2,m3,m4,m5),
#         file = "charts/tbl_m0m5_logit.html",
#         
#         ## stats
#         ci.force = TRUE,
#         ci.force.level = 0.95,
#         digits = 2,
#         ci.test = 0,
#         # include.nobs = F, # N = 122460
#         
#         ## names/labels & fonts
#         custom.model.names = c("(0)","(1)","(2)","(3)","(4)","(5)"),
#         custom.coef.names = coefnames_m0m5,
#         custom.gof.names = "N (trade ties)",
#         # custom.header = "list of numeric vectors",
#         # label = "Table 1",
#         caption.above = T,
#         caption = "tERGM theta estimates (i.e. logits): international arms trade (1993-2023)",
#         custom.note = "Star indicates null hypothesis value 0 outside of the 95% confidence interval",
#         # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
#         # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
#         
#         ## tex packages
#         use.packages = T,
#         booktabs = T,
#         float.pos = "h", # here, page, top, bottom or combination
#         single.row = F,
#         dcolumn = T,
#         # table = F,
#         sideways = T,
#         # longtable = T,
#         # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
#         # threeparttable = T,
#         
#         ## structure
#         # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
#         groups = list("Network dependencies" = c(1:5),
#                       "Temporal dependencies" = c(6:7),
#                       "Dyadic effects" = c(8:14),
#                       "Nodal effects: material factors" = c(15:19),
#                       "Nodal effects: stability factors" = c(20:25))
#         )
# dev.off()
```


#### m5a-g



```{r, results='asis'}
## logit ALL MODELS
# load("6_objects/orm.RData")
# load("6_objects/logm.RData")
# library(texreg)
# library(webshot)
# library(webshot2)
# webshot::install_phantomjs()
# library(grDevices)

htmlreg(list(logm$m5a,logm$m5b,logm$m5c,logm$m5d,logm$m5e,logm$m5f,logm$m5g),
        file = "charts/tbl_m5ag_logit.html",
        
        ## stats
        ci.flogitce = TRUE,
        ci.flogitce.level = 0.95,
        digits = 2,
        # ci.test = 1,
        # include.nobs = F, # N = 122460
        
        ## names/labels & fonts
        custom.model.names = c("(5a)","(5b)","(5c)", "(5d)", "(5e)", "(5f)", "(5g)"),
        custom.coef.names = coefnames_m5a5g,
        custom.gof.names = "N (trade ties)",
        # custom.header = "list of numeric vectlogits",
        # label = "Table 1",
        caption.above = T,
        caption = "TERGM Theta Estimates (as logit): International Arms Transfers 1993-2023, continuation of Model 5a - 5g",
        custom.note = "Star indicates null hypothesis value 0 outside of the 95% confidence interval",
        # fontsize = "nlogitmalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = nlogitmal, 0.5 = half. not able with longtable
        
        ## tex packages
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom logit combination
        single.row = T,
        dcolumn = T,
        # table = F,
        sideways = T,
        # longtable = T,
        # scalebox = 1.0 # 1.0 = nlogitmal, 0.5 = half. not with longtable
        # threeparttable = T,
        
        # # structure
        # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
        # groups = list("NETWORK DEPENDENCIES" = c(1:5),
        #               "TEMPORAL DEPENDENCIES" = c(6:7),
        #               "DYADIC EFFECTS" = c(8:14),
        #               "NODAL EFFECTS: MATERIAL FACTOR" = c(15:19),
        #               "NODAL EFFECTS: STABILITY FACTOR" = c(20:35)),

        omit.coef= coefnames_m5a5g_omit
)
webshot::webshot("charts/tbl_m5ag_logit.html", vwidth = 1250, vheight = 500, file = "charts/tbl_m5ag_logit.png", selector = "body")
# dev.off()
```



### plot reg: m0-m5
```{r, results='asis'}
## LOGITS ALL MODELS
library(texreg)
# pdf(file = "tbl_m0m5_logit.pdf")
plotreg(list(m0,m1,m2,m3,m4,m5),
        # file = "charts/plot_m0m5_logit.html",
        
        ## stats
        ci.force = TRUE,
        ci.force.level = 0.95,
        digits = 2,
        ci.test = 0,
        # include.nobs = F, # N = 122460
        
        ## names/labels & fonts
        custom.model.names = c("(0)","(1)","(2)","(3)","(4)","(5)"),
        custom.coef.names = coefnames_m0m5,
        custom.gof.names = "N (trade ties)",
        # custom.header = "list of numeric vectors",
        # label = "Table 1",
        caption.above = T,
        caption = "tERGM theta estimates (i.e. logits): international arms trade (1993-2023)",
        custom.note = "Star indicates null hypothesis value 0 outside of the 95% confidence interval",
        # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
        
        ## tex packages
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom or combination
        single.row = F,
        dcolumn = T,
        type="forest",
        # table = F,
        sideways = T,
        # longtable = T,
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
        # threeparttable = T,
        
        ## structure
        # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
        groups = list("Network dependencies" = c(1:5),
                      "Temporal dependencies" = c(6:7),
                      "Dyadic effects" = c(8:14),
                      "Nodal effects: material factors" = c(15:19),
                      "Nodal effects: stability factors" = c(20:25))
        )
# dev.off()
```



### tbl html reg: m5a-m5g
```{r}
# library(grDevices)

## LOGITS ALL m5
htmlreg(list(m5a,m5b,m5c,m5d,m5e,m5f,m5g),
        file = "tbl_m5_logit_labs.html",

        ## stats
        ci.force = TRUE,
        ci.force.level = 0.95,
        digits = 2,
        ci.test = 0,
        include.nobs = F, # N = 122460

        ## names/labels & fonts
        custom.model.names = c("(5a)","(5b)","(5c)", "(5d)", "(5e)", "(5f)", "(5g)"),
        custom.coef.names = coefnames_m5a5g,
        custom.gof.names = "N (trade ties)",
        # custom.header = "list of numeric vectors",
        # label = "Table 1",
        caption.above = T,
        caption = "tERGM theta estimates (i.e. logits): international arms trade (1993-2023)",
        # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
        
        ## structure
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom or combination
        single.row = F,
        dcolumn = T,
        # table = F,
        sideways = T,  
        # threeparttable = T,
        # reorder.coef = c(1:7,8:14,15:21,22:35),
        groups = list("Network effects on trade relation" = c(1:5, 6:7),
                      "Dyad effects on trade tie" = c(8:14),
                      "Node effects: material factors" = c(15:19),
                      "Node effects: stability factors" = c(20:35))
        )
```







### [drop] texreg
```{r}
## TEX
m0m5_tr <- texreg(list(m0,m1,m2,m3,m4,m5),
                  return.string = T,
        
            ## stats
            ci.force = TRUE,
            ci.force.level = 0.95,
            digits = 4,
            ci.test = 0,
            # include.nobs = F, # N = 122460
            
            ## names/labels & fonts
            custom.model.names = c("(0)","(1)","(2)","(3)","(4)","(5)"),
            custom.coef.names = coefnames_m0m5,
            custom.gof.names = "N (trade ties)",
            # custom.header = "list of numeric vectors",
            # label = "Table 1",
            caption.above = T,
            caption = "tERGM theta estimates (i.e. logits): international arms trade (1993-2023)",
            custom.note = "Star indicates null hypothesis value outside the 95% confidence interval",
            # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
            # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
            
            ## tex packages
            use.packages = T,
            booktabs = T,
            float.pos = "h", # here, page, top, bottom or combination
            single.row = F,
            dcolumn = T,
            # table = F,
            sideways = T,
            # longtable = T,
            # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
            # threeparttable = T,
            
            ## structure
            # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
            groups = list("Network dependencies" = c(1:5),
                          "Temporal dependencies" = c(6:7),
                          "Dyadic effects" = c(8:14),
                          "Nodal effects: material factors" = c(15:19),
                          "Nodal effects: stability factors" = c(20:25)))
        
cat(m0m5_tr, file="tbl_m0m5.tex")
```
















## VI.2) OR results table



### a) tbl: htmlreg


https://www.r-bloggers.com/2021/01/creating-beautiful-and-flexible-summary-statistics-tables-in-r-with-gtsummary/
```{r}
library(webshot2)
library(knitr)
library(magick)
library(modelsummary)
library(dplyr)
library(fixest)
# webshot("charts/tbl_glob1.html", "charts/tbl_glob1.pdf")
```

#### m0-m5
```{r, results='asis'}
## OR ALL MODELS
# load("6_objects/orm.RData")
# load("6_objects/logm.RData")
# library(texreg)
# library(webshot)
# library(webshot2)
# webshot::install_phantomjs()
# library(grDevices)

htmlreg(list(orm$m0,orm$m1,orm$m2,orm$m3,orm$m4,orm$m5),
        file = "charts/tbl_m0m5_or.html",
        
        ## stats
        ci.force = TRUE,
        ci.force.level = 0.95,
        digits = 2,
        ci.test = 1,
        # include.nobs = F, # N = 122460
        
        ## names/labels & fonts
        custom.model.names = c("(base)","(1)","(2)","(3)","(4)","(5)"),
        custom.coef.names = coefnames_m0m5,
        custom.gof.names = "N (trade ties)",
        # custom.header = "list of numeric vectors",
        # label = "Table 1",
        caption.above = T,
        caption = "TERGM Theta Estimates (as odds ratio): International Arms Transfers 1993-2023",
        custom.note = "Star indicates null hypothesis value 1 outside of the 95% confidence interval",
        # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not able with longtable
        
        ## tex packages
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom or combination
        single.row = T,
        dcolumn = T,
        # table = F,
        sideways = T,
        # longtable = T,
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not with longtable
        # threeparttable = T,
        
        ## structure
        # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
        groups = list("NETWORK DEPENDENCIES" = c(1:5),
                      "TEMPORAL DEPENDENCIES" = c(6:7),
                      "DYADIC EFFECTS" = c(8:14),
                      "NODAL EFFECTS: MATERIAL FACTORS" = c(15:19),
                      "NODAL EFFECTS: STABILITY FACTORS" = c(20:25))
        )
webshot::webshot("charts/tbl_m0m5_or.html", vwidth = 1200, vheight = 500, file = "charts/tbl_m0m5_or.png", selector = "body")
# dev.off()
```


#### m5a - m5g


```{r}

# load("6_objects/orm.RData")
# load("6_objects/logm.RData")
# library(texreg)
# library(webshot)
# library(webshot2)
# webshot::install_phantomjs()
# library(grDevices)

htmlreg(list(orm$m5a,orm$m5b,orm$m5c,orm$m5d,orm$m5e,orm$m5f,orm$m5g),
        file = "charts/tbl_m5ag_or.html",
        
        ## stats
        ci.force = TRUE,
        ci.force.level = 0.95,
        digits = 2,
        ci.test = 1,
        # include.nobs = F, # N = 122460
        
        ## names/labels & fonts
        custom.model.names = c("(5a)","(5b)","(5c)", "(5d)", "(5e)", "(5f)", "(5g)"),
        custom.coef.names = coefnames_m5a5g,
        custom.gof.names = "N (trade ties)",
        # omit.coef = "(Density (edges)) | (Nested transitivity (GW-ESP))",
        # custom.header = "list of numeric vectors",
        # label = "Table 1",
        caption.above = T,
        caption = "TERGM Theta Estimates (as odds ratio): International Arms Trade 1993-2023, continuation of Model 5",
        custom.note = "Star indicates null hypothesis value 1 outside of the 95% confidence interval",
        # fontsize = "normalsize", # "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge"
        # scalebox = 1.0 # 1.0 = normal, 0.5 = half. not able with longtable
        
        ## tex packages
        use.packages = T,
        booktabs = T,
        float.pos = "h", # here, page, top, bottom or combination
        single.row = T,
        dcolumn = T,
        # table = F,
        sideways = T,
        # longtable = T,
        # scalebox = 1.0 # 1.0 = nlogitmal, 0.5 = half. not with longtable
        # threeparttable = T,
        
        # # structure
        # reorder.coef = c(1:5,13:14,6:12,15:21,22:25),
        # groups = list("NETWORK DEPENDENCIES" = c(1:5),
        #               "TEMPORAL DEPENDENCIES" = c(6:7),
        #               "DYADIC EFFECTS" = c(8:14),
        #               "NODAL EFFECTS: MATERIAL FACTOR" = c(15:19),
        #               "NODAL EFFECTS: STABILITY FACTOR" = c(20:35)),

        omit.coef= coefnames_m5a5g_omit
        )
webshot::webshot("charts/tbl_m5ag_or.html", vwidth = 1250, vheight = 500, file = "charts/tbl_m5ag_or.png", selector = "body")
```





### b) modelsummary


https://modelsummary.com/articles/modelsummary.html#fmt-round-and-format
CUSTOMIZE APPEARANCE: https://modelsummary.com/articles/appearance.html

```{r}
library(modelsummary)
a <- modelsummary(list(orm$m0,orm$m1,orm$m2,orm$m3,orm$m4,orm$m5))
a
```


```{r}
load("6_objects/logm.RData")
modelsummary(list(logm$m0,orm$m1,logm$m2,logm$m3,logm$m4,logm$m5), fmt = fmt_statistic(estimate = 4, conf.int = 1), statistic = "conf.int")
```



### c) kbl

https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
```{r}
# kbl(mtcars[1:10, 1:6], caption = "Group Rows") %>%
#   kable_paper("striped", full_width = F) %>%
#   pack_rows("Group 1", 4, 7) %>%
#   pack_rows("Group 2", 8, 10)
```




### d) stargazer




### e) sjPlot

```{r, echo=T}
# library(sjPlot)
plot_model(m2, 
           type = "re", 
           sort.est = T, 
           show.values = T, 
           show.p = T,
           value.offset = 0.3)
```





## VI.3) FOREST PLOT


### a) fab vs me 
```{r}
# n <- list(c(m0@nobs,m1@nobs,m2@nobs,m3@nobs,m4@nobs,m5@nobs))
# n5 <- m5@nobs
# plot(coef_plot)
# library(ggplot2)
# library(sjPlot)
# 
# install.packages("sjPlot")
```


#### a1. my own plot


##### plot

###### v1
```{r}
## v1
coef_plot <- m5_or  %>% 
  ggplot() + aes(x = term, y = r_or, ##
                 ymin = r_or_lci, #
                 ymax = r_or_uci, #
                 color = convert_label3) + # not needed for bin. log model, here: trad & progr
  geom_hline(yintercept = 1, 
             color = "gray25", 
             linetype = "dotted") + 
  geom_errorbar(position = position_dodge(0.5), width = 0) + 
  geom_point(aes(shape = variable_group), # not necessary
             position = position_dodge(width = 0.5)) + 
  scale_y_log10() +
  geom_vline(xintercept = seq(1.5, length(unique(allm$term)) - 0.5, 1), #
             lwd = 1, colour = "grey", alpha = 0.7) +
  geom_text(aes(x = term, #
                y = r_or + 0.01, #
                # label = paste(sprintf('%.2f', or, 2), stars)), ##
                label = paste(converted_display, stars)),
                position = position_dodge(1.2), show.legend = F) +
  coord_flip() +
  guides(point = F) +
  scale_y_continuous(breaks = seq(-2,2, by = 0.3), limits = c(.5, 1.9)) +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() +# and a border around each panel
  xlab("") +
  ylab("Odds Ratios & 1/Odds Ratios") + 
  # labs(caption = paste(expression("McFadden's Pseudo R^2:")), 
  #                                          gg_coefs$mcfadden) +
  facet_grid(~ model, scales = "fixed") + #
  # use obs N as label instead
  # annotate("label", x = -1, y = 1.25, label = paste("N tie:",n5)) +
  # annotate("label", x = -1, y = 1.25, label = paste("McFadden's R2.:",
  #                                                 mcfaddies,
  #                                                 "\n N:", rep(nrow(mlogit_ess), 5),
  #                                                 "\n LRT:", anovies)) +
  # annotate("label", x = 7.5, y = 0.7, label = "Controls") +
  # annotate("label", x = 11.5, y = 0.7, label = "Economic") +
  # annotate("label", x = 18.5, y = 0.7, label = "Cultural") +
  # annotate("label", x = 19.5, y = 0.7, label = "Interactions") +
  # expand_limits(x = 21) + 
geom_text(aes(x = -2, label = ""), show.legend = F) +
  scale_x_discrete(limits = c("Network effects", 
                              "Density (edges)",
                              "Nested transitivity (GW-ESP)",
                              "Exporter effect (GW-outdegree)",
                              "Importer effect (GW-indegree)", 
                              "Mutual trade",
                              "Time dependencies",
                              "New arms trade tie, tendency over t", 
                              "Arms trade tie, linear growth over t",
                              "Dyadic effects",
                              "Relation: allied (1/0)",
                              "Relation: armed conflict (1/0)",
                              "Log2 geographic distance", 
                              "Homophily: GDP lower 25%", 
                              "Homophily: GDP middle 50%", 
                              "Homophily: GDP upper 25%", 
                              "Polity score absolute difference",
                              "Nodal effects: material factors",
                              "Export: Log2 GDP", 
                              "Import: Log2 GDP", 
                              "Export: Log2 military expenditure", 
                              "Import: Log2 military expenditure", 
                              "Import: Log2 population",
                              "Nodal effects: stability factors",
                              "Import: Sovereignty level (1=high, 0=low)", 
                              "Import: Coup incidence (1/0)",
                              "Export: Interstate conflict (1/0)", 
                              "Import: Interstate conflict (1/0)",
                              "Export: Intrastate conflict (1/0)", 
                              "Import: Intrastate conflict (1/0)"), 
                   labels = c("Network effects"=expression(displaystyle(bold(`Network effects`))), 
                            "Time dependencies"=expression(displaystyle(bold(`Time dependencies`))),
                            "Dyadic effects"=expression(displaystyle(bold(`Dyadic effects`))), 
                            "Nodal effects: material factors"=expression(displaystyle(bold(`Nodal effects: material factors`))),
                            "Nodal effects: stability factors"=expression(displaystyle(bold(`Nodal effects: stability factors`))),
                            parse=TRUE))

coef_plot
    
# ggsave(filename = "images/onebigmotherfucker.png", width = 15, height = 10)
 
# multi1.rrr <- exp(coef(test))
# stargazer::stargazer(test, type="text",coef=list(multi1.rrr), p.auto=FALSE)
```

###### v2
```{r}
m5_or %>%
  ggplot() +
  aes(x = r_or, y = term, color = convert_label3) + # ymin = conf.low,ymax = conf.high,
  geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") + # data=df
  geom_errorbarh(aes(xmin = r_or_lci, xmax = r_or_uci), size = .1, height = .3, color = "gray25") +
  geom_point(size = 0.5, color = "#FA8072") +
  # geom_text(aes(x = term, y = r_or + 0.01, label=paste(converted_display, stars)),
  #               position = position_dodge(1.2), show.legend = F) +
  # scale_x_discrete() +
  scale_x_continuous() +
  ggtitle("Odds of arms transfer: model 1 - 5") +
  ylab("Model terms") +
  xlab('Odds ratio inc. 95% CI') +
  theme(plot.title = element_text(hjust = 0.5))
p_m5or

###################
# base plot
p <- odeg_top10 %>%
  ggplot(aes(y = state_fct, 
             x = outdegree, 
             fill = time)) #+
p <- p+ geom_col(width = 0.85) #+ # fill = my_col[2]; show.legend=T; state = "identity" default
p <- p + geom_vline(data=vis_df, 
             aes(xintercept=odeg_mean)) #+
p <- p+facet_wrap(~time, scales = "free_y", ncol = 3) #+ # scales = "free_x", strip.position = "bottom"
p <- p+ guides(colour = "none", fill = "none")
  # coord_flip()

# complete plot
p2 <- p + 
  theme_minimal() + 
  scale_fill_brewer(palette="Set1") + #  palett = "Dark2", guide="legend"
  geom_flag(x = -6, aes(image = iso2c)) +
  scale_x_continuous(limits = c(-8, 120),
                     expand = c(0, 0),
                     breaks = seq(0, 120, 25),
                     position = "bottom") +
                     # ,labels = c("0","5", "10","15", "20")) 
  # scale_y_continuous(limits = c(-1, 20),
  #                    expand = c(0, 0),
  #                    breaks = seq(0, 15, 1),
  #                    position = "top") +
  scale_y_reordered() +
  labs(title = p_title3, subtitle = p_subtitle3, caption = p_caption3) +
  theme(axis.title = element_blank()) + 
  theme(plot.margin = unit(c(1, 1.3, 1, 1), "cm")) + 
  theme(plot.background = element_rect(fill = "seashell", color = NA)) +  
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.major.x = element_line(size = 0.6, color = "grey80")) + # element_blank()
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_line(size = 0.4, color = "grey80")) +
  theme(plot.title = element_text(family = mf, size = 16, color = "black")) + 
  theme(plot.subtitle = element_text(family = mf, size = 10, color = "grey10")) + 
  theme(plot.caption = element_text(family = mf, size = 10, face = "italic", hjust = 0, vjust = -4)) + # change hjust to move caption horizontally
  theme(axis.text = element_text(family = mf, size = 10),
        # axis.text.x = element_text(size = 20),
        # axis.title = element_text(size = 12, face = "bold"),
        # legend.position="none",
        strip.text = element_text(size = 12))
```

```{r}
## v1
coef_plot <- m5_or  %>% 
  ggplot() + aes(x = term, y = r_or, ##
                 ymin = r_or_lci, #
                 ymax = r_or_uci, #
                 color = convert_label3) + # not needed for bin. log model, here: trad & progr
  geom_hline(yintercept = 1, 
             color = "gray25", 
             linetype = "dotted") + 
  geom_errorbar(position = position_dodge(0.5), width = 0) + 
  geom_point(aes(shape = variable_group), # not necessary
             position = position_dodge(width = 0.5)) + 
  scale_y_log10() +
  geom_vline(xintercept = seq(1.5, length(unique(allm$term)) - 0.5, 1), #
             lwd = 1, colour = "grey", alpha = 0.7) +
  geom_text(aes(x = term, #
                y = r_or + 0.01, #
                # label = paste(sprintf('%.2f', or, 2), stars)), ##
                label = paste(converted_display, stars)),
                position = position_dodge(1.2), show.legend = F) +
  # coord_flip() +
  guides(point = F) + 
  scale_x_continuous(limits = c(0, 2.5), breaks = seq(0,2.5,0.5),position = "bottom") + # expand = c(0, 0)
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() +# and a border around each panel
  xlab("") +
  ylab("Odds Ratios & 1/Odds Ratios") + 
  # labs(caption = paste(expression("McFadden's Pseudo R^2:")), 
  #                                          gg_coefs$mcfadden) +
  facet_grid(~ model, scales = "fixed") + #
  # use obs N as label instead
  # annotate("label", x = -1, y = 1.25, label = paste("N tie:",n5)) +
  # annotate("label", x = -1, y = 1.25, label = paste("McFadden's R2.:",
  #                                                 mcfaddies,
  #                                                 "\n N:", rep(nrow(mlogit_ess), 5),
  #                                                 "\n LRT:", anovies)) +
  # annotate("label", x = 7.5, y = 0.7, label = "Controls") +
  # annotate("label", x = 11.5, y = 0.7, label = "Economic") +
  # annotate("label", x = 18.5, y = 0.7, label = "Cultural") +
  # annotate("label", x = 19.5, y = 0.7, label = "Interactions") +
  # expand_limits(x = 21) + 
geom_text(aes(x = -2, label = ""), show.legend = F) +
  scale_x_discrete(limits = c("Network effects", 
                              "Density (edges)",
                              "Nested transitivity (GW-ESP)",
                              "Exporter effect (GW-outdegree)",
                              "Importer effect (GW-indegree)", 
                              "Mutual trade",
                              "Time dependencies",
                              "New arms trade tie, tendency over t", 
                              "Arms trade tie, linear growth over t",
                              "Dyadic effects",
                              "Relation: allied (1/0)",
                              "Relation: armed conflict (1/0)",
                              "Log2 geographic distance", 
                              "Homophily: GDP lower 25%", 
                              "Homophily: GDP middle 50%", 
                              "Homophily: GDP upper 25%", 
                              "Polity score absolute difference",
                              "Nodal effects: material factors",
                              "Export: Log2 GDP", 
                              "Import: Log2 GDP", 
                              "Export: Log2 military expenditure", 
                              "Import: Log2 military expenditure", 
                              "Import: Log2 population",
                              "Nodal effects: stability factors",
                              "Import: Sovereignty level (1=high, 0=low)", 
                              "Import: Coup incidence (1/0)",
                              "Export: Interstate conflict (1/0)", 
                              "Import: Interstate conflict (1/0)",
                              "Export: Intrastate conflict (1/0)", 
                              "Import: Intrastate conflict (1/0)"), 
                   labels = c("Network effects"=expression(displaystyle(bold(`Network effects`))), 
                            "Time dependencies"=expression(displaystyle(bold(`Time dependencies`))),
                            "Dyadic effects"=expression(displaystyle(bold(`Dyadic effects`))), 
                            "Nodal effects: material factors"=expression(displaystyle(bold(`Nodal effects: material factors`))),
                            "Nodal effects: stability factors"=expression(displaystyle(bold(`Nodal effects: stability factors`))),
                            parse=TRUE))

coef_plot
    
# ggsave(filename = "images/onebigmotherfucker.png", width = 15, height = 10)
 
# multi1.rrr <- exp(coef(test))
# stargazer::stargazer(test, type="text",coef=list(multi1.rrr), p.auto=FALSE)
```


#### a2. fabs plot

##### create data frame
```{r}
get_p_values <- function (pval) {
  dplyr::case_when(
    # is.na(pval) ~ "", 
    pval < 0.001 ~ "***", 
    pval < 0.01 ~ "**", 
    pval < 0.05 ~ "*", TRUE ~ "")
}


# library(DescTools)
prep_dat <- function(model, modelname) {
  tidy_model <- tidy(model, exponentiate = T, conf.int = TRUE) %>% #step(model) %>% 
  mutate(model = modelname) %>% 
  mutate(stars = get_p_values(p.value)) 
  
tidy_model$mcfadden <- round(PseudoR2(model), 2)
  
  return(tidy_model)
}


anovies <- c("-", paste0(
  round(c(anova(controls, fit1)$`LR stat.`[2],
          anova(controls, fit2)$`LR stat.`[2],
          anova(fit2, fit3)$`LR stat.`[2],
          anova(fit3, fit4)$`LR stat.`[2]), 2),
  c(anova(controls, fit1)$`Pr(Chi)`[2],
    anova(controls, fit2)$`Pr(Chi)`[2],
    anova(fit2, fit3)$`Pr(Chi)`[2],
    anova(fit3, fit4)$`Pr(Chi)`[2]) %>% 
    get_p_values()
))
```

```{r}
# # screenreg(test)
#  stargazer::stargazer(controls, fit1, fit2, fit3, type = "html", apply.coef = exp, p.auto=FALSE)

all_mods <- rbind( 
prep_dat(controls, "control"),
prep_dat(fit1, "model1"),
prep_dat(fit2, "model2"),
prep_dat(fit3, "model3"),
prep_dat(fit4, "model4")
) 

mcfaddies <- all_mods %>% 
  group_by(model, mcfadden) %>% 
  tally() %>%
  .$mcfadden

unique(all_mods$term)
```

##### names
```{r}
# names
control_variables <- c("age", "educ", "sex", "lrscale", "ethnic", 
                       "religion", "rural", "south", "east", "north", 
                       "globalism", "govsat")
  
economic <- c("econ_insec", "unemployed", "welfare")

cultural <- c("anti_imm", "openness", "conservation", "selfenhance", "selftrans")
```

##### add variables
```{r}
# neu: data prep
library(forcats)
coef_sum <- all_mods %>% 
  # filter(term != "south") %>%
  # filter(term != "east") %>%
  # filter(term != "north") %>%
  # filter(term != "year_2016") %>%
  # filter(term != "year_2014") %>%
  # filter(term != "year_2012") %>%
  # filter(term != "(Intercept)") %>%
  mutate(variable_group = case_when(
    term %in% control_variables ~ "Controls",
    term %in% economic ~ "Economic",
    term %in% cultural ~ "Cultural",
    TRUE ~ "Interactions"
  )) %>% 
  mutate(model = case_when(
    model == "control" ~ "Model 1 (Controls)",
    model == "model1" ~ "Model 2 (Economic)",
    model == "model2" ~ "Model 3 (Culture)",
    model == "model3" ~ "Model 4 (Economic + Culture)",
    model == "model4" ~ "Model 5 (Interactions)"
  )) %>%
  mutate(term = case_when(
    term == "anti_imm" ~ "Anti-Immigration Sentiment", 
    term == "openness" ~ "Openness", 
    term == "conservation" ~ "Conservation", 
    term == "selfenhance" ~ "Self-Enhancement", 
    term == "selftrans" ~ "Self-Transcendence", 
    term == "econ_insec" ~ "Economic Insecurity", 
    term == "unemployed" ~ "Unemployed (0/1)", 
    term == "welfare" ~ "Welfare (0/1)",
    term == "age" ~ "Age", 
    term == "educ" ~ "Education", 
    term == "sex" ~ "Female (0/1)", 
    term == "lrscale" ~ "Left-Right Scale", 
    term == "ethnic" ~ "Ethnic Minority (0/1)", 
    term == "religion" ~ "Religiosity", 
    term == "rural" ~ "Rural (0/1)",  
    term == "globalism" ~ "Trust in Global Governance", 
    term == "govsat" ~ "Government Satisfaction",
    term == "econ_insec:anti_imm" ~ "Econ. Insec. X Anti-Immigration",
#    term == "econ_insec:conservation" ~ "Economic Insecurity X Conservation",
    term == "unemployed:selfenhance" ~ "Unemployed X Self-Enhance"
  )) %>% 
  mutate(term = fct_relevel(term, c("Unemployed X Self-Enhance",
                              #"Economic Insecurity X Conservation",
                              "Econ. Insec. X Anti-Immigration",
                              "Anti-Immigration Sentiment", "Openness", 
                              "Conservation", "Self-Enhancement", "Self-Transcendence", 
                              "Econ Insecurity", "Unemployed (0/1)", 
                              "Welfare (0/1)",
                              "Age", "Education", "Female (0/1)", "Left-Right Scale", 
                              "Ethnic Minority (0/1)", "Religiosity", "Rural (0/1)",
                              "Trust in Global Governance", "Government Satisfaction"))) %>% 
  mutate(`Variable Groups` = variable_group) %>% 
  mutate(`Y-Level` = y.level)

```

##### plot
```{r}
library(ggplot2)
coef_plot <-  ggplot() + aes(x = term, y = estimate, ##
                 ymin = conf.low, #
                 ymax = conf.high, #
                 color = `Y-Level`) + # not needed for bin. log model, here: trad & progr
  geom_hline(yintercept = 1, 
             color = "gray25", 
             linetype = "dotted") + 
  geom_errorbar(position = position_dodge(0.5), width = 0) + 
  geom_point(aes(shape = `Variable Groups`), # not necessary
             position = position_dodge(width = 0.5)) + 
  scale_y_log10() +
  geom_vline(xintercept = seq(1.5, length(unique(all_mods$term)) - 0.5, 1), #
             lwd = 1, colour = "grey", alpha = 0.7) +
  geom_text(aes(x = term, #
                y = estimate + 0.01, #
                label = paste(sprintf('%.2f', estimate, 2), stars)), ##
                position = position_dodge(1.2), show.legend = F) +
  coord_flip() +
  guides(point = F) +
  scale_y_continuous(breaks = seq(-2,2, by = 0.3), limits = c(.5, 1.9)) +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() +# and a border around each panel
  xlab("") +
  ylab("Odds Ratios") + 
  # labs(caption = paste(expression("McFadden's Pseudo R^2:")), 
  #                                          gg_coefs$mcfadden) +
  facet_grid(~ model, scales = "fixed") +
  # use obs N as label instead
  annotate("label", x = -1, y = 1.25, label = paste("McFadden's R2.:",
                                                  mcfaddies,
                                                  "\n N:", rep(nrow(mlogit_ess), 5),
                                                  "\n LRT:", anovies)) +
  # annotate("label", x = 7.5, y = 0.7, label = "Controls") +
  # annotate("label", x = 11.5, y = 0.7, label = "Economic") +
  # annotate("label", x = 18.5, y = 0.7, label = "Cultural") +
  # annotate("label", x = 19.5, y = 0.7, label = "Interactions") +
  # expand_limits(x = 21) + 
  geom_text(aes(x = -2, label = ""), show.legend = F) +
  scale_x_discrete(limits = c("Unemployed X Self-Enhance",
                              #"Economic Insecurity X Conservation",
                              "Econ. Insec. X Anti-Immigration",
                              "Interactions",
                              "Anti-Immigration Sentiment", "Openness", 
                              "Conservation", "Self-Enhancement", "Self-Transcendence", 
                              "Culture",
                              "Economic Insecurity", "Unemployed (0/1)", 
                              "Welfare (0/1)",
                              "Economics",
                              "Age", "Education", "Female (0/1)", "Left-Right Scale", 
                              "Ethnic Minority (0/1)", "Religiosity", "Rural (0/1)",
                              "Trust in Global Governance", "Government Satisfaction",
                              "Controls"), 
                   labels = c("Controls"=expression(displaystyle(bold(Controls))), 
                            "Economics"=expression(displaystyle(bold(Economics))),
                            "Culture"=expression(displaystyle(bold(Culture))), 
                            "Interactions"=expression(displaystyle(bold(Interactions))), 
                            parse=TRUE))

ggsave(filename = "images/onebigmotherfucker.png", width = 15, height = 10)
 
# multi1.rrr <- exp(coef(test))
# 
# stargazer::stargazer(test, type="text",coef=list(multi1.rrr), p.auto=FALSE)

# TODO Make a map (or two)
# TODO Make stuff citeable
# TODO Decide which interactions
# TODO Make probability plots

unique(all_mods$term)
```



### b) RHH

-   custom name for terms
-   OR value labeln



#### plot or

```{r}
## OLD
# m1_or <- exp(m1_logit)
# m1_or <- data.frame(m1_or)
# names(m1_or) <- c('or','or_lci', 'or_uci') # name columns

# m1_df <- m1_df[4:nrow(m1_or_df),]  # select terms, e.g. here only term 4 to end (i.e. leave out the first 3 effects from the plot)
```

```{r}
## OLD 2
# library(btergm)
# m1_or <- orm$m1
# m1_or <- confint(m1_or)
# m1_or <- m1_or[,c(1,3,4)]
# m1_or <- data.frame(m1_or)
# names(m1_or) <- c('or','or_lci', 'or_uci') # name columns
```




```{r}
## NEW
# load("6_objects/allm.RData")

library(ggplot2)
library(forcats)
library(tibble)
library(magrittr)

m5_or <- allm %>% 
  filter(model == "Model 5") # %>% 
  # mutate(converted_display2 = ifelse(or < 1,
  #                                 paste("(", sprintf("%.2f", converted_stat), ")"), 
  #                                 paste(""))) %>% 
  # mutate(
  #    `Variable Groups` = variable_group
  #    ,convert_label3 = case_when(convert_label2 == "1/Odds Ratio" ~ "Odds Ratio (- |1/Odds Ratio|)",
  #                               convert_label2 == "Odds Ratio" ~ "Odds Ratio")
     # ,`1/OR` = converted_stat
     # ,`Odds Ratio (- |1/Odds Ratio|)` = converted_display,
     # ,`Y-Level` = y.level
         # )
```

```{r}
# # duplicate df
# m5_or2 <- m5_or 
# m5_or$dup <- 1
# m5_or2$dup <- 2
# m5_or <- rbind(m5_or,m5_or2)

## reorder levels
# library(tidytext)
m5_or_2 <- m5_or %>% 
  group_by(variable_group) %>%
  mutate(term_cat_ordered = reorder_within(term, term_cat, variable_group)) %>%
  arrange(variable_group,desc(term_cat)) %>% 
  ungroup()


```

```{r}
data=head(mtcars, 30)
# m5_or  <- m5_or %>%
  # rownames_to_column(var="term")
  
# Plot
ggplot(data, aes(x=wt, y=mpg)) +
  geom_point() + 
  geom_label( 
    data=data %>% filter(mpg>20 & wt>3), # Filter data first
    aes(label=carName)
  )

```

##### plot

```{r}
m5_or %>%
  ggplot() +
  aes(x = r_or, y = term, color = convert_label3) + # ymin = conf.low,ymax = conf.high,
  geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") + # data=df
  geom_errorbarh(aes(xmin = r_or_lci, xmax = r_or_uci), size = .1, height = .3, color = "gray25") +
  geom_point(size = 0.5, color = "#FA8072") +
  # geom_text(aes(x = term, y = r_or + 0.01, label=paste(converted_display, stars)),
  #               position = position_dodge(1.2), show.legend = F) +
  # scale_x_discrete() +
  scale_x_continuous() +
  ggtitle("Odds of arms transfer: model 1 - 5") +
  ylab("Model terms") +
  xlab('Odds ratio inc. 95% CI') +
  theme(plot.title = element_text(hjust = 0.5))
p_m5or
```


```{r}
# library(ggplot2)
## m5
p_m5or <- m5_or %>%
  ggplot() +
  aes(x = r_or, y = term, color = convert_label3) + # ymin = conf.low,ymax = conf.high,
  geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") + # data=df
  geom_errorbarh(aes(xmin = r_or_lci, xmax = r_or_uci), size = .1, height = .3, color = "gray25") +
  geom_point(size = 0.5, color = "#FA8072") +
  # scale_y_discrete(limits = term) +
  # geom_label(data=m5_or %>% filter(or > 1),aes(label=carName), # only label filt. data
  # geom_text(aes(label=converted_display,
  #               # color=factor(convert_label3),
  #               size = 0.1,
  #               nudge_x = 0.25, nudge_y = 0.25,
  #               check_overlap = T)) +
  geom_text(aes(x = term, y = r_or + 0.01, label=paste(converted_display, stars)),
                position = position_dodge(1.2), show.legend = F) +
  # geom_text(aes(label = paste(converted_display, stars),
  #             color = factor(convert_label3)),
  #         size = 3,  # Adjust the size as needed
  #         nudge_x = 0.25, nudge_y = 0.25,
  #         check_overlap = TRUE,
  #         position = position_dodge(1.2)) +
  # geom_text(aes(x = term, #
  #               y = estimate + 0.01, #
  #               label = paste(sprintf('%.2f', estimate, 2), stars)), ##
  #               position = position_dodge(1.2), show.legend = F) +
  # scale_color_manual(values = c("Odds Ratio (- |1/Odds Ratio|)" = "black", "Odds Ratio" = "black")) +
  ggtitle("Odds of arms transfer: model 1 - 5") +
  ylab("Model terms") +
  xlab('Odds ratio inc. 95% CI') +
  theme(plot.title = element_text(hjust = 0.5))

p_m5or

geom_text(aes(label = converted_display,
              color = factor(convert_label3)),
          size = 3,  # Adjust the size as needed
          nudge_x = 0.25, nudge_y = 0.25,
          check_overlap = TRUE) +



  geom_label(
    label="Look at this!", # only label specific x/y position
    x=4.1, # position x
    y=20, # position y
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.35,
    color = "black",
    fill="#69b3a2" # fill padding
  )
  
    geom_label(
    label=rownames(data), 
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T
  )
    
    geom_text(
    label=rownames(data), 
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T # use ggrepel if need more options
  )
```

```{r}
# save(p_m5_or, file = "6_objects/p_m5_or.RData")
# load("p_m5_or.RData")

# pdf("p_m5_or.pdf", width = 6.5, height = 4) # open pdf device, w & h in inches
# plot(p_m5_or)
# dev.off()
```

```{r}
### RHH source code
## m1
# library(ggplot2)
# p_m1_or <- ggplot(
#   m1_or, aes(x = or, y = rownames(m1_or))) +
#   geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") +
#   geom_errorbarh(aes(xmax = or_uci, xmin = or_lci), size = .1, height = .3, color = "gray25") +
#   geom_point(size = 0.6, color = "red") +
#   ylab("") + # or model terms
#   xlab('Odds ratio inc. 95% CI') + 
#   scale_y_discrete(limits = rownames(m1_or)) + 
#   ggtitle("Odds of arms transfer, arms import, arms export, network statistics") +
#   theme(plot.title = element_text(hjust = 0.5))
# 
# p_m1_or
```



#### plot logit

```{r}
# # library(btergm)
# m5_logit <- confint(logm$m5)
# m5_logit <- m5_logit[,c(1,3,4)] # only select Estimate, 2.5% and 97.5% (leave out Boot mean)
# m1_logit <- data.frame(m1_logit)
# names(m1_logit) <- c('logit','logit_lci', 'logit_uci') # name columns
```


```{r}
# library(ggplot2)
p_m1_logit <- ggplot(
  m1_logit, aes(x = logit, y = rownames(m1_logit))) +
  geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") +
  geom_errorbarh(aes(xmax = logit_uci, xmin = logit_lci), size = .1, height = .3, color = "gray25") +
  geom_point(size = 0.6, color = "red") +
  ylab("") + # logit model terms
  xlab('inc. 95% CI') + 
  scale_y_discrete(limits = rownames(m1_logit)) + 
  ggtitle("Theta estimates (i.e. logits), Modell 1") +
  theme(plot.title = element_text(hjust = 0.5))

p_m1_logit
```




#### select specific terms

```{r}
# m1_df <- m1_df[4:nrow(m1_or_df),]  # select terms, e.g. here only term 4 to end (i.e. leave out the first 3 effects from the plot)
# m <- m1_logit[3:nrow(m1_logit),]
# 
# p_m1_logit2 <- ggplot(m, aes(x = logit, y = rownames(m))) +
#   geom_vline(aes(xintercept = 1), linewidth = .25, linetype = "dashed") +
#   geom_errorbarh(aes(xmax = logit_uci, xmin = logit_lci), size = .1, height = .3, color = "gray25") +
#   geom_point(size = 0.6, color = "red") +
#   ylab("") + # logit model terms
#   xlab('inc. 95% CI') + 
#   scale_y_discrete(limits = rownames(m)) + 
#   ggtitle("Theta estimates (i.e. logits), Modell 1") +
#   theme(plot.title = element_text(hjust = 0.5))
# p_m1_logit2
```






### e) forestplot package

https://rpubs.com/mbounthavong/forest_plots_r
https://argoshare.is.ed.ac.uk/healthyr_book/odds-ratio-plot-1.html
https://stackoverflow.com/questions/47085514/simple-way-to-visualise-odds-ratios-in-r

```{r}
## OTHERS
# library(forestplot)
# library(ggforestplot)
# library(gridExtra)
# library(forestmodel)

## https://www.linkedin.com/pulse/multiforest-r-package-plotting-uni-multivariate-hern%C3%A1ndez-nielsen
# library(forestmodel)
# library(multiforest)
# library(tidyverse)
# library(rlang)
# library(labelled)
# library(survival)
# library(pec)
```

```{r}
# names(allm)
# frq(allm$model)

m5_forest_df <- allm %>% 
  filter(model == "Model 5") %>% 
  select(term,variable_group,or_display2,or_display3,logit_display,or, or_lci,or_uci,r_or,r_or_lci,r_or_uci,r_logit,r_logit_lci,r_logit_uci,converted_display2,n_obs,m_obs)

# sub
m5_forest_df2 <- m5_forest_df %>% 
    select(term,or_display3,or, or_lci,or_uci)

header_rows <- data.frame(term = c("NETWORK EFFECTS", "TIME DEPENDENCIES", "DYADIC EFFECTS", "NODAL EFFECTS: MATERIAL FACTORS", "NODAL EFFECTS: STABILITY FACTORS", 
                                   "","","","","","","","","","",""#, 
                                   # "Precision Recall (PR AUC):", 
                                   # "  - TERGM 5 = 0.58", 
                                   # "  - Random Model = 0.04", 
                                   # "Receiver Operating Characteristic (ROC AUC):",
                                   # "  - TERGM 5 = 0.87", 
                                   # "  - Random Model = 0.49"
                                   ),
                       or_display3 = NA,
                       or = NA,
                       or_lci = NA,
                       or_uci = NA)
m5_forest_df2 <- rbind(m5_forest_df2, header_rows)

new_order <- c(31,41,26, 1:5, 32,33, 27, 6:7, 34,35, 28, 8:14, 36,37, 29, 15:19, 38,39, 30, 20:25,40)#:42
m5_forest_df3 <- m5_forest_df2[new_order, ]
rownames(m5_forest_df3) <- seq_len(nrow(m5_forest_df3))

```


```{r}
# marking rows 2, 9, 13, 22, 29 as summary for special formatting
is_summary <- rep(FALSE, nrow(m5_forest_df3))
is_summary[c(3,11,16,26,34)] <- TRUE # header rows

# Define the rows to skip (i.e., rows that should be treated as summary/blank)
# skip <- c(2, 9, 13, 22, 29, 37:42)
# if (is.null(m5_forest_df3$is_summary)) {
#   m5_forest_df3$is_summary <- rep(FALSE, nrow(m5_forest_df3))
# }
# m5_forest_df3$is_summary[skip] <- TRUE


m5_forest_df3 %>%
  forestplot(
    labeltext = c(term, or_display3),
    mean      = or, 
    lower     = or_lci, 
    upper     = or_uci,
    clip      = c(0.01, 2.8),
    xticks    = c(0.01, 0.03, 0.10, 0.30, 1.00, 2.80),
    vertices  = TRUE,
    align     = "l",
    zero      = 1,
    is.summary = is_summary,  # marks header rows
    xlog      = TRUE,
    boxsize   = 0.18,
    line.margin = 0.15,  # avoid crowding
    lty.ci    = 1,
    xlab = "\nOdds of arms transfer occurrence\n(1 = no effect, <1 = lower odds, >1 = higher odds)",
    txt_gp    = fpTxtGp(
                  xlab = gpar(cex = 0.6, fontfamily = "Arial", fontface = "bold"),
                  label   = gpar(cex = 0.6, fontfamily = "Arial"),
                  ticks   = gpar(cex = 0.5, fontfamily = "Arial"),
                  summary = gpar(cex = 0.6, fontfamily = "Arial", fontface = "bold")#,
                  # header  = gpar(cex = 1.0, fontface = "bold", underline = TRUE, fontfamily = "Arial")
    )#,
    # Here we add the thick horizontal lines at the desired row breakpoints.
    # hrzl_lines = list(
    #               "3"  = gpar(lwd = 1, col = "darkgray"),
    #               "11"  = gpar(lwd = 1, col = "darkgray"),
    #               "16" = gpar(lwd = 1, col = "darkgray"),
    #               "26" = gpar(lwd = 1, col = "darkgray"),
    #               "34" = gpar(lwd = 1, col = "darkgray")
    #             )
  ) %>%
  fp_add_header(
    term       = "",
    or_display3 = "OR inc. 95% CI, (-1/OR)"
  ) %>%
  fp_set_style(
    box  = gpar(fill = "red", col = "red", lwd = 1.7, shape = 21),
    line = "#696969"
  ) %>%
  fp_set_zebra_style("#EFEFEF")

```


```{r}
m5_forest_df3 %>%
  # mutate(or = sprintf("%.2f", mean), .after = labeltext) %>% 
  forestplot(labeltext = c(term, or_display2),
             mean = or, lower = or_lci, upper = or_uci,
             clip = c(0.01, 2.7),
             xticks = c(0.01, 0.03, 0.10, 0.30, 1.00, 2.50),
             vertices = TRUE,
             align = "l", # "lrrr"
             # hrz_lines = "black", # ?
             zero = 1,
             # lineheight = "auto",
             # title = "Model 5, Odds Ratios inc. CI",
             xlog = TRUE,
             boxsize = 0.18,
             line.margin = .1, # avoid crowding
             lty.ci = 1, # line type solid, 2 = dashed
             # xlab = "Odds of arms transfer",
             
             txt_gp = fpTxtGp(label = gpar(cex = 0.7, fontfamily = "Arial"),
                              ticks = gpar(cex = 0.6, fontfamily = "Arial"))) %>% # title = gpar(cex = 1, fontfamily = "Arial"),xlab = gpar(cex = 1, fontfamily = "Arial")
  # fp_add_lines(h_2 = gpar(lty = 1)) %>% 
               # h_4 = gpar(lwd = 1, columns = 1:2, col = "red")) %>% 
  fp_add_header(term = "Terms", # term = c("", "Study"), = double rows
                # est = expression(beta), # non-ASCII characters
                or_display2 = "OR [95% CI]") %>% # deaths_steroid = "xyz" %>% fp_align_center(),
  fp_set_style(box = gpar(fill = "red", col = "red", lwd = 1, shape = 21), #   to alternate colour of boxes = fp_set_style(box = c("blue", "darkred") %>%  lapply(function(x) gpar(fill = x, col = "#555555")), default = gpar(vertices = TRUE))
               # summary = "pink",
               line = "darkgrey") %>%
  # fp_decorate_graph(grid = structure(c(0.01, 0.05, 2.00),
  #                                    gp = gpar(lty = 2, col = "#CCCCFF"))) %>% 
  fp_set_zebra_style("#EFEFEF")
  
  
```











# VII) Thurner 

## Time series coefs


## Stats time series: thurner time series
```{r}
## matrix to store model statistics
results <- matrix(0,92,5)
colnames(results) <- c("t1-t2","t2-t3","t3-t4","t4-t5","t5-t6")
rownames(results)<- c(
  # network stats
  'edges', 'CI', 'CI',
  'gw esp', 'CI', 'CI', # gw indegree
  'gw exporter', 'CI', 'CI', # gw outdegree
  'gw importer','CI','CI',
  # edge cov
  'conflict dyad','CI', 'CI',  # defense agreement
  'alliance dyad', 'CI', 'CI', # gdp exporter
  'homophily military burden low', 'CI', 'CI', # ranked in bottom 25% = 1
  'homophily military burden middle', 'CI', 'CI', # ranked in middle 25-75% = 2
  'homophily military burden high', 'CI', 'CI', # ranked in highest >75% = 3
  'homophily gdp low', 'CI', 'CI', # ranked in bottom 25% = 1
  'homophily gdp middle', 'CI', 'CI', # ranked in middle 25-75% = 2
  'homophily gdp high', 'CI', 'CI', # ranked in highest >75% = 3
  'polity distance','CI', 'CI', # political score absolute distance
  # node cov
  'log military burden exporter','CI', 'CI',
  'log military burden importer','CI', 'CI',
  'log gdp exporter','CI', 'CI',
  'log gdp importer','CI', 'CI',
  'log population exporter','CI', 'CI',
  'log population importer','CI', 'CI',
  'sovereignty score','CI', 'CI', # cinc importer
  'territorial control','CI', 'CI', # cinc exporter
  'coup','CI', 'CI',
  'population exporter','CI', 'CI',
  'population exporter','CI', 'CI',
  # se i.e. significance
  'pedges',
  'pgwi',
  'pgwo',
  'pmutual',
  'triangle',
  'DA',
  'Go',
  'Gi',
  'DC',
  'Pol',
  'patd',
  'conf',
  'MiCi',
  'MiCo'
)
```



## GOF, p. 1760
-   gof function
-   rocpr

### import objects
```{r}
load("6_objects/gofm.RData") # by model
load("6_objects/gof_stats.RData") # by statistic
```

```{r}
load("6_objects/gof_geodesic.RData")
load("6_objects/gof_outdegree.RData")
load("6_objects/gof_indegree.RData")
load("6_objects/gof_esp.RData")
load("6_objects/gof_dsp.RData")
load("6_objects/gof_triad.RData")
load("6_objects/gof_istar.RData")
load("6_objects/gof_ostar.RData")
load("6_objects/gof_fastgreedy.RData")
load("6_objects/gof_walktrap.RData")
load("6_objects/gof_rocpr.RData")
```

```{r}
load("6_objects/gof_m0.RData")
load("6_objects/gof_m1.RData")
load("6_objects/gof_m2.RData")
load("6_objects/gof_m3.RData")
load("6_objects/gof_m4.RData")
load("6_objects/gof_m5.RData")
load("6_objects/gof_m5a.RData")
load("6_objects/gof_m5b.RData")
load("6_objects/gof_m5c.RData")
load("6_objects/gof_m5d.RData")
load("6_objects/gof_m5e.RData")
load("6_objects/gof_m5f.RData")
load("6_objects/gof_m5g.RData")
```




### plots

#### m0 - m5
```{r}
pdf("charts/gof_m0.pdf",width = 6,height = 3.7) 
plot(gof_m0,mfrow=F)
dev.off()
```

```{r}
pdf("charts/gof_m1.pdf",width = 6,height = 3.7) 
plot(gof_m1,mfrow=F)
dev.off()
```

```{r}
pdf("charts/gof_m2.pdf",width = 6,height = 3.7) 
plot(gof_m2,mfrow=F)
dev.off()
```

```{r}
pdf("charts/gof_m3.pdf",width = 6,height = 3.7) 
plot(gof_m3,mfrow=F)
dev.off()
```

```{r}
pdf("charts/gof_m4.pdf",width = 6,height = 3.7) 
plot(gof_m4,mfrow=F)
dev.off()
```

```{r}
pdf("charts/gof_m5.pdf",width = 6,height = 3.7) 
plot(gof_m5,mfrow=F)
dev.off()
```



#### m0
```{r}
plot(gof_m0$`Geodesic distances`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$Indegree,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$Outdegree,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m0$`Edge-wise shared partners`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$`Dyad-wise shared partners`,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m0$`Triad census`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$`Incoming k-star`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$`Outgoing k-star`,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m0$`Modularity (fast & greedy)`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$`Modularity (walktrap)`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m0$`Tie prediction`,main=NULL)
```

```{r}
plot(gof_m0$`Geodesic distances`)
plot(gof_m0$Indegree)
plot(gof_m0$Outdegree)

plot(gof_m0$`Edge-wise shared partners`)
plot(gof_m0$`Dyad-wise shared partners`)

plot(gof_m0$`Triad census`)
plot(gof_m0$`Incoming k-star`)
plot(gof_m0$`Outgoing k-star`)

plot(gof_m0$`Modularity (fast & greedy)`)
plot(gof_m0$`Modularity (walktrap)`)
plot(gof_m0$`Tie prediction`)
```


#### m5
```{r}
plot(gof_m5$`Geodesic distances`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$Indegree,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$Outdegree,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m5$`Edge-wise shared partners`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$`Dyad-wise shared partners`,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m5$`Triad census`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$`Incoming k-star`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$`Outgoing k-star`,xlab=NULL, ylab=NULL,main=NULL)

plot(gof_m5$`Modularity (fast & greedy)`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$`Modularity (walktrap)`,xlab=NULL, ylab=NULL,main=NULL)
plot(gof_m5$`Tie prediction`,main=NULL)
```

```{r}
plot(gof_m5$`Geodesic distances`)
plot(gof_m5$Indegree)
plot(gof_m5$Outdegree)

plot(gof_m5$`Edge-wise shared partners`)
plot(gof_m5$`Dyad-wise shared partners`)

plot(gof_m5$`Triad census`)
plot(gof_m5$`Incoming k-star`)
plot(gof_m5$`Outgoing k-star`)

plot(gof_m5$`Modularity (fast & greedy)`)#!
plot(gof_m5$`Modularity (walktrap)`)#!
plot(gof_m5$`Tie prediction`) #!
```





#### by stat, multipanel

##### Geodesic
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Geodesic distances`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Geodesic distances`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Geodesic distances`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Geodesic distances`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Geodesic distances`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Geodesic distances`,xlab="M6",ylab=NULL,main=NULL)
```

##### ESP
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Edge-wise shared partners`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Edge-wise shared partners`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Edge-wise shared partners`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Edge-wise shared partners`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Edge-wise shared partners`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Edge-wise shared partners`,xlab="M6",ylab=NULL,main=NULL)
```

##### DSP
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Dyad-wise shared partners`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Dyad-wise shared partners`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Dyad-wise shared partners`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Dyad-wise shared partners`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Dyad-wise shared partners`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Dyad-wise shared partners`,xlab="M6",ylab=NULL,main=NULL)
```



##### Indegree
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$Indegree,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$Indegree,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$Indegree,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$Indegree,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$Indegree,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$Indegree,xlab="M6",ylab=NULL,main=NULL)
```

##### Outdegree
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$Outdegree,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$Outdegree,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$Outdegree,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$Outdegree,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$Outdegree,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$Outdegree,xlab="M6",ylab=NULL,main=NULL)
```

##### Triads
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Triad census`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Triad census`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Triad census`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Triad census`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Triad census`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Triad census`,xlab="M6",ylab=NULL,main=NULL)
```

##### Incoming k-star
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Incoming k-star`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Incoming k-star`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Incoming k-star`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Incoming k-star`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Incoming k-star`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Incoming k-star`,xlab="M6",ylab=NULL,main=NULL)
```

##### Outgoing k-star
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Outgoing k-star`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Outgoing k-star`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Outgoing k-star`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Outgoing k-star`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Outgoing k-star`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Outgoing k-star`,xlab="M6",ylab=NULL,main=NULL)
```

##### Fast & Greedy
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Modularity (fast & greedy)`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Modularity (fast & greedy)`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Modularity (fast & greedy)`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Modularity (fast & greedy)`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Modularity (fast & greedy)`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Modularity (fast & greedy)`,xlab="M6",ylab=NULL,main=NULL)
```

##### Walktrap
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m0$`Modularity (walktrap)`,xlab="M1",ylab=NULL,main=NULL)
plot(gof_m1$`Modularity (walktrap)`,xlab="M2",ylab=NULL,main=NULL)
plot(gof_m2$`Modularity (walktrap)`,xlab="M3",ylab=NULL,main=NULL)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Modularity (walktrap)`,xlab="M4",ylab=NULL,main=NULL)
plot(gof_m4$`Modularity (walktrap)`,xlab="M5",ylab=NULL,main=NULL)
plot(gof_m5$`Modularity (walktrap)`,xlab="M6",ylab=NULL,main=NULL)
```

##### PRROC
```{r}
par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)

plot(gof_m0$`Tie prediction`)
plot(gof_m1$`Tie prediction`)
plot(gof_m2$`Tie prediction`)

par(mfrow = c(1,3)     # 2 rows x 3 cols
    ,oma = c(2,2,1,2) # outer margin - u,l,o,r
    ,mar = c(2,2,1,2)    # inner margin - u,l,o,r
)
plot(gof_m3$`Tie prediction`)
plot(gof_m4$`Tie prediction`)
plot(gof_m5$`Tie prediction`)
```



# VIII) DESCRIPTION OF INDIVIDUAL DATA SETS


## a) country-level

XXX



## b) period-level

```{r}
names(cov_agg)
```

### military expenditure
```{r}
# hist(cov_agg$log2_milex, 150)
# range(cov_agg$log2_milex)

# library(scales)
# library(ggplot2)

ggplot(cov_agg, aes(x = log2_milex)) +
  # Histogram where the y-axis shows the proportion
  geom_histogram(aes(y = after_stat(count / sum(count))),
                 binwidth = 1,  # binwidth
                 fill = "salmon",
                 color = "black",
                 alpha = 0.6) +
  # Density line scaled to match the histogram proportions
  geom_density(aes(y = after_stat(..density.. * 1)),  # multiply density by binwidth
               color = "blue",
               size = 0.6) +
  labs(title = "",
       # Here, the expression() call inserts a subscripted 2 after log.
       # The * operator juxtaposes parts of the expression.
       x = expression("\nMilitary expenditure (in USD millions, " * log[2] * "-scaled)"),
       y = "Percent of Countries\n") +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.2))  # Extends the y-axis by an extra 20% at the top
  ) +
  scale_x_continuous(breaks = seq(-15, 20, by = 5)) +
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80"),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80"),
    axis.title.x = element_text(margin = margin(t = 10))
  )

```


### GDP
```{r}
# hist(cov_agg$log2_gdp, 150)
# range(cov_agg$log2_gdp)

# library(scales)
# library(ggplot2)

ggplot(cov_agg, aes(x = log2_gdp)) +
  # Histogram where the y-axis shows the proportion
  geom_histogram(aes(y = after_stat(count / sum(count))),
                 binwidth = 0.5,  # binwidth
                 fill = "salmon",
                 color = "black",
                 alpha = 0.6) +
  # Density line scaled to match the histogram proportions
  geom_density(aes(y = after_stat(..density.. * 0.5)),  # multiply density by binwidth
               color = "blue",
               size = 0.6) +
  labs(title = "",
       # Here, the expression() call inserts a subscripted 2 after log.
       # The * operator juxtaposes parts of the expression.
       x = expression("\nNominal GDP (in USD billions, " * log[2] * "-scaled)"),
       y = "Percent of Countries\n") +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.2))  # Extends the y-axis by an extra 20% at the top
  ) +
  scale_x_continuous(breaks = seq(-5, 15, by = 2.5)) +
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80"),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80"),
    axis.title.x = element_text(margin = margin(t = 10))
  )

```


### Population
```{r}
# hist(cov_agg$log2_population, 150)
# range(cov_agg$log2_population)

# library(scales)
# library(ggplot2)

ggplot(cov_agg, aes(x = log2_population)) +
  # Histogram where the y-axis shows the proportion
  geom_histogram(aes(y = after_stat(count / sum(count))),
                 binwidth = 0.5,  # binwidth
                 fill = "salmon",
                 color = "black",
                 alpha = 0.6) +
  # Density line scaled to match the histogram proportions
  geom_density(aes(y = after_stat(..density.. * 0.5)),  # multiply density by binwidth
               color = "blue",
               size = 0.6) +
  labs(title = "",
       # Here, the expression() call inserts a subscripted 2 after log.
       # The * operator juxtaposes parts of the expression.
       x = expression("\nPopulation (in millions of individuals, " * log[2] * "-scaled)"),
       y = "Percent of Countries\n") +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.23))  # Extends the y-axis by an extra 20% at the top
  ) +
  scale_x_continuous(breaks = seq(-5, 15, by = 2.5)) +
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80"),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80"),
    axis.title.x = element_text(margin = margin(t = 10))
  )

```


### vdem regime score
```{r}
# hist(cov_agg$democracy, 200)
# range(cov_agg$democracy)

# library(scales)
# library(ggplot2)

ggplot(cov_agg, aes(x = democracy)) +
  # Histogram where the y-axis shows the proportion
  geom_histogram(aes(y = after_stat(count / sum(count))),
                 binwidth = 0.01,  # binwidth
                 fill = "salmon",
                 color = "black",
                 alpha = 0.6) +
  # Density line scaled to match the histogram proportions
  geom_density(aes(y = after_stat(..density.. * 0.01)),  # multiply density by binwidth
               color = "blue",
               size = 0.6) +
  labs(title = "",
       x = "\nRegime Score (V-Dem electoral democracy index)",      
       y = "Percent of Countries\n") +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.15))  # Extends the y-axis by an extra 15% at the top
  ) +
  scale_x_continuous(breaks = seq(0, 1.2, by = 0.1)) +  # ticks every 0.1 unit
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80"),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80"),
    axis.title.x = element_text(margin = margin(t = 10))
  )

```


### vdem sovereignty
```{r}
# hist(cov_agg$sov_dom, 200)
# range(cov_agg$sov_dom) # -1.57 to 2.3
# hist(cov_agg$sov_for, 200)
# range(cov_agg$sov_for) # -1.66 to 2.4

# hist(cov_agg$sov_score, 200)
# range(cov_agg$sov_score) # -1.6 to 2.35

# library(ggplot2)
ggplot(cov_agg, aes(x = sov_score)) +
  # Histogram where the y-axis shows the proportion
  geom_histogram(aes(y = after_stat(count/sum(count))),
                 binwidth = 0.1, # binwidth
                 fill = "salmon",
                 color = "black",
                 alpha = 0.6) +
  # Density line scaled to match the histogram proportions
  geom_density(aes(y = after_stat(..density.. * 0.1)), # *binwidth
               color = "blue",
               size = 0.6) +
  labs(title = "",
       x = "\nSovereignty Score (V-Dem political autonomy index)",   # Inserts a line break at the start to push the label down slightly
       y = "Percent of Countries\n") +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.15))  # Extends the y-axis by an extra 15% at the top
  ) +
  scale_x_continuous(breaks = seq(-2, 2.5, by = 0.5)) +  # ticks every 0.5 unit
  theme(
    plot.margin = unit(c(0.7, 0.9, 0.7, 0.7), "cm"),
    plot.background = element_rect(fill = "seashell", color = NA),
    panel.grid.major.x = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.x = element_line(size = 0.4, color = "grey80"),
    panel.grid.major.y = element_line(size = 0.6, color = "grey80"),
    panel.grid.minor.y = element_line(size = 0.4, color = "grey80"),
    # Increase the space below the x-axis title, if needed
    axis.title.x = element_text(margin = margin(t = 10))
  )

```


### vdem coups

```{r}
names(cov_agg)
# library(sjmisc)
frq(cov_agg$d_coups)
```




# IX) MISCELLANEOUS & TEMPLATES

-   plots by attributes of states (i.e. clusters around milex, homophily etc)
-   clustering


## Plots

### RHH forest plot (L11)

```{r}
# par( mfrow = c( 2,1 ), mar = c( 0,0,1,0 ) )
# palette( gray.colors( 3,0,1 ) ) #palette assigns the default colors using in subsequent graphics
# plot( lhds, vertex.col = 'state', main = "")
# plot( lhds, vertex.col = 'hivscreen', main = "HIV Screening Programs")
```

```{r}
# numties <- degree( lhds, gmode='graph' ) 
# lhds %v% "numties" <- numties # assign number of degrees as attribute
# 
# palette( gray.colors( 2,0,1 ) )
# plot( lhds, vertex.col = 'hivscreen',vertex.cex = numties/6 )
```

### igraph plot

```{r}
plot.igraph(iat_inet$t1, 
            # edge.label = round(E(sipri.g)$weight, 3),
            vertex.size = 5, # degree(g, mode="out")/100,
            vertex.color = "steelblue",
            edge.width = 0.2, # E(g)$tiv/100,
            edge.arrow.size = 0.4,
            edge.arrow.width = 0.4,
            edge.color = "gray",
            vertex.label.cex = 0.3,
            vertex.label.color = "black",
            margin = 0.1,
            layout = layout_with_fr(iat_inet$t1), # fruchteman-reingold layout algorithm; alt: layout_nicely(g); layout_with_kk(g)
            main = "t1 (1993-1996)") 
```



### my461 plot

```{r}
# cf. my461 ps5
# turn adj mtrx to network class object
# net <- graph_from_adjacency_matrix(iat, mode = "directed")
net <- iat_inet$t1

# generate stats for plot
coord <- layout_nicely(net)
outdegree <- igraph::degree(net, mode="out")

# plot network
plot.igraph(net,
     layout = coord*20,
     # displayisolates = F,
     vertex.label = V(net)$iso, # vertex.label=NA
     vertex.label.cex=0.4,
     edge.arrow.size=0.2,
     vertex.size=log(outdegree)/3, # sized by outdegree
     edge.width=E(net)$weight/8,  # edge.width=E(net)$weight = sized by transfer value
     vertex.color=V(net)$gdp_cat, # vertex.color = "gray"
     edge.color = "grey",
     main="MCW network at t1 (nodes sized by outdegree)"
     )
legend("topright",                   # legend showing gdp label associated with each colour 
       legend=c("gdp bottom 25%","gdp mid 25%-75%", "gdp highest 75%"),   # value 1, 2, 3
       pch=10,
       col=wes_palettes$GrandBudapest2[c(1:3)]) # col=categorical_pal(8)[c(1:3)])

```

```{r}
# generate stats for plot
net <- iat_inet$t1
coord <- layout_nicely(net) # alt: layout_nicely(g); layout_with_kk(g);layout_with_fr(g)
outdegree <- igraph::degree(net, mode="out")
# cex_nodes<-0.8+log(1+sqrt(outdegree))
cex_nodes<-0.8+log(1+sqrt(rowSums(adj)))*2 # outdegree
# 0.8+log(1+sqrt(colSums(adj))) # indegree
# cex_nodes<-1.5+rowSums(adj) # outdegree
# 
# plot.igraph(net, 
#             # edge.label = round(E(sipri.g)$weight, 3),
#             vertex.size = cex_nodes, # degree(g, mode="out")/100, 3
#             vertex.color = V(net)$gdp_cat, # "steelblue"
#             vertex.label = V(net)$iso,
#             vertex.label.cex = 0.5,
#             vertex.label.color = "black",
#             
#             frame.width = 0.5,
#             # edge.width = E(net)$weight/100, # 0.5
#             edge.arrow.size = 0.25,
#             edge.arrow.width = 0.5,
#             edge.arrow.mode = 0,
#             edge.color = "gray",
# 
#             margin = 0.1,
#             layout = coord*15,
#             main = "t1 (1993-1996)")
# legend("topright",
#        legend=c("gdp bottom 25%","gdp mid 25%-75%", "gdp highest 75%"),
#             col= wes_palettes$GrandBudapest2[c(1:3)],
#             pch=21)

# lty = # 0 "blank", 1 "solid", 2 (“dashed”), 3 (“dotted”), 4 (“dotdash”), 5 (“longdash”), 6 (“twodash”)
            
```

### main plot

```{r}
plot.igraph(iat_inet$t1, 
            # edge.label = round(E(sipri.g)$weight, 3),
            vertex.size = 5, # degree(g, mode="out")/100,
            vertex.color = "steelblue",
            edge.width = 0.2, # E(g)$tiv/100,
            edge.arrow.size = 0.4,
            edge.arrow.width = 0.4,
            edge.color = "gray",
            vertex.label.cex = 0.3,
            vertex.label.color = "black",
            margin = 0.1,
            layout = layout_with_fr(iat_inet$t1), # fruchteman-reingold layout algorithm; alt: layout_nicely(g); layout_with_kk(g)
            main = "MCW transfers 1993-2023") 
```

### change attributes

```{r}
# V(g)$size <- 15
# V(g)$frame.color <- "white" 
# V(g)$color <- "orange"
# V(g)$label.cex <- 0.75 # smaller label size
# E(g)$arrow.mode <- 0
# 
# plot(g, layout = coord) # make sure to have the same coordinates. 
```

### several plots in one frame

```{r}
# par(mfrow=c(2,2), mar=c(1,0,1,0)) # 2x2 frames for plots
# plot(G, layout=layout_randomly)
# title('Random')
# plot(G, layout=layout_in_circle)
# title('Circle')
# plot(G, layout=layout_with_kk)
# title('Kamada-Kawai')
# plot(G, layout=layout_with_fr)
# title('Fruchtermann')
```

### different spreads

```{r}
l <- layout_with_fr(G)
l <- norm_coords(l, ymin=-1, ymax=1, xmin=-1, xmax=1) # defines drawing 

par(mfrow=c(2,2), mar=c(1,0,1,0)) 
plot(G, rescale=F, layout=l*0.4, vertex.label=NA) 
title('Layout is tight')
plot(G, rescale=F, layout=l*0.6,  vertex.label=NA)
plot(G, rescale=F, layout=l*0.8,  vertex.label=NA)
plot(G, rescale=F, layout=l*1.0,  vertex.label=NA)
title('Layout spreads out')
```

### stressing different aspects/weights

e.g. weak vs strong ties

```{r}
# everything > average is considered "high", else "low"
g_low <- g - E(g)[E(g)$weight >= 3] 
g_high <-  g - E(g)[E(g)$weight < 3] 

l <- layout_with_fr(g) # please note: overall network as layout

par(mfrow=c(1,2))
plot.igraph(g_low, 
            layout= l, 
     vertex.size=degree(g),
     edge.width=E(g_low)$weight)
title('Weak Ties')
plot.igraph(g_high, layout= l, 
     vertex.size=degree(g),
     edge.width=E(g_high)$weight)
title('Strong Ties')
```

### cgpt

for such a large graph, consider creating interactive visualizations or using techniques like community detection to highlight different structural aspects of the graph

```{r}
# cgpt
plot.igraph(g,
  layout = layout_with_kk(g),
  vertex.size = 5,
  vertex.color = "steelblue",
  edge.color = "gray",
  edge.width = 0.2,
  edge.arrow.size = 0.5,
  edge.arrow.width = 0.5,
  margin = 0.1,
  main = "MCW transfers 1950-2023"
)
```

## MY461 bipartite gr

```{r bipartite visualization 2 extended}
V(sw.nw)$label.color <- "black" ## ifelse(V(g)$type, "black", "white") # labels for our v
V(sw.nw)$label.font <-  2 # assign label.font to igraph’s argument for bold font = 2; 1 is plain text, 2 is bold face, 3 is italic, 4 is bold and italic and 5 specifies the symbol font. For more options: https://igraph.org/r/doc/plot.common.html
V(sw.nw)$label.cex <- 0.5 ## ifelse(V(g)$type, 0.8, 1.2) # assign the label.cex value to adjust our label size. Consider that the numbers don’t take up as much room as the names, so we can let them be bigger
V(sw.nw)$label.dist <- 0 # whether and if, how far labels are from vertices presentation 
V(sw.nw)$frame.color <-  "black" ## NA # frame of vertices presentation; assign frame.color to NA would remove the vertex borders
V(sw.nw)$size <- 17 # change size of vertices; default is 15
plot(sw.nw, layout = layout_with_graphopt) # We can then use layout_with_graphopt to minimize vertex overlap when we plot().

# bipartite specific layout
plot(sw.nw, layout=layout.bipartite, hgap = 1, vgap = 1, maxiter = 100, vertex.size=20, vertex.label.cex=0.5)
# ?layout.bipartite
```

## ndtv

```{r}
library(ndtv)
```

-   Commu detection -\> evolution over time: core-periphery? decentral? ordered? (L7, p.18)



## colors

```{r}
colors <- c("gray50", "tomato", "gold")
V(iat_inet$t1)$color <- colrs[V(iat_inet$t1)$gdp_cat]
iat_inet$t1
```

```{r}
library(RColorBrewer)
display.brewer.all()
cols <- brewer.pal(3, "Set1")
pal <- colorRampPalette(cols)

```

```{r}
library(wesanderson)
col= wes.palette(n=3, name="GrandBudapest2")
```

```{r}
??wes.palette
wes_palettes
col=wes_palettes$GrandBudapest2[c(1:3)]
```



# Problems

-   function sysfonts::font_add_google(name = mf, family = mf) does not work = bcs no internet



# OUTPUTS

ETC
```{r}
# load("iat_inet_nocov.bin.RData")
# load("iat_snet_nocov.bin.RData")

load("iat_inet_year.RData")
load("iat_snet_year.RData")


load("un_members.RData")
load("un_mlist.RData")


load("7_objects/iat_adj_weight22.RData")
load("7_objects/iat_adj_binary22.RData")


load("7_objects/iat_list2.RData")
```


DATA

```{r}
# load("vis_deg_df.RData")
# load("vis_ideg_df.RData")
# load("vis_odeg_df.RData")
# load("cent_df.RData")
# load("vis_df_cent.RData")
# load("cov_complete.RData")

# load("degree_dis1.RData")
# load("degree_dis2.RData")
# load("degree_dis2a.RData")
# load("degree_dis2b.RData")
# load("degree_dis3.RData")
# load("degree_dis4.RData")
# load("degree_dis_all.RData")
# load("degree_dis_facet.RData")

# load("indegree_dis_facet.RData")
# load("p_ideg_hist.RData")
# load("indegree_dis1.RData")

# load("p_odeg_hist_t.RData")
# load("p_odeg_hist.RData")
# load("outdegree_dis1.RData")

# load("ideg_top10.RData")
```

VISUALIZATIONS

```{r}
# load("seller_top10_bar.RData")
# load("buyer_top10_bar.RData")
```
